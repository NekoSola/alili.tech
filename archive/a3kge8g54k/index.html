<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="消息系统设计与实现「上篇」"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>消息系统设计与实现「上篇」 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/a3kge8g54k/",
				"appid": "1613049289050283", 
				"title": "消息系统设计与实现「上篇」 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-13T02:31:22"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/6t07gna8s4p/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/mczzajylm8g/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fa3kge8g54k%2f&text=%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0%e3%80%8c%e4%b8%8a%e7%af%87%e3%80%8d"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fa3kge8g54k%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fa3kge8g54k%2f&text=%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0%e3%80%8c%e4%b8%8a%e7%af%87%e3%80%8d"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fa3kge8g54k%2f&title=%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0%e3%80%8c%e4%b8%8a%e7%af%87%e3%80%8d"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fa3kge8g54k%2f&is_video=false&description=%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0%e3%80%8c%e4%b8%8a%e7%af%87%e3%80%8d"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0%e3%80%8c%e4%b8%8a%e7%af%87%e3%80%8d&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fa3kge8g54k%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fa3kge8g54k%2f&title=%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0%e3%80%8c%e4%b8%8a%e7%af%87%e3%80%8d"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fa3kge8g54k%2f&title=%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0%e3%80%8c%e4%b8%8a%e7%af%87%e3%80%8d"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fa3kge8g54k%2f&title=%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0%e3%80%8c%e4%b8%8a%e7%af%87%e3%80%8d"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fa3kge8g54k%2f&title=%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0%e3%80%8c%e4%b8%8a%e7%af%87%e3%80%8d"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">消息系统设计与实现「上篇」</h1><div class="meta"><div class="postdate"><time datetime="2019-02-13" itemprop="datePublished">2019-02-13</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cblockquote\x3e\n\x3cp\x3e原文链接：\x3ca href=\x22http:\/\/huang-jerryc.com\/2015\/10\/14\/%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8C%E4%B8%8A%E7%AF%87%E3%80%8D\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eBluesun | 消息系统设计与实现「上篇」\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e由于文章篇幅较长，而作者精力有限，不希望这么早就精尽人亡，故分成上下篇来写消息系统的设计与实现。上篇主要讲的是一些概念，搞清楚我们要做的这个消息系统的主要内容。而下篇主要讲具体的实现，会包括架构设计，数据库设计，业务流程详细的实现等。\x3c\/p\x3e\n\x3cp\x3e整个系统的设计与实现，并非我一人之力就可以完成的。这其中是同事们大家一起讨论与商讨的结果，而我只是把它细化，呈现出来。\x3c\/p\x3e\n\x3cp\x3e我只是一个会思考的idea搬运工。\x3c\/p\x3e\n\x3c\/blockquote\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3e产品分析\x3c\/h2\x3e\n\x3cp\x3e首先我们来看一下市场上关于消息的实现是怎么样的。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e简书\x3c\/h3\x3e\n\x3cp\x3e简书的消息系统主要分了两种\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e简信\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e提醒\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cstrong\x3e简信\x3c\/strong\x3e\x3cbr\x3e简信的性质其实跟私信是一样的，是用户发送给用户的一则消息，有具体的信息内容。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22http:\/\/xia-dev.b0.upaiyun.com\/c3aad7dc-5914-4c5c-9f88-34e40077d0ff.jpg\x22 src=\x22https:\/\/static.alili.techhttp:\/\/xia-dev.b0.upaiyun.com\/c3aad7dc-5914-4c5c-9f88-34e40077d0ff.jpg\x22 alt=\x22简书简信\x22 title=\x22简书简信\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e提醒\x3c\/strong\x3e\x3cbr\x3e而提醒，则是系统发送的一则消息，其文案格式是固定的，并且对特殊对象一般拥有超链接。\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22http:\/\/xia-dev.b0.upaiyun.com\/b0ee917e-0776-4aa9-bf4a-0a2cd33ca853.jpg\x22 src=\x22https:\/\/static.alili.techhttp:\/\/xia-dev.b0.upaiyun.com\/b0ee917e-0776-4aa9-bf4a-0a2cd33ca853.jpg\x22 alt=\x22简书提醒\x22 title=\x22简书提醒\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e知乎\x3c\/h3\x3e\n\x3cp\x3e知乎跟简书一样，主要分了两种：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e私信\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e消息\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cstrong\x3e私信\x3c\/strong\x3e\x3cbr\x3e跟简书一样，使用户发送给用户的一则消息，也可以是管理员发送给用户的消息。\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22http:\/\/xia-dev.b0.upaiyun.com\/a6b102ed-d337-41d2-a5d3-b3923650de16.jpg\x22 src=\x22https:\/\/static.alili.techhttp:\/\/xia-dev.b0.upaiyun.com\/a6b102ed-d337-41d2-a5d3-b3923650de16.jpg\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e消息\x3c\/strong\x3e\x3cbr\x3e知乎的消息比简书的提醒有过之而无不及，知乎会对多条相似的消息进行聚会，以达到减轻用户阅读压力的体验。\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22http:\/\/xia-dev.b0.upaiyun.com\/5f90952e-2fe6-447f-affb-8a7c9a04d0ab.jpg\x22 src=\x22https:\/\/static.alili.techhttp:\/\/xia-dev.b0.upaiyun.com\/5f90952e-2fe6-447f-affb-8a7c9a04d0ab.jpg\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e消息的三种分类\x3c\/h2\x3e\n\x3cp\x3e通过两种产品的简单分析，得出他们的消息有两种分类，在这基础上，我们再加上一种：公告。\x3cbr\x3e公告的主要性质是系统发送一则含有具体内容的消息，站内所有用户都能读取到这条消息。\x3cbr\x3e所以，消息有三种分类：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e公告 Announce\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e提醒 Remind\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e私信 Message\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3e提醒的语言分析\x3c\/h2\x3e\n\x3cp\x3e我们从简书取一组提醒样本：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e3dbe1bd90774 关注了你\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3emagicdawn 喜欢了你的文章 《单点登录的三种实现方式》\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e无良程序 喜欢了你的文章 《基于RESTful API 怎么设计用户权限控制？》\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3ealexcc4 喜欢了你的文章 《在Nodejs中贯彻单元测试》\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e你在《基于RESTful API 怎么设计用户权限控制？》中收到一条 cnlinjie 的评论\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e你的文章《Session原理》已被加入专题 《ios开发》\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e分析句子结构，提醒的内容无非就是\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3e「谁对一样属于谁的事物做了什么操作」\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e「someone do something in someone\x27s something」\x3c\/p\x3e\n\x3cp\x3esomeone = 提醒的触发者，或者发送者，标记为sender\x3cbr\x3edo something = 提醒的动作，评论、喜欢、关注都属于一个动作，标记为action\x3cbr\x3esomething = 提醒的动作作用对象，这就具体到是哪一篇文章，标记为target\x3cbr\x3esomeone\x27s = 提醒的动作作用对象的所有者，标记为targetOwner\x3c\/p\x3e\n\x3cp\x3e这就清楚了，sender和targetOwner就是网站的用户，而target是具体到哪一篇文章，如果提醒的对象不仅仅局限于文章，还有其他的话，就需要增加一项targetType，来标记目标是文章还是其他的什么。而action，则是固定的，整个网站会触发提醒的动作可能就只有那几样：评论、喜欢、关注.....（或者其他业务需要提醒的动作）\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader5\x22\x3e消息的两种获取方式\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e推 Push\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e拉 Pull\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cstrong\x3e以知乎为例\x3c\/strong\x3e\x3cbr\x3e推的比较常见，需要针对某一个问题维护着一张关注者的列表，每当触发这个问题推送的条件时（例如有人回答问题），就把这个通知发送给每个关注者。\x3c\/p\x3e\n\x3cp\x3e拉的相对麻烦一点，就是推的反向，例如每个用户都有一张关注问题的列表，每当用户上线的时候，对每个问题进行轮询，当问题的事件列表出现了比我原本时间戳大的信息就进行拉取。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e而我们则根据消息的不同分类采用不同的获取方式\x3c\/strong\x3e：\x3cbr\x3e通告和提醒，适合使用拉取的方式，消息产生之后，会存在消息表中，用户在某一特定的时间根据自己关注问题的表进行消息的拉取，然后添加到自己的消息队列中，\x3c\/p\x3e\n\x3cp\x3e信息，适合使用推的方式，在发送者建立一条信息之后，同时指定接收者，把消息添加到接收者的消息队列中。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader6\x22\x3e订阅\x3c\/h2\x3e\n\x3cp\x3e根据提醒使用拉取的方式，需要维护一个关注某一事物的列表。\x3cbr\x3e这种行为，我们称之为：\x3cstrong\x3e「订阅」Subscribe \x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e一则订阅有以下三个核心属性\x3c\/strong\x3e：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e订阅的目标 target\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e订阅的目标类型 targetType\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e订阅的动作 action\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e比如我发布了一篇文章，那么我会订阅文章《XXX》的评论动作，所以文章《XXX》每被人评论了，就需要发送一则提醒告知我。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e订阅的规则还可以扩展\x3c\/strong\x3e\x3cbr\x3e我喜欢了一篇文章，和我发布了一篇文章，订阅的动作可能不一样。\x3cbr\x3e喜欢了一篇文章，我希望我订阅这篇文章更新、评论的动作。\x3cbr\x3e而发布了一篇文章，我希望我只是订阅这篇文章的评论动作。\x3c\/p\x3e\n\x3cp\x3e这时候就需要多一个参数：subscribReason\x3cbr\x3e不同的subscribReason，对应着一个动作数组，\x3cbr\x3esubscribReason = 喜欢，对应着 actions = [更新，评论]\x3cbr\x3esubscribReason = 发布，对应着 actions = [评论]\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e订阅的规则还还可以扩展\x3c\/strong\x3e\x3cbr\x3e用户可能会有一个自己的订阅设置，比如对于所有的喜欢的动作，我都不希望接收。\x3cbr\x3e比如Knewone的提醒设置\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22http:\/\/xia-dev.b0.upaiyun.com\/80cc4aaf-0568-478c-8513-b8821e57520f.jpg\x22 src=\x22https:\/\/static.alili.techhttp:\/\/xia-dev.b0.upaiyun.com\/80cc4aaf-0568-478c-8513-b8821e57520f.jpg\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e所以我们需要再维护一个表：\x3cstrong\x3eSubscriptionConfig\x3c\/strong\x3e，来存放用户的提醒设置。\x3cbr\x3e并且，当用户没有提醒设置的时候，可以使用系统提供的一套默认设置：\x3cstrong\x3edefaultSubscriptionConfig\x3c\/strong\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e聚合\x3c\/h2\x3e\n\x3cp\x3e如果我发布了一篇文章《XXX》，在我不在线的时候，被评论了10遍，当我一上线的时候，应该是收到十条信息类似于：「谁谁谁评论了你的文章《XXX》」?\x3cbr\x3e还是应该收到一条信息：「甲、乙、丙、丁...评论了你的文章《XXX》」?\x3c\/p\x3e\n\x3cp\x3e知乎在聚合上做的很优秀，要知道他们要实现这个还是挺有技术的：\x3cbr\x3e\x3ca href=\x22http:\/\/www.zhihu.com\/question\/22394809\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e知乎的消息机制，在技术上如何设计与规划？\x3c\/a\x3e\x3cbr\x3e\x3ca href=\x22http:\/\/www.zhihu.com\/question\/20380990\/answer\/14960006\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e网站的消息（通知）系统一般是如何实现的？\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e关于这部分功能，我们还没有具体的实现方法，暂时也无法讲得更加详细。⊙﹏⊙\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader8\x22\x3e五个实体\x3c\/h2\x3e\n\x3cp\x3e通过上面的分析，大概知道做这个消息系统，需要哪些实体类：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e用户消息队列 UserNotify\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e用户 User\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e订阅 Subscription\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e订阅设置 SubscriptionConfig\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e消息 Notify\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e通告 Announce\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e提醒 Remind\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e信息 Message\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3ch2 id=\x22articleHeader9\x22\x3e行为分解\x3c\/h2\x3e\n\x3cp\x3e说了这么多，整理一下整个消息流程的一些行为：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3cp\x3e系统或者管理员，创建消息\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3ecreateNotify (make announce | remind | message)\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e用户，订阅消息，取消订阅\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3esubscribe, cancelSubscription\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e用户管理订阅设置\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3egetSubscriptionConfig, updateSubscriptionConfig\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e用户，拉取消息\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3epullNotify (pull announce | remind | message | all)\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e用户，查询消息队列\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3egetUserNotify(get announce | remind | message | all)\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e用户阅读消息\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\x3cp\x3eread\x3c\/p\x3e\x3c\/li\x3e\x3c\/ul\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cblockquote\x3e\x3cp\x3e在本文的「下篇」我们来探讨一下：模型怎么做、数据库怎么设计、代码结构怎么来、一些逻辑上的时序图应该是怎么样的。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e---------------------- 更新于 2015\/11\/15 -----------------------\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3e关联文章：\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000004619723\x22\x3e消息系统设计与实现「下篇」\x3c\/a\x3e\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3chr\x3e\n\x3cp\x3e如果本文对您有用\x3cbr\x3e请不要吝啬你们的Follow与Start\x3cbr\x3e这会大大支持我们继续创作\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e「Github」\x3c\/strong\x3e\x3cbr\x3eMZMonster ：\x3ca href=\x22https:\/\/github.com\/MZMonster\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e@MZMonster\x3c\/a\x3e\x3cbr\x3eJC_Huang ：\x3ca href=\x22https:\/\/github.com\/JerryC8080\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e@JerryC8080\x3c\/a\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>消息系统设计与实现「上篇」</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000004619704">https://segmentfault.com/a/1190000004619704</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/a3kge8g54k/" target="_blank">https://alili.tech/archive/a3kge8g54k/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>