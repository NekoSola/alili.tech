<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="可信前端之路-代码保护"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>可信前端之路-代码保护 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/z83xuhbehtr/",
				"appid": "1613049289050283", 
				"title": "可信前端之路-代码保护 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-04T02:30:58"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/lzg0z89lp8b/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/9gihavqse1/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fz83xuhbehtr%2f&text=%e5%8f%af%e4%bf%a1%e5%89%8d%e7%ab%af%e4%b9%8b%e8%b7%af-%e4%bb%a3%e7%a0%81%e4%bf%9d%e6%8a%a4"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fz83xuhbehtr%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fz83xuhbehtr%2f&text=%e5%8f%af%e4%bf%a1%e5%89%8d%e7%ab%af%e4%b9%8b%e8%b7%af-%e4%bb%a3%e7%a0%81%e4%bf%9d%e6%8a%a4"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fz83xuhbehtr%2f&title=%e5%8f%af%e4%bf%a1%e5%89%8d%e7%ab%af%e4%b9%8b%e8%b7%af-%e4%bb%a3%e7%a0%81%e4%bf%9d%e6%8a%a4"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fz83xuhbehtr%2f&is_video=false&description=%e5%8f%af%e4%bf%a1%e5%89%8d%e7%ab%af%e4%b9%8b%e8%b7%af-%e4%bb%a3%e7%a0%81%e4%bf%9d%e6%8a%a4"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%8f%af%e4%bf%a1%e5%89%8d%e7%ab%af%e4%b9%8b%e8%b7%af-%e4%bb%a3%e7%a0%81%e4%bf%9d%e6%8a%a4&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fz83xuhbehtr%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fz83xuhbehtr%2f&title=%e5%8f%af%e4%bf%a1%e5%89%8d%e7%ab%af%e4%b9%8b%e8%b7%af-%e4%bb%a3%e7%a0%81%e4%bf%9d%e6%8a%a4"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fz83xuhbehtr%2f&title=%e5%8f%af%e4%bf%a1%e5%89%8d%e7%ab%af%e4%b9%8b%e8%b7%af-%e4%bb%a3%e7%a0%81%e4%bf%9d%e6%8a%a4"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fz83xuhbehtr%2f&title=%e5%8f%af%e4%bf%a1%e5%89%8d%e7%ab%af%e4%b9%8b%e8%b7%af-%e4%bb%a3%e7%a0%81%e4%bf%9d%e6%8a%a4"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fz83xuhbehtr%2f&title=%e5%8f%af%e4%bf%a1%e5%89%8d%e7%ab%af%e4%b9%8b%e8%b7%af-%e4%bb%a3%e7%a0%81%e4%bf%9d%e6%8a%a4"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">可信前端之路-代码保护</h1><div class="meta"><div class="postdate"><time datetime="2019-02-04" itemprop="datePublished">2019-02-04</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e0x00 前言\x3c\/h2\x3e\n\x3cp\x3e在信息安全领域，可信系统（Trusted system）是一个让人心动的目标，它指的是一个通过实施特定的安全策略而达到一定可信程度的系统。\x3c\/p\x3e\n\x3cp\x3e在计算机中，可信平台模块（Trusted Platform Module，TPM）已经投入使用，它符合可信赖计算组织（Trusted Computing Group，TCG）制定的TPM规范，是为了实现可信系统目标的而打造的一款安全芯片。作为可信系统的信任根，TPM是可信计算的核心模块，为计算机安全提供了强有力的保障。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000006851893\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000006851893\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e而在我们的web系统中，想打造一个可信系统似乎是个伪命题，“永远不要相信客户端的输入”是基本的安全准则。实际上，在可信系统中的可信也并不是说真的是绝对安全，维基上对其的解释为：“可信的”（Trusted）未必意味着对用户而言是“值得信赖的”（Trustworthy）。确切而言，它意味着可以充分相信其行为会更全面地遵循设计，\x3cstrong\x3e而执行设计者和软件编写者所禁止的行为的概率很低\x3c\/strong\x3e。\x3c\/p\x3e\n\x3cp\x3e从这个角度讲，我们把其当做一个美好的愿景，我们希望能够构造一个web系统中的TPM，可以把恶意行为控制在一定的概率之内，从而实现一个相对可信的web系统。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e0x01 可信前端\x3c\/h2\x3e\n\x3cp\x3e在可信系统中，TPM的一个重要作用就是鉴别消息来源的真实性，保障终端的可信。在web系统中，我们的消息来源就是用户。随着撞库、恶意注册、薅羊毛等产业的蓬勃发展，在越来越多的场景我们需要鉴别请求数据是否来自真实的用户，保护真实用户的数据安全。\x3c\/p\x3e\n\x3cp\x3e所以想要构造一个web系统中的TPM，首要问题就是需要保证输入数据安全，打造一个相对可信的前端环境。但是由于web的开放特性，前端作为数据采集的最前线，js代码始终暴露在外，在这种情况下，防止恶意伪造请求变得非常困难，可信前端也就成了无稽之谈。\x3c\/p\x3e\n\x3cp\x3e在反复对抗中，代码保护也就是通常意义上的js代码混淆的重要性逐渐彰显出来。今天我就想和大家聊一聊js混淆的问题。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e1、为什么需要js混淆\x3c\/h3\x3e\n\x3cp\x3e显而易见，是为了保护我们的前端代码逻辑。\x3c\/p\x3e\n\x3cp\x3e在web系统发展早期，js在web系统中承担的职责并不多，只是简单的提交表单，js文件非常简单，也不需要任何的保护。\x3c\/p\x3e\n\x3cp\x3e随着js文件体积的增大，为了缩小js体积，加快http传输速度，开始出现了很多对js的压缩工具，比如 uglify、compressor、clouser。。。它们的工作主要是\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e合并多个js文件\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e去除js代码里面的空格和换行\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e压缩js里面的变量名\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e剔除掉注释\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000006851894\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000006851894\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e【压缩后的代码】\x3c\/p\x3e\n\x3cp\x3e虽然压缩工具出发点都是为了减少js文件的体积，但是人们发现压缩替换后的代码已经比源代码可读性差了很多，间接起到了代码保护的作用，于是压缩js文件成为了前端发布的标配之一。但是后来市面上主流浏览器chrome、Firefox等都提供了js格式化的功能，能够很快的把压缩后的js美化，再加上现代浏览器强大的debug功能，单纯压缩过的js代码对于真正怀有恶意的人，已经不能起到很好的防御工作，出现了\x22防君子不防小人\x22的尴尬局面。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000006851895\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000006851895\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e【chrome开发者工具格式化之后的代码】\x3c\/p\x3e\n\x3cp\x3e而在web应用越来越丰富的今天，伴随着浏览器性能和网速的提高，js承载了更多的工作，不少后端逻辑都在向前端转移，与此同时也让更多的不法分子有机可乘。在web模型中，js往往是不法分子的第一个突破口。知晓了前端逻辑，不法分子可以模拟成一个正常的用户来实施自己的恶意行为。所以，在很多登录、注册、支付、交易等等页面中，关键业务和风控系统依赖的js都不希望被人轻易的破解，js混淆应运而生。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e2、js混淆是不是纸老虎\x3c\/h3\x3e\n\x3cp\x3e这是一个老生常谈的问题。实际上，代码混淆早就不是一个新鲜的名词，在桌面软件时代，大多数的软件都会进行代码混淆、加壳等手段来保护自己的代码。Java和.NET都有对应的混淆器。黑客们对这个当然也不陌生，许多病毒程序为了反查杀，也会进行高度的混淆。只不过由于js是动态脚本语言，在http中传输的就是源代码，逆向起来要比打包编译后的软件简单很多，很多人因此觉得混淆是多此一举。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000006851896\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000006851896\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e【.NET混淆器dotFuscator】\x3c\/p\x3e\n\x3cp\x3e其实正是因为js传输的就是源代码，我们才需要进行混淆，暴露在外的代码没有绝对的安全，但是在对抗中，精心设计的混淆代码能够给破坏者带来不小的麻烦，也能够为防守者争取更多的时间，相对于破解来说，混淆器规则的更替成本要小得多，在高强度的攻防中，可以大大增加破解者的工作量，起到防御作用。从这个角度来讲，关键代码进行混淆是必不可少的步骤。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e3、如何进行js混淆\x3c\/h3\x3e\n\x3cp\x3ejs混淆器大致有两种：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e通过正则替换实现的混淆器\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e通过语法树替换实现的混淆器\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e第一种实现成本低，但是效果也一般，适合对混淆要求不高的场景。第二种实现成本较高，但是更灵活，而且更安全，更适合对抗场景，我这里主要讲一下第二种。基于语法层面的混淆器其实类似于编译器，基本原理和编译器类似，我们先对编译器做一些基本的介绍。\x3c\/p\x3e\n\x3cp\x3e名词解释\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3etoken: 词法单元，也有叫词法记号的，词法分析器的产物，文本流被分割后的最小单位。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eAST: 抽象语法树，语法分析器的产物，是源代码的抽象语法结构的树状表现形式。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000006851897\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000006851897\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e【编译器VS混淆器】\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e编译器工作流程\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e简单的说，当我们读入一段字符串文本（source code），词法分析器会把它拆成一个一个小的单位（token），比如数字1 是一个token, 字符串\x27abc\x27是一个token等等。接下来语法分析器会把这些单位组成一颗树状结构（AST），这个树状结构就代表了token们的组成关系。比如 1 \x2b 2 就会展示成一棵加法树，左右子节点分别是token - 1 和token - 2 ，中间token表示加法。编译器根据生成的AST转换到中间代码，最终转换成机器代码。\x3c\/p\x3e\n\x3cp\x3e对编译器更多细节感兴趣的同学可以移步龙书：\x3ca href=\x22https:\/\/book.douban.com\/subject\/5416783\/?spm=a313e.7916648.0.0.ODNOoZ\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e编译原理\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e混淆器工作流程\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e编译器需要把源代码编译成中间代码或者机器码，而我们的混淆器输出其实还是js。所以我们从语法分析之后往下的步骤并不需要。想想我们的目标是什么，是修改原有的js代码结构，在这里面这个结构对应的是什么呢？就是AST。任何一段正确的js代码一定可以组成一颗AST，同样，因为AST表示了各个token的逻辑关系，我们也可以通过AST反过来生成一段js代码。所以，你只需要构造出一颗AST，就能生成任何js代码！混淆过程如上右图所示\x3c\/p\x3e\n\x3cp\x3e通过修改AST生成一个新的AST，新的AST就可以对应新的JavaScript代码。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e规则设计\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e知道了大致的混淆流程，最重要的环节就是设计规则。我们上面说了，我们需要生成新的AST结构意味着会生成和源代码不一样的js代码，但是我们的混淆是不能破坏原有代码的执行结果的，所以混淆规则必须保证是在不破坏代码执行结果的情况下，让代码变得更难以阅读。\x3c\/p\x3e\n\x3cp\x3e具体的混淆规则各位可以自行根据需求设计，比如拆分字符串、拆分数组，增加废代码等等。\x3c\/p\x3e\n\x3cp\x3e参考：提供商业混淆服务的 \x3ca href=\x22https:\/\/jscrambler.com\/?spm=a313e.7916648.0.0.ODNOoZ\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ejscramble\x3c\/a\x3e 的混淆规则\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000006851898\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000006851898\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e实现\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e很多人看到这里就望而却步，因为词法分析和文法分析对编译原理要求较高。其实这些现在都有工具可以帮助搞定了，借助工具，我们可以直接进行最后一步，对AST的修改。\x3c\/p\x3e\n\x3cp\x3e市面上JavaScript词法和文法分析器有很多，比如其实v8就是一个，还有mozilla的 \x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Mozilla\/Projects\/SpiderMonkey\/Parser_API?spm=a313e.7916648.0.0.ODNOoZ\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eSpiderMonkey\x3c\/a\x3e ， 知名的 \x3ca href=\x22http:\/\/esprima.org\/?spm=a313e.7916648.0.0.ODNOoZ\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eesprima\x3c\/a\x3e 等等，我这里要推荐的是 \x3ca href=\x22http:\/\/lisperator.net\/uglifyjs\/transform?spm=a313e.7916648.0.0.ODNOoZ\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3euglify\x3c\/a\x3e，一个基于nodejs的解析器。它具有以下功能：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3eparser，把 JavaScript 代码解析成抽象语法树\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3ecode generator，通过抽象语法树生成代码\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3escope analyzer，分析变量定义的工具\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3etree walker，遍历树节点\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3etree transformer，改变树节点\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e对比下我上面给出的混淆器设计的图，发现其实只需要修改语法树 这一步自己完成。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e实例\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e说了这么多，可能很多人还是一头雾水，为了帮助各位理解，我准备了一个简单的例子，假设我们的混淆规则是想把 var a = 1; 中的数字1换成16进制，我们该如何设计混淆器呢。首先对源代码做词法分析和语法分析，uglify一个方法就搞定了，生成一颗语法树，我们需要做的就是找到语法树中的数字然后修改成16进制的结果，如下图所示：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000006851899\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000006851899\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e实例代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var UglifyJS = require(\x26quot;uglify-js\x26quot;);\nvar code = \x26quot;var a = 1;\x26quot;;\nvar toplevel = UglifyJS.parse(code); \/\/toplevel就是语法树\nvar transformer = new UglifyJS.TreeTransformer(function (node) {\nif (node instanceof UglifyJS.AST_Number) { \/\/查找需要修改的叶子节点\n        node.value = \x270x\x27 \x2b Number(node.value).toString(16);\n        return node; \/\/返回一个新的叶子节点 替换原来的叶子节点\n    };\n});\ntoplevel.transform(transformer);  \/\/遍历AST树\nvar ncode = toplevel.print_to_string(); \/\/从AST还原成字符串\nconsole.log(ncode); \/\/ var a = 0x1;\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e UglifyJS = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22uglify-js\x22\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e code = \x3cspan class=\x22hljs-string\x22\x3e\x22var a = 1;\x22\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e toplevel = UglifyJS.parse(code); \x3cspan class=\x22hljs-comment\x22\x3e\/\/toplevel就是语法树\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e transformer = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e UglifyJS.TreeTransformer(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3enode\x3c\/span\x3e) \x3c\/span\x3e{\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (node \x3cspan class=\x22hljs-keyword\x22\x3einstanceof\x3c\/span\x3e UglifyJS.AST_Number) { \x3cspan class=\x22hljs-comment\x22\x3e\/\/查找需要修改的叶子节点\x3c\/span\x3e\n        node.value = \x3cspan class=\x22hljs-string\x22\x3e\x270x\x27\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-built_in\x22\x3eNumber\x3c\/span\x3e(node.value).toString(\x3cspan class=\x22hljs-number\x22\x3e16\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e node; \x3cspan class=\x22hljs-comment\x22\x3e\/\/返回一个新的叶子节点 替换原来的叶子节点\x3c\/span\x3e\n    };\n});\ntoplevel.transform(transformer);  \x3cspan class=\x22hljs-comment\x22\x3e\/\/遍历AST树\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e ncode = toplevel.print_to_string(); \x3cspan class=\x22hljs-comment\x22\x3e\/\/从AST还原成字符串\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(ncode); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ var a = 0x1;\x3c\/span\x3e\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e上面的代码很简单，首先通过parse方法构建语法树，然后通过TreeTransformer遍历语法树，当遇到节点属于UglifyJS.AST_Number类型（所有的AST类型见 \x3ca href=\x22http:\/\/lisperator.net\/uglifyjs\/ast?spm=a313e.7916648.0.0.ODNOoZ\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3east\x3c\/a\x3e）,这个token具有一个属性 value 保存着数字类型的具体值，我们将其改成16进制表示，然后 return node 就会用新的节点代替原来的节点。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e效果展示\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e贴一个我自己设计的混淆器混淆前后代码：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000006851900\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000006851900\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e4、混淆对性能的影响\x3c\/h3\x3e\n\x3cp\x3e由于增加了废代码，改变了原有的AST，混淆对性能肯定会造成一定的影响，但是我们可以通过规则来控制影响的大小。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e减少循环混淆，循环太多会直接影响代码执行效率\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e避免过多的字符串拼接，因为字符串拼接在低版本IE下面会有性能问题\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e控制代码体积，在插入废代码时应该控制插入比例，文件过大会给网络请求和代码执行都带来压力\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e我们通过一定的规则完全可以把性能影响控制在一个合理的范围内，实际上，有一些混淆规则反而会加快代码的执行，比如变量名和属性名的压缩混淆，会减小文件体积，比如对全局变量的复制，会减少作用域的查找等等。在现代浏览器中，混淆对代码的影响越来越小，我们只需要注意合理的混淆规则，完全可以放心的使用混淆。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3e5、混淆的安全性\x3c\/h3\x3e\n\x3cp\x3e混淆的目的是保护代码，但是如果因为混淆影响了正常功能就舍本逐末了。\x3c\/p\x3e\n\x3cp\x3e由于混淆后的AST已经和原AST完全不同了，但是混淆后文件的和原文件执行结果必须一样，如何保证既兼顾了混淆强度，又不破坏代码执行呢？高覆盖的测试必不可少：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e对自己的混淆器写详尽的单元测试\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e对混淆的目标代码做高覆盖的功能测试，保证混淆前后代码执行结果完全一样\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e多样本测试，可以混淆单元测试已经完备了的类库，比如混淆 Jquery 、AngularJS 等，然后拿混淆后的代码去跑它们的单元测试，保证和混淆前执行结果完全一样\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e0x02 总结\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e可信web系统是我们的愿景\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e可信web系统离不开可信的前端环境\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3ejs混淆在对抗中必不可少\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e实现一款自己的混淆器并没有那么难\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e混淆器对性能的影响是可控的\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch2 id=\x22articleHeader8\x22\x3e0x03 参考\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/Trusted_Platform_Module\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/en.wikipedia.org\/wiki...\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/Trusted_system\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/en.wikipedia.org\/wiki...\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22http:\/\/lisperator.net\/uglifyjs\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttp:\/\/lisperator.net\/uglifyjs\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22http:\/\/esprima.org\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttp:\/\/esprima.org\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cstrong\x3e作者：莫念@阿里安全，更多安全类文章，请访问\x3ca href=\x22http:\/\/jaq.alibaba.com\/community\/index.htm?spm=a313e.7768735.1000000.6.anj7zJ\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e阿里聚安全博客\x3c\/a\x3e\x3c\/strong\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>可信前端之路-代码保护</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000006851890">https://segmentfault.com/a/1190000006851890</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/z83xuhbehtr/" target="_blank">https://alili.tech/archive/z83xuhbehtr/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>