<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="多屏互动——H5 中级进阶"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>多屏互动——H5 中级进阶 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/c2ekhqxwtcj/",
				"appid": "1613049289050283", 
				"title": "多屏互动——H5 中级进阶 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-07T02:30:15"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/a2eeriid7ul/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/ltxutbyj8c/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fc2ekhqxwtcj%2f&text=%e5%a4%9a%e5%b1%8f%e4%ba%92%e5%8a%a8%e2%80%94%e2%80%94H5%20%e4%b8%ad%e7%ba%a7%e8%bf%9b%e9%98%b6"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fc2ekhqxwtcj%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fc2ekhqxwtcj%2f&text=%e5%a4%9a%e5%b1%8f%e4%ba%92%e5%8a%a8%e2%80%94%e2%80%94H5%20%e4%b8%ad%e7%ba%a7%e8%bf%9b%e9%98%b6"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fc2ekhqxwtcj%2f&title=%e5%a4%9a%e5%b1%8f%e4%ba%92%e5%8a%a8%e2%80%94%e2%80%94H5%20%e4%b8%ad%e7%ba%a7%e8%bf%9b%e9%98%b6"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fc2ekhqxwtcj%2f&is_video=false&description=%e5%a4%9a%e5%b1%8f%e4%ba%92%e5%8a%a8%e2%80%94%e2%80%94H5%20%e4%b8%ad%e7%ba%a7%e8%bf%9b%e9%98%b6"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%a4%9a%e5%b1%8f%e4%ba%92%e5%8a%a8%e2%80%94%e2%80%94H5%20%e4%b8%ad%e7%ba%a7%e8%bf%9b%e9%98%b6&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fc2ekhqxwtcj%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fc2ekhqxwtcj%2f&title=%e5%a4%9a%e5%b1%8f%e4%ba%92%e5%8a%a8%e2%80%94%e2%80%94H5%20%e4%b8%ad%e7%ba%a7%e8%bf%9b%e9%98%b6"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fc2ekhqxwtcj%2f&title=%e5%a4%9a%e5%b1%8f%e4%ba%92%e5%8a%a8%e2%80%94%e2%80%94H5%20%e4%b8%ad%e7%ba%a7%e8%bf%9b%e9%98%b6"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fc2ekhqxwtcj%2f&title=%e5%a4%9a%e5%b1%8f%e4%ba%92%e5%8a%a8%e2%80%94%e2%80%94H5%20%e4%b8%ad%e7%ba%a7%e8%bf%9b%e9%98%b6"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fc2ekhqxwtcj%2f&title=%e5%a4%9a%e5%b1%8f%e4%ba%92%e5%8a%a8%e2%80%94%e2%80%94H5%20%e4%b8%ad%e7%ba%a7%e8%bf%9b%e9%98%b6"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">多屏互动——H5 中级进阶</h1><div class="meta"><div class="postdate"><time datetime="2019-02-07" itemprop="datePublished">2019-02-07</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e前言\x3c\/h2\x3e\n\x3cp\x3e随着智能硬件的普及，手机，平板，PC甚至路边的电子广告牌，现代浏览器已经无处不在。在浏览器里编织出我们自己的一片天地已经轻车熟路，但是这还不够，H5赋予了浏览器太多的新特性，等待我们去使用。这篇文章介绍利用手机浏览器的罗盘API，在PC的浏览器实时地绘制一个3D盒模型。\x3c\/p\x3e\n\x3cp\x3e这种炫酷的玩法叫做“多屏互动”，就像是把手机当做游戏手柄，PC显示器当做电视机，不过这些都是在浏览器里实现的。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e先上效果图\x3c\/strong\x3e\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000006760584?w=483\x26amp;h=272\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000006760584?w=483\x26amp;h=272\x22 alt=\x22这里写图片描述\x22 title=\x22这里写图片描述\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e(测试机是刷了小米系统的裂了屏幕的HTC霹雳2\x2bChrome浏览器)\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e源码请戳这里\x3c\/strong\x3e：\x3ca href=\x22https:\/\/coding.net\/u\/OverTree\/p\/webSocketDemo\/git\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/coding.net\/u\/OverTree...\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e本地测试过程：\x3c\/strong\x3e\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e在PC上，使用命令 node index.js，自动打开项目主页。（请关闭ADsafe，如有虚拟机，请停用虚拟网卡）\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e创建一个“房间”并自动进入“房间”。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e用手机扫描“房间”内任意位置的二维码。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e确保手机和PC可以相互PING通\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cblockquote\x3e\x3cp\x3eADsafe是个很好用的去广告软件，但是会阻止本机IP访问，可能造成项目首页打不开，所以请先暂时关闭\x3cbr\x3e本程序会自动获取本机IP，如果有虚拟网卡，IP地址可能获取不正确\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3chr\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e客户端（浏览器）\x3c\/h2\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e\x3cstrong\x3e1. 手机浏览器端\x3c\/strong\x3e\x3c\/h3\x3e\n\x3cp\x3e一个物体在空间内的旋转体位，都可以用一个方向向量（x,y,z）和旋转角度（angle）来表示。也就是CSS3\x3ccode\x3etransform\x3c\/code\x3e的\x3ccode\x3erotate3d(x,y,z,angle)\x3c\/code\x3e这个函数的4个参数。\x3c\/p\x3e\n\x3cp\x3e想要在浏览器里方便的绘制一个立体模型的的旋转，重点就是利用手机浏览器的H5新特性去获取手机旋转状态的数据，然后转化成这4个参数。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e\x3cstrong\x3e1.1 重力感应API\x3c\/strong\x3e\x3c\/h3\x3e\n\x3cp\x3e\x3ccode\x3edevicemotion\x3c\/code\x3e 顾名思义设备运动\x3cbr\x3e其实不仅仅有重力感应的数据，还有移动加速度，摆动角度。\x3cbr\x3e不过这个接口倾向于\x3cstrong\x3e运动时瞬间\x3c\/strong\x3e的数据展示，静止时，除了重力加速度，其他数据（移动加速度，摆动角度）基本为0。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22window.addEventListener(\x27devicemotion\x27, deviceMotionHandler, true);\nfunction deviceMotionHandler(evt){\n   if(evt.accelerationIncludingGravity){\n       document.body.innerHTML = \n          \x26quot;x轴加速度: \x26quot; \x2b evt.accelerationIncludingGravity.x \x2b \x26quot;\x3cbr\x3e\x26quot;\n        \x2b \x26quot;y轴加速度: \x26quot; \x2b evt.accelerationIncludingGravity.y \x2b \x26quot;\x3cbr\x3e\x26quot;\n        \x2b \x26quot;z轴加速度: \x26quot; \x2b evt.accelerationIncludingGravity.z \x2b \x26quot;\x3cbr\x3e\x26quot;\n    }\n    if(evt.rotationRate ){\n       document.body.innerHTML \x2b=  \n         \x26quot;x轴扭转: \x26quot; \x2b evt.rotationRate.beta \x2b \x26quot;\x3cbr\x3e\x26quot; \n       \x2b \x26quot;y轴扭转: \x26quot; \x2b evt.rotationRate.gamma \x2b \x26quot;\x3cbr\x3e\x26quot;\n       \x2b \x26quot;z轴扭转: \x26quot; \x2b evt.rotationRate.alpha \x2b \x26quot;\x3cbr\x3e\x26quot;\n    }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22xml hljs\x22\x3e\x3ccode class=\x22html5\x22\x3ewindow.addEventListener(\x27devicemotion\x27, deviceMotionHandler, true);\nfunction deviceMotionHandler(evt){\n   if(evt.accelerationIncludingGravity){\n       document.body.innerHTML = \n          \x22x轴加速度: \x22 \x2b evt.accelerationIncludingGravity.x \x2b \x22\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ebr\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x22\n        \x2b \x22y轴加速度: \x22 \x2b evt.accelerationIncludingGravity.y \x2b \x22\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ebr\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x22\n        \x2b \x22z轴加速度: \x22 \x2b evt.accelerationIncludingGravity.z \x2b \x22\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ebr\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x22\n    }\n    if(evt.rotationRate ){\n       document.body.innerHTML \x2b=  \n         \x22x轴扭转: \x22 \x2b evt.rotationRate.beta \x2b \x22\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ebr\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x22 \n       \x2b \x22y轴扭转: \x22 \x2b evt.rotationRate.gamma \x2b \x22\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ebr\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x22\n       \x2b \x22z轴扭转: \x22 \x2b evt.rotationRate.alpha \x2b \x22\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ebr\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x22\n    }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cstrong\x3e（魅族老机型，安卓4.4.4的自带浏览器对此API支持不完全，请另外安装QQ浏览器）\x3c\/strong\x3e\x3cbr\x3e在手机浏览器里运行以上代码，并稍微晃动，会看到打印数据狂跳。\x3cbr\x3e拿到了数据，接下来开始观察规律。\x3cbr\x3e手机屏幕朝上，水平静止放置，Z轴重力加速度为9.8，Y,X为0。\x3cbr\x3e手机屏幕朝下，水平静止放置，Z轴重力加速度为-9.8，Y,X为0。\x3cbr\x3e手机话筒朝下，竖直静止放置，Y重力加速度为9.8, X,Z为0。\x3cbr\x3e手机话筒朝上，竖直静止放置，Y重力加速度为-9.8, X,Z为0。\x3cbr\x3e手机右侧朝上，竖直静止放置，X重力加速度为9.8, Y,Z为0。\x3cbr\x3e手机左侧朝下，竖直静止放置，X重力加速度为-9.8, Y,Z为0。\x3c\/p\x3e\n\x3cp\x3e那么手机的空间坐标如下图：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000006760585?w=450\x26amp;h=450\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000006760585?w=450\x26amp;h=450\x22 alt=\x22这里写图片描述\x22 title=\x22这里写图片描述\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3cbr\x3e箭头指向都是坐标正方向。\x3c\/p\x3e\n\x3cp\x3e当手机开始倾斜，X,Y,Z轴的加速度分量都有值，且绝对值都小于9.8。根据分量的数值，是可以算出手机在三维空间的倾斜状态，只不过这个计算过程复杂，而且在手机运动时，重力加速度的值并不准确表达当前倾斜。一般不用这个数据去计算手机在三维空间的倾斜。\x3c\/p\x3e\n\x3cp\x3e当手机水平放置，拨动手机，使其慢慢旋转，重力加速度的数据并没有变化。\x3cbr\x3e所以，\x3cstrong\x3e重力感应的这个API，只能获取设备当前的倾斜状态，而无法获取设备的旋转方向\x3c\/strong\x3e。而一些简单的功能，比如摇一摇，晃一晃，就可以用这个接口去实现。\x3c\/p\x3e\n\x3cp\x3e利用重力感应的API，可以轻松利用高中数学的\x3cstrong\x3e反三角函数\x3c\/strong\x3e，实现XY二维平面的旋转，效果如下：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000005990687\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000005990687\x22 alt=\x22这里写图片描述\x22 title=\x22这里写图片描述\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e代码如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function deviceMotionHandler(evt){\n    var angle = \n    Math.atan2(\n            0 - evt.accelerationIncludingGravity.x ,     　　　\n            evt.accelerationIncludingGravity.y\n        ).toFixed(2) \/ Math.PI * 180 ; \n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3edeviceMotionHandler\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eevt\x3c\/span\x3e)\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e angle = \n    \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.atan2(\n            \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e - evt.accelerationIncludingGravity.x ,     　　　\n            evt.accelerationIncludingGravity.y\n        ).toFixed(\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e) \/ \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.PI * \x3cspan class=\x22hljs-number\x22\x3e180\x3c\/span\x3e ; \n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这个 angle 就可以直接应用在DOM的CSS属性\x3ccode\x3etransform:rotate(angle deg)\x3c\/code\x3e上。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e\x3cstrong\x3e1.2 罗盘API\x3c\/strong\x3e\x3c\/h3\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22window.addEventListener(\x27deviceorientation\x27, deviceOrientationHandler, true);\nfunction deviceMotionHandler(evt){\n     document.body.innerHTML = \n          \x26quot;z轴旋转(罗盘方向) alpha: 　\x26quot; \x2b event.alpha \x2b \x26quot;\x3cbr\x3e\x26quot;\n        \x2b \x26quot;y轴旋转 gamma: 　\x26quot; \x2b event.gamma \x2b \x26quot;\x3cbr\x3e\x26quot;\n        \x2b \x26quot;x轴旋转 beta: 　\x26quot; \x2b event.beta\n\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22xml hljs\x22\x3e\x3ccode class=\x22html5\x22\x3ewindow.addEventListener(\x27deviceorientation\x27, deviceOrientationHandler, true);\nfunction deviceMotionHandler(evt){\n     document.body.innerHTML = \n          \x22z轴旋转(罗盘方向) alpha: 　\x22 \x2b event.alpha \x2b \x22\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ebr\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x22\n        \x2b \x22y轴旋转 gamma: 　\x22 \x2b event.gamma \x2b \x22\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ebr\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x22\n        \x2b \x22x轴旋转 beta: 　\x22 \x2b event.beta\n\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e重点来了，\x3ccode\x3edeviceorientation\x3c\/code\x3e能够很好的表现物体在空间中的状态，旋转方向，倾斜角度，无论是静止还是运动或者加速运动。\x3c\/p\x3e\n\x3cp\x3e这里要和\x3ccode\x3edevicemotion\x3c\/code\x3e 的 \x3ccode\x3eevt.rotationRate\x3c\/code\x3e区分一下，虽然都有alpha，gamma，beta 但是 \x3ccode\x3edevicemotion\x3c\/code\x3e 描述的是旋转变化了的角度值，物体角度变化才会有数据，静止了之后就变为0，而 \x3ccode\x3edeviceorientation\x3c\/code\x3e 的是描述是静止时的角度值。\x3c\/p\x3e\n\x3cp\x3e这三个数值的单位都是deg，如何转化为CSS3 \x3ccode\x3etransform:rotate3d(x,y,z,angle)\x3c\/code\x3e 的4个参数，对于没有任何3D知识的前端狗来说是个挺麻烦的问题。\x3c\/p\x3e\n\x3cp\x3e现在要引入一个概念：\x3cstrong\x3e四元数\x3c\/strong\x3e\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3e四元数是个高阶复数 q = [w,x,y,z]。\x3cbr\x3e四元数的基本数学方程为 :\x3cbr\x3eq = cos (a\/2) \x2b i(x \x3cem\x3e sin(a\/2)) \x2b j(y \x3c\/em\x3e sin(a\/2)) \x2b k(z * sin(a\/2)) 其中a表示旋转角度，(x,y,z)表示旋转轴。\x3cbr\x3e四元数表示一个完整的旋转。\x3cbr\x3e四元数可以由各轴旋转角(alpha,beta,gamma)求得。\x3cbr\x3e四元数可以转换旋转轴(x,y,z)和旋转角度(angle)。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e作为初试，本篇并不深入讨论四元数的具体定义，难点是获取四元数[w,x,y,z]。\x3cbr\x3e好在官方提供了旋转角(alpha,beta,gamma)转换成四元数的方法\x3cbr\x3e\x3ca href=\x22https:\/\/w3c.github.io\/deviceorientation\/spec-source-orientation.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/w3c.github.io\/deviceo...\x3c\/a\x3e\x3cbr\x3e在这个页面内搜索 \x3cem\x3egetQuaternion\x3c\/em\x3e\x3c\/p\x3e\n\x3cp\x3e另外我根据数学公式反求，写了一个四元数转(x,y,z,angle) 的函数 getAcQuaternion\x3cbr\x3e代码如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var degtorad = Math.PI \/ 180;\nfunction getQuaternion( alpha, beta, gamma ) {  \/\/官方求四元数方法\n\n  var _x = beta  ? beta  * degtorad : 0; \/\/ beta value\n  var _y = gamma ? gamma * degtorad : 0; \/\/ gamma value\n  var _z = alpha ? alpha * degtorad : 0; \/\/ alpha value\n\n  var cX = Math.cos( _x\/2 );\n  var cY = Math.cos( _y\/2 );\n  var cZ = Math.cos( _z\/2 );\n  var sX = Math.sin( _x\/2 );\n  var sY = Math.sin( _y\/2 );\n  var sZ = Math.sin( _z\/2 );\n\n  var w = cX * cY * cZ - sX * sY * sZ;\n  var x = sX * cY * cZ - cX * sY * sZ;\n  var y = cX * sY * cZ \x2b sX * cY * sZ;\n  var z = cX * cY * sZ \x2b sX * sY * cZ;\n\n  return [ w, x, y, z ];\n\n}\n\nfunction getAcQuaternion( _w, _x, _y, _z ) {  \/\/我的四元数转旋转轴和旋转角度方法\n\n  var rotate = 2 * Math.acos(_w)\/degtorad ;\n\n  var x = _x \/ Math.sin(degtorad * rotate\/2) || 0;\n  var y = _y \/ Math.sin(degtorad * rotate\/2) || 0;\n  var z = _z \/ Math.sin(degtorad * rotate\/2) || 0;\n\n  return {x:x,y:y,z:z,rotate:rotate};\n\n}\n\nfunction deviceMotionHandler(evt){  \/\/ deviceorientation 事件处理函数\n  var qu = getQuaternion(evt.alpha,evt.beta,evt.gamma);\n  var rotate3d = getAcQuaternion(qu[0],qu[1],qu[2],qu[3]);\n  \/\/ rotate3d的参数已经有了，随你处理咯。我是把他送给服务器，交给PC，在PC上显示旋转\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e degtorad = \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.PI \/ \x3cspan class=\x22hljs-number\x22\x3e180\x3c\/span\x3e;\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egetQuaternion\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e alpha, beta, gamma \x3c\/span\x3e) \x3c\/span\x3e{  \x3cspan class=\x22hljs-comment\x22\x3e\/\/官方求四元数方法\x3c\/span\x3e\n\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e _x = beta  ? beta  * degtorad : \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ beta value\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e _y = gamma ? gamma * degtorad : \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ gamma value\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e _z = alpha ? alpha * degtorad : \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ alpha value\x3c\/span\x3e\n\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e cX = \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.cos( _x\/\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e );\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e cY = \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.cos( _y\/\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e );\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e cZ = \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.cos( _z\/\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e );\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sX = \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.sin( _x\/\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e );\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sY = \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.sin( _y\/\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e );\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e sZ = \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.sin( _z\/\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e );\n\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e w = cX * cY * cZ - sX * sY * sZ;\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e x = sX * cY * cZ - cX * sY * sZ;\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e y = cX * sY * cZ \x2b sX * cY * sZ;\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e z = cX * cY * sZ \x2b sX * sY * cZ;\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e [ w, x, y, z ];\n\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egetAcQuaternion\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e _w, _x, _y, _z \x3c\/span\x3e) \x3c\/span\x3e{  \x3cspan class=\x22hljs-comment\x22\x3e\/\/我的四元数转旋转轴和旋转角度方法\x3c\/span\x3e\n\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e rotate = \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e * \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.acos(_w)\/degtorad ;\n\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e x = _x \/ \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.sin(degtorad * rotate\/\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e) || \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e y = _y \/ \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.sin(degtorad * rotate\/\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e) || \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e z = _z \/ \x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.sin(degtorad * rotate\/\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e) || \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e {\x3cspan class=\x22hljs-attr\x22\x3ex\x3c\/span\x3e:x,\x3cspan class=\x22hljs-attr\x22\x3ey\x3c\/span\x3e:y,\x3cspan class=\x22hljs-attr\x22\x3ez\x3c\/span\x3e:z,\x3cspan class=\x22hljs-attr\x22\x3erotate\x3c\/span\x3e:rotate};\n\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3edeviceMotionHandler\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eevt\x3c\/span\x3e)\x3c\/span\x3e{  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ deviceorientation 事件处理函数\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e qu = getQuaternion(evt.alpha,evt.beta,evt.gamma);\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e rotate3d = getAcQuaternion(qu[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e],qu[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e],qu[\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e],qu[\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e]);\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ rotate3d的参数已经有了，随你处理咯。我是把他送给服务器，交给PC，在PC上显示旋转\x3c\/span\x3e\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e\x3cstrong\x3e1.3 校准\x3c\/strong\x3e\x3c\/h3\x3e\n\x3cp\x3e这里有个3D里的概念，摄像机位置。我们的PC显示器就是一个摄像机。只能被动的从某一个角度展示拍摄的景象。正常情况下，手机所在平面应该和显示器所在平面平行，且垂直于地平面的角度。就好比是，摄像机正对着手机正面拍摄。\x3cbr\x3e如果校准的时候手机并没有垂直于地平面，摄像机的位置就不一定是正前方了。这时候展示的画面并不是水平同步的了。\x3cbr\x3e如下图所示，校准时，手机屏幕朝上。这时候摄像机位置就在天花板上了，你看到的成像就是俯视图。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000005990689\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000005990689\x22 alt=\x22这里写图片描述\x22 title=\x22这里写图片描述\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e同理，校准时，手机屏幕朝下，这时候摄像机的位置就是在地上，往上拍摄，你看到的成像就是仰视图。\x3c\/p\x3e\n\x3cp\x3e总结起来就是：\x3cstrong\x3e校准时，手机屏幕朝着哪里，摄像机就在那里拍摄着屏幕，一动不动。\x3c\/strong\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3e\x3cstrong\x3e1.4 兼容性\x3c\/strong\x3e\x3c\/h3\x3e\n\x3cp\x3edemo的兼容性测试并不理想\x3cbr\x3e在iOS平台上测试良好，且流畅。\x3c\/p\x3e\n\x3cp\x3e在安卓平台上，除了chrome浏览器之外的浏览器，会出现各种问题，主要表现在罗盘数据不准确。\x3cbr\x3e而chrome浏览器并没有扫一扫功能，因为在国外并不流行这个玩意。所以在安卓平台上就很蛋疼，还要多装一个我查查，才能完整体验。\x3cbr\x3e（如果出现旋转不准确的问题，可以尝试校准罗盘，大概就是拿着手机画8。百度一下方法有很多）\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e代码如果有兼容写法，或者有其他兼容问题请赐教，可以在coding上私信我(OverTree )，不胜感激。\x3c\/strong\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader7\x22\x3e\x3cstrong\x3e2. PC浏览器端\x3c\/strong\x3e\x3c\/h3\x3e\n\x3cp\x3ePC浏览器的作用就是能够显示房间信息，创建房间。\x3c\/p\x3e\n\x3cp\x3e显示房间，创建时间，参与人数，点击进入。\x3cbr\x3e创建一个房间，成功后自动进入房间。\x3c\/p\x3e\n\x3cp\x3e在房间内，接受服务器转发的手机端的消息，并作出相应动作，包括上线，校准，旋转，下线。\x3c\/p\x3e\n\x3cp\x3e上线时，安排就坐（隐藏二维码，显示模型）\x3cbr\x3e校准时，重新设置模型的显示角度。\x3cbr\x3e旋转时，就旋转咯。\x3cbr\x3e下线时，重新显示二维码（显示二维码，隐藏模型）\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3e\x3cstrong\x3e2.1初始化， 建立ws连接\x3c\/strong\x3e\x3c\/h3\x3e\n\x3cp\x3e重点是房间里的事情。所以这里就只介绍进入房间发生的事吧。\x3cbr\x3e首先房间参数要正确，至少有房间编号。\x3c\/p\x3e\n\x3cp\x3e房间路由:\x3cbr\x3e\/room\/[roomNumber]\x3cbr\x3eroomNumber是一串16位随机字符串。\x3cbr\x3e座位路由:\x3cbr\x3e\/room\/[roomNumber]\/[seatNumber]\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var uri = win.location.pathname.split(\x27\/\x27),roomNumber;\n\nfunction initUrlData(){\n  if(uri.length\x3e=3 \x26amp;\x26amp; uri[1] == \x26quot;room\x26quot;){\n    roomNumber = uri[2];\n    document.title = \x26quot;虚拟房间 \x26quot;\x2b roomNumber \x2b \x26quot;号\x26quot;\n    return 1;\n  }else{\n    window.location.href = \x26quot;\/index\x26quot;;\n    return 0;\n  }\n}\n\nfunction initWebSocket(){\n   var wsUri = \x26quot;ws:\/\/\x26quot;\x2b window.location.hostname \x2b\x26quot;:\x3c%= config.wsport %\x3e\x26quot;\x2b\x26quot;\/ws\/room\x26quot;; \/\/这里用了一个ejs的占位符，已便在服务器更改websocket端口时可以及时使用正确端口。\n   \n   var websocket = new WebSocket(wsUri); \n   websocket.onopen = function(evt) { \n       websocket.send(JSON.stringify({room:roomNumber})); \n   }; \/\/链接建立后，发送一个消息，表明在哪个房间\n\n   websocket.onclose = function(evt) { \n\n   }; \n\n   websocket.onmessage = function(evt) { \n       parseMessage(evt.data) \/\/解析数据\n   }; \n   websocket.onerror = function(evt) { \n\n   }; \n   \/\/绑定了这些处理函数之后，websocket开始建立链接，而不是 New 的时候开始建立\n}\n\n\n$(\x26quot;.room-place .qrcode\x26quot;).each(function(index,item){\n    $(item).qrcode({\n        \x26quot;size\x26quot;: 200,\n        \x26quot;color\x26quot;: \x26quot;#3a3\x26quot;,\n        \x26quot;text\x26quot;: window.location.origin \x2b \x26quot;\/room\/\x26quot; \x2b roomNumber \x2b \x26quot;\/\x26quot; \x2b (index\x2b1)\n    });\n    \/\/这里用jQuery的插件，jquery-qrcode 按照座位路由初始化二维码\n})\n\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e uri = win.location.pathname.split(\x3cspan class=\x22hljs-string\x22\x3e\x27\/\x27\x3c\/span\x3e),roomNumber;\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3einitUrlData\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(uri.length\x26gt;=\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e \x26amp;\x26amp; uri[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e] == \x3cspan class=\x22hljs-string\x22\x3e\x22room\x22\x3c\/span\x3e){\n    roomNumber = uri[\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e];\n    \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.title = \x3cspan class=\x22hljs-string\x22\x3e\x22虚拟房间 \x22\x3c\/span\x3e\x2b roomNumber \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22号\x22\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e;\n  }\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.location.href = \x3cspan class=\x22hljs-string\x22\x3e\x22\/index\x22\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n  }\n}\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3einitWebSocket\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n   \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e wsUri = \x3cspan class=\x22hljs-string\x22\x3e\x22ws:\/\/\x22\x3c\/span\x3e\x2b \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.location.hostname \x2b\x3cspan class=\x22hljs-string\x22\x3e\x22:\x26lt;%= config.wsport %\x26gt;\x22\x3c\/span\x3e\x2b\x3cspan class=\x22hljs-string\x22\x3e\x22\/ws\/room\x22\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/这里用了一个ejs的占位符，已便在服务器更改websocket端口时可以及时使用正确端口。\x3c\/span\x3e\n   \n   \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e websocket = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e WebSocket(wsUri); \n   websocket.onopen = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eevt\x3c\/span\x3e) \x3c\/span\x3e{ \n       websocket.send(\x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify({\x3cspan class=\x22hljs-attr\x22\x3eroom\x3c\/span\x3e:roomNumber})); \n   }; \x3cspan class=\x22hljs-comment\x22\x3e\/\/链接建立后，发送一个消息，表明在哪个房间\x3c\/span\x3e\n\n   websocket.onclose = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eevt\x3c\/span\x3e) \x3c\/span\x3e{ \n\n   }; \n\n   websocket.onmessage = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eevt\x3c\/span\x3e) \x3c\/span\x3e{ \n       parseMessage(evt.data) \x3cspan class=\x22hljs-comment\x22\x3e\/\/解析数据\x3c\/span\x3e\n   }; \n   websocket.onerror = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eevt\x3c\/span\x3e) \x3c\/span\x3e{ \n\n   }; \n   \x3cspan class=\x22hljs-comment\x22\x3e\/\/绑定了这些处理函数之后，websocket开始建立链接，而不是 New 的时候开始建立\x3c\/span\x3e\n}\n\n\n$(\x3cspan class=\x22hljs-string\x22\x3e\x22.room-place .qrcode\x22\x3c\/span\x3e).each(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eindex,item\x3c\/span\x3e)\x3c\/span\x3e{\n    $(item).qrcode({\n        \x3cspan class=\x22hljs-string\x22\x3e\x22size\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e200\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-string\x22\x3e\x22color\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22#3a3\x22\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-string\x22\x3e\x22text\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.location.origin \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22\/room\/\x22\x3c\/span\x3e \x2b roomNumber \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22\/\x22\x3c\/span\x3e \x2b (index\x2b\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e)\n    });\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/这里用jQuery的插件，jquery-qrcode 按照座位路由初始化二维码\x3c\/span\x3e\n})\n\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader9\x22\x3e\x3cstrong\x3e2.2 纯CSS3立体模型\x3c\/strong\x3e\x3c\/h3\x3e\n\x3cp\x3e做为一名普通的前端人员，想要画一个3D的模型，按照最熟悉的方法就是用CSS3了。\x3cbr\x3e（如果是用Three.js的大神请跳过本节）\x3cbr\x3e不过要很快画出一个六面体出来，还是需要想一想的，毕竟这个技能很少用。\x3c\/p\x3e\n\x3cp\x3e画一个长方体\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3csection class=\x26quot;container\x26quot;\x3e\n    \x3cdiv id=\x26quot;box\x26quot; \x3e\n      \x3cfigure class=\x26quot;front\x26quot;\x3e\x3cspan\x3e前\x3c\/span\x3e\x3c\/figure\x3e\n      \x3cfigure class=\x26quot;back\x26quot;\x3e\x3cspan\x3e后\x3c\/span\x3e\x3c\/figure\x3e\n      \x3cfigure class=\x26quot;right\x26quot;\x3e\x3cspan\x3e右\x3c\/span\x3e\x3c\/figure\x3e\n      \x3cfigure class=\x26quot;left\x26quot;\x3e\x3cspan\x3e左\x3c\/span\x3e\x3c\/figure\x3e\n      \x3cfigure class=\x26quot;top\x26quot;\x3e\x3cspan\x3e顶\x3c\/span\x3e\x3c\/figure\x3e\n      \x3cfigure class=\x26quot;bottom\x26quot;\x3e\x3cspan\x3e底\x3c\/span\x3e\x3c\/figure\x3e\n    \x3c\/div\x3e\n\x3c\/section\x3e\n\x3cstyle\x3e\n    *{\n        margin: 0; \/*不加会歪*\/\n    }\n    .container {\n      width: 300px;\n      height: 200px;\n      position: relative;\n      perspective: 1200px;  \/*摄像机距离，设置小的的话，立方体显示会变形*\/\n    }\n    #box figure {\n      display: block;\n      position: absolute;\n      border: 2px solid black;\n      line-height: 200px;\n      font-size: 40px;\n      text-align: center;\n      font-weight: bold;\n      color: white;\n      box-sizing: border-box; \/*因为有2px宽的border，如果不设置为此值，那么每个面的宽高都要少设置4个像素，才能对齐*\/\n    }    \n    #box {\n      width: 100%;\n      height: 100%;\n      position: absolute;\n      transform-style: preserve-3d;\/*这个很重要，默认是平面变形flat*\/\n    }\n\n    #box .front,\n    #box .back {\n      width: 300px;   \n      height: 200px;\n    }\n    \n    #box .right,\n    #box .left {\n      width: 100px;\n      height: 200px;\n      left:100px;     \/*调整*\/\n    }\n    \n    #box .top,\n    #box .bottom {\n      width: 300px;\n      height: 100px;\n      top:50px;       \/*调整*\/\n      line-height:100px;\n    }\n\n     \/*给每个面上半透明的颜色*\/\n     #box .front  { background: hsla( 000, 100%, 50%, 0.7 ); }\n     #box .back   { background: hsla( 160, 100%, 50%, 0.7 ); }\n     #box .right  { background: hsla( 120, 100%, 50%, 0.7 ); }\n     #box .left   { background: hsla( 180, 100%, 50%, 0.7 ); }\n     #box .top    { background: hsla( 240, 100%, 50%, 0.7 ); }\n     #box .bottom { background: hsla( 300, 100%, 50%, 0.7 ); }\n\n\n     #box .front  { \/*这个距离乘以2为前后面的距离*\/\n         transform: translateZ( 50px );\n     }\n     #box .back   { \/*front面沿着x轴旋转180度，做后面*\/\n         transform: rotateX( -180deg ) translateZ(  50px );\n     }\n     #box .right {                 \/*这个距离乘以2为左右面的距离*\/\n         transform: rotateY(   90deg ) translateZ( 150px );\n     }\n     #box .left {  \/*front面沿着y轴旋转90度，做侧面*\/\n         transform: rotateY(  -90deg ) translateZ( 150px );\n     }\n     #box .top {                   \/*这个距离乘以2为长方体高*\/\n         transform: rotateX(   90deg ) translateZ( 100px );\n     }\n     #box .bottom { \/*front面沿着x轴旋转90度，做底面*\/\n         transform: rotateX(  -90deg ) translateZ( 100px );\n     }\n\x3c\/style\x3e\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22xml hljs\x22\x3e\x3ccode class=\x22HTML\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3esection\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eclass\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22container\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eid\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22box\x22\x3c\/span\x3e \x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3efigure\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eclass\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22front\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e前\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3efigure\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3efigure\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eclass\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22back\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e后\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3efigure\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3efigure\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eclass\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22right\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e右\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3efigure\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3efigure\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eclass\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22left\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e左\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3efigure\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3efigure\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eclass\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22top\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e顶\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3efigure\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3efigure\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eclass\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22bottom\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e底\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3efigure\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3esection\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3estyle\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22css\x22\x3e\n    *{\n        \x3cspan class=\x22hljs-attribute\x22\x3emargin\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/*不加会歪*\/\x3c\/span\x3e\n    }\n    \x3cspan class=\x22hljs-selector-class\x22\x3e.container\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-attribute\x22\x3ewidth\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e300px\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-attribute\x22\x3eheight\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e200px\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-attribute\x22\x3eposition\x3c\/span\x3e: relative;\n      \x3cspan class=\x22hljs-attribute\x22\x3eperspective\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e1200px\x3c\/span\x3e;  \x3cspan class=\x22hljs-comment\x22\x3e\/*摄像机距离，设置小的的话，立方体显示会变形*\/\x3c\/span\x3e\n    }\n    \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-tag\x22\x3efigure\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-attribute\x22\x3edisplay\x3c\/span\x3e: block;\n      \x3cspan class=\x22hljs-attribute\x22\x3eposition\x3c\/span\x3e: absolute;\n      \x3cspan class=\x22hljs-attribute\x22\x3eborder\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2px\x3c\/span\x3e solid black;\n      \x3cspan class=\x22hljs-attribute\x22\x3eline-height\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e200px\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-attribute\x22\x3efont-size\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e40px\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-attribute\x22\x3etext-align\x3c\/span\x3e: center;\n      \x3cspan class=\x22hljs-attribute\x22\x3efont-weight\x3c\/span\x3e: bold;\n      \x3cspan class=\x22hljs-attribute\x22\x3ecolor\x3c\/span\x3e: white;\n      \x3cspan class=\x22hljs-attribute\x22\x3ebox-sizing\x3c\/span\x3e: border-box; \x3cspan class=\x22hljs-comment\x22\x3e\/*因为有2px宽的border，如果不设置为此值，那么每个面的宽高都要少设置4个像素，才能对齐*\/\x3c\/span\x3e\n    }    \n    \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-attribute\x22\x3ewidth\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e100%\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-attribute\x22\x3eheight\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e100%\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-attribute\x22\x3eposition\x3c\/span\x3e: absolute;\n      \x3cspan class=\x22hljs-attribute\x22\x3etransform-style\x3c\/span\x3e: preserve-\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3ed;\x3cspan class=\x22hljs-comment\x22\x3e\/*这个很重要，默认是平面变形flat*\/\x3c\/span\x3e\n    }\n\n    \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.front\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.back\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-attribute\x22\x3ewidth\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e300px\x3c\/span\x3e;   \n      \x3cspan class=\x22hljs-attribute\x22\x3eheight\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e200px\x3c\/span\x3e;\n    }\n    \n    \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.right\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.left\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-attribute\x22\x3ewidth\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e100px\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-attribute\x22\x3eheight\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e200px\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-attribute\x22\x3eleft\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e100px\x3c\/span\x3e;     \x3cspan class=\x22hljs-comment\x22\x3e\/*调整*\/\x3c\/span\x3e\n    }\n    \n    \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.top\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.bottom\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-attribute\x22\x3ewidth\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e300px\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-attribute\x22\x3eheight\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e100px\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-attribute\x22\x3etop\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e50px\x3c\/span\x3e;       \x3cspan class=\x22hljs-comment\x22\x3e\/*调整*\/\x3c\/span\x3e\n      \x3cspan class=\x22hljs-attribute\x22\x3eline-height\x3c\/span\x3e:\x3cspan class=\x22hljs-number\x22\x3e100px\x3c\/span\x3e;\n    }\n\n     \x3cspan class=\x22hljs-comment\x22\x3e\/*给每个面上半透明的颜色*\/\x3c\/span\x3e\n     \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.front\x3c\/span\x3e  { \x3cspan class=\x22hljs-attribute\x22\x3ebackground\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3ehsla\x3c\/span\x3e( 000, 100%, 50%, 0.7 ); }\n     \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.back\x3c\/span\x3e   { \x3cspan class=\x22hljs-attribute\x22\x3ebackground\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3ehsla\x3c\/span\x3e( 160, 100%, 50%, 0.7 ); }\n     \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.right\x3c\/span\x3e  { \x3cspan class=\x22hljs-attribute\x22\x3ebackground\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3ehsla\x3c\/span\x3e( 120, 100%, 50%, 0.7 ); }\n     \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.left\x3c\/span\x3e   { \x3cspan class=\x22hljs-attribute\x22\x3ebackground\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3ehsla\x3c\/span\x3e( 180, 100%, 50%, 0.7 ); }\n     \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.top\x3c\/span\x3e    { \x3cspan class=\x22hljs-attribute\x22\x3ebackground\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3ehsla\x3c\/span\x3e( 240, 100%, 50%, 0.7 ); }\n     \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.bottom\x3c\/span\x3e { \x3cspan class=\x22hljs-attribute\x22\x3ebackground\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3ehsla\x3c\/span\x3e( 300, 100%, 50%, 0.7 ); }\n\n\n     \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.front\x3c\/span\x3e  { \x3cspan class=\x22hljs-comment\x22\x3e\/*这个距离乘以2为前后面的距离*\/\x3c\/span\x3e\n         \x3cspan class=\x22hljs-attribute\x22\x3etransform\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3etranslateZ\x3c\/span\x3e( 50px );\n     }\n     \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.back\x3c\/span\x3e   { \x3cspan class=\x22hljs-comment\x22\x3e\/*front面沿着x轴旋转180度，做后面*\/\x3c\/span\x3e\n         \x3cspan class=\x22hljs-attribute\x22\x3etransform\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3erotateX\x3c\/span\x3e( -180deg ) \x3cspan class=\x22hljs-built_in\x22\x3etranslateZ\x3c\/span\x3e(  50px );\n     }\n     \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.right\x3c\/span\x3e {                 \x3cspan class=\x22hljs-comment\x22\x3e\/*这个距离乘以2为左右面的距离*\/\x3c\/span\x3e\n         \x3cspan class=\x22hljs-attribute\x22\x3etransform\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3erotateY\x3c\/span\x3e(   90deg ) \x3cspan class=\x22hljs-built_in\x22\x3etranslateZ\x3c\/span\x3e( 150px );\n     }\n     \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.left\x3c\/span\x3e {  \x3cspan class=\x22hljs-comment\x22\x3e\/*front面沿着y轴旋转90度，做侧面*\/\x3c\/span\x3e\n         \x3cspan class=\x22hljs-attribute\x22\x3etransform\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3erotateY\x3c\/span\x3e(  -90deg ) \x3cspan class=\x22hljs-built_in\x22\x3etranslateZ\x3c\/span\x3e( 150px );\n     }\n     \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.top\x3c\/span\x3e {                   \x3cspan class=\x22hljs-comment\x22\x3e\/*这个距离乘以2为长方体高*\/\x3c\/span\x3e\n         \x3cspan class=\x22hljs-attribute\x22\x3etransform\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3erotateX\x3c\/span\x3e(   90deg ) \x3cspan class=\x22hljs-built_in\x22\x3etranslateZ\x3c\/span\x3e( 100px );\n     }\n     \x3cspan class=\x22hljs-selector-id\x22\x3e#box\x3c\/span\x3e \x3cspan class=\x22hljs-selector-class\x22\x3e.bottom\x3c\/span\x3e { \x3cspan class=\x22hljs-comment\x22\x3e\/*front面沿着x轴旋转90度，做底面*\/\x3c\/span\x3e\n         \x3cspan class=\x22hljs-attribute\x22\x3etransform\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3erotateX\x3c\/span\x3e(  -90deg ) \x3cspan class=\x22hljs-built_in\x22\x3etranslateZ\x3c\/span\x3e( 100px );\n     }\n\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3estyle\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e对这样的css有什么要吐槽的么？\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3e这样的stylesheet简直是刀耕火种时期的\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3e如果用sass写法，那么只需要写一次#box和多层嵌套就可以了。\x3c\/p\x3e\n\x3cp\x3e效果如下：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000005990691\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000005990691\x22 alt=\x22这里写图片描述\x22 title=\x22这里写图片描述\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e如果我们使用webGL去绘制的话，导入一些现成的3D模型，无论物体还是人物，都可以360度无死角的玩弄于手掌了。\x3cbr\x3e（如果有苍老师的模型，想想还有点小激动呢，VR的感觉说来就来啊 - -）\x3c\/p\x3e\n\x3cp\x3e接下来就是等待来自手机端的旋转信息，x,y,z,angle，使#box进行transform旋转就是了。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22$seat.find(\x26quot;#box\x26quot;).\ncss(\x26quot;transform\x26quot;,\x26quot;rotate3d(\x26quot;\n\x2b (-parseFloat(content.x))\x2b\x26quot;,\x26quot;  \/\/取反\n\x2b (\x2bparseFloat(content.y))\x2b\x26quot;,\x26quot;\n\x2b (-parseFloat(content.z))\x2b\x26quot;,\x26quot;  \/\/取反\n\x2b content.rotate \x2b\x26quot;deg)\x26quot;); \n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e$seat.find(\x3cspan class=\x22hljs-string\x22\x3e\x22#box\x22\x3c\/span\x3e).\ncss(\x3cspan class=\x22hljs-string\x22\x3e\x22transform\x22\x3c\/span\x3e,\x3cspan class=\x22hljs-string\x22\x3e\x22rotate3d(\x22\x3c\/span\x3e\n\x2b (-\x3cspan class=\x22hljs-built_in\x22\x3eparseFloat\x3c\/span\x3e(content.x))\x2b\x3cspan class=\x22hljs-string\x22\x3e\x22,\x22\x3c\/span\x3e  \x3cspan class=\x22hljs-comment\x22\x3e\/\/取反\x3c\/span\x3e\n\x2b (\x2b\x3cspan class=\x22hljs-built_in\x22\x3eparseFloat\x3c\/span\x3e(content.y))\x2b\x3cspan class=\x22hljs-string\x22\x3e\x22,\x22\x3c\/span\x3e\n\x2b (-\x3cspan class=\x22hljs-built_in\x22\x3eparseFloat\x3c\/span\x3e(content.z))\x2b\x3cspan class=\x22hljs-string\x22\x3e\x22,\x22\x3c\/span\x3e  \x3cspan class=\x22hljs-comment\x22\x3e\/\/取反\x3c\/span\x3e\n\x2b content.rotate \x2b\x3cspan class=\x22hljs-string\x22\x3e\x22deg)\x22\x3c\/span\x3e); \n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e不取反的话，旋转是错误的。我曾多次尝试给不同的坐标取反，最终得出这个取反方法，是唯一显示正常的组合。\x3c\/p\x3e\n\x3cp\x3e无法理解这两个取反，猜测是因为css的x,y,z的坐标和物理设备x,y,z的坐标方向有差异吧。毕竟显示器是平面的，他的x,y,z的定义不能和手机传感器一致。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader10\x22\x3e\x3cstrong\x3e2.3 校准\x3c\/strong\x3e\x3c\/h3\x3e\n\x3cp\x3ePC端的校准就简单多了，在#box外套一层div.adjust。\x3cbr\x3e当接受来自手机端的校准信息 x,y,z,angle，设置外套的 div.adjust 的旋转为 x,y,z,-angle 就好了。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22$seat.find(\x26quot;.adjust\x26quot;).\ncss(\x26quot;transform\x26quot;,\x26quot;rotate3d(\x26quot;\n\x2b (-parseFloat(content.x))\x2b\x26quot;,\x26quot;  \n\x2b (\x2bparseFloat(content.y))\x2b\x26quot;,\x26quot;\n\x2b (-parseFloat(content.z))\x2b\x26quot;,\x26quot;  \n\x2b (-parseFloat(content.rotate)) \x2b\x26quot;deg)\x26quot;);  \/\/取反\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e$seat.find(\x3cspan class=\x22hljs-string\x22\x3e\x22.adjust\x22\x3c\/span\x3e).\ncss(\x3cspan class=\x22hljs-string\x22\x3e\x22transform\x22\x3c\/span\x3e,\x3cspan class=\x22hljs-string\x22\x3e\x22rotate3d(\x22\x3c\/span\x3e\n\x2b (-\x3cspan class=\x22hljs-built_in\x22\x3eparseFloat\x3c\/span\x3e(content.x))\x2b\x3cspan class=\x22hljs-string\x22\x3e\x22,\x22\x3c\/span\x3e  \n\x2b (\x2b\x3cspan class=\x22hljs-built_in\x22\x3eparseFloat\x3c\/span\x3e(content.y))\x2b\x3cspan class=\x22hljs-string\x22\x3e\x22,\x22\x3c\/span\x3e\n\x2b (-\x3cspan class=\x22hljs-built_in\x22\x3eparseFloat\x3c\/span\x3e(content.z))\x2b\x3cspan class=\x22hljs-string\x22\x3e\x22,\x22\x3c\/span\x3e  \n\x2b (-\x3cspan class=\x22hljs-built_in\x22\x3eparseFloat\x3c\/span\x3e(content.rotate)) \x2b\x3cspan class=\x22hljs-string\x22\x3e\x22deg)\x22\x3c\/span\x3e);  \x3cspan class=\x22hljs-comment\x22\x3e\/\/取反\x3c\/span\x3e\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e当然，这个adjust的样式至少包含以下样式\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22.adjust{\n  position: absolute;\n  transform-style:preserve-3d;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22css hljs\x22\x3e\x3ccode class=\x22css\x22\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.adjust\x3c\/span\x3e{\n  \x3cspan class=\x22hljs-attribute\x22\x3eposition\x3c\/span\x3e: absolute;\n  \x3cspan class=\x22hljs-attribute\x22\x3etransform-style\x3c\/span\x3e:preserve-\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3ed;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader11\x22\x3e\x3cstrong\x3e2.4 兼容性\x3c\/strong\x3e\x3c\/h3\x3e\n\x3cp\x3ePC端的兼容性就好多了，只要是现代H5浏览器基本上没有兼容性问题。\x3c\/p\x3e\n\x3chr\x3e\n\x3ch2 id=\x22articleHeader12\x22\x3e服务端\x3c\/h2\x3e\n\x3ch3 id=\x22articleHeader13\x22\x3e1.数据结构\x3c\/h3\x3e\n\x3cp\x3e这个服务只做临时数据的保存和消息转发。\x3cbr\x3e临时数据：比如，各端的webSocket连接句柄，房间信息等，我把它们放在global全局对象下，就好比是共享内存，访问方便，速度快。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22global.ShareMem = {\n  rooms:{\n       \x26quot;12345678\x26quot;:{          \/\/房间号做为key，方便查找\n         player:[{socket:connection,place:place}],          \/\/手机端数组：连接句柄，座位号\n         projector:[],       \/\/PC端数组\n         id:\x26quot;12345678\x26quot;,\n         startTime:Date.now(),\n         maxplayer:2,        \/\/最多座位数\n         type:\x26quot;ddd\x26quot;          \/\/房间类型\n       }\n  }\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs dts\x22\x3e\x3ccode class=\x22javascirpt\x22\x3eglobal.ShareMem = {\n\x3cspan class=\x22hljs-symbol\x22\x3e  rooms:\x3c\/span\x3e{\n       \x3cspan class=\x22hljs-string\x22\x3e\x2212345678\x22\x3c\/span\x3e:{          \x3cspan class=\x22hljs-comment\x22\x3e\/\/房间号做为key，方便查找\x3c\/span\x3e\n\x3cspan class=\x22hljs-symbol\x22\x3e         player:\x3c\/span\x3e[{socket:connection,place:place}],          \x3cspan class=\x22hljs-comment\x22\x3e\/\/手机端数组：连接句柄，座位号\x3c\/span\x3e\n\x3cspan class=\x22hljs-symbol\x22\x3e         projector:\x3c\/span\x3e[],       \x3cspan class=\x22hljs-comment\x22\x3e\/\/PC端数组\x3c\/span\x3e\n\x3cspan class=\x22hljs-symbol\x22\x3e         id:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x2212345678\x22\x3c\/span\x3e,\n\x3cspan class=\x22hljs-symbol\x22\x3e         startTime:\x3c\/span\x3eDate.now(),\n\x3cspan class=\x22hljs-symbol\x22\x3e         maxplayer:\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e,        \x3cspan class=\x22hljs-comment\x22\x3e\/\/最多座位数\x3c\/span\x3e\n\x3cspan class=\x22hljs-symbol\x22\x3e         type:\x3c\/span\x3e\x3cspan class=\x22hljs-string\x22\x3e\x22ddd\x22\x3c\/span\x3e          \x3cspan class=\x22hljs-comment\x22\x3e\/\/房间类型\x3c\/span\x3e\n       }\n  }\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader14\x22\x3e2.webServer\x3c\/h3\x3e\n\x3cp\x3e如果您是nodejs的大神，或者在用koajs、express等nodejs框架，请跳过本大节。因为我用原生的nodejs写了一遍webServer，虽然重复造轮子不好，但是复习复习webServer的基本知识，还是不错的，本节适合新手入门。\x3cbr\x3e包含知识点：header解析，静态文件查找，gzip，文件hash计算，状态码。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader15\x22\x3e2.1 目录结构\x3c\/h3\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/API\n    \/funMap.js            \/*http功能函数集合*\/\n    \/xxx.js\n\/socketAPI\n    \/funMap.js          \/*webSocket功能函数集合*\/\n    \/xxx.js\n\/Util                    \/*工具目录，获取本地IP，打开默认浏览器*\/\n\/webRoot\n    \/common             \/*公共资源目录*\/\n        \/js\n            \/lib\n        \/css\n    \/m                  \/*移动端html,js,css等*\/\n    \/p                  \/*PC端html,js,css等*\/\n\/index.js                  \/*入口文件*\/\n\/config.js                \/*配置文件，端口号，ws最大数据包大小等*\/\n\/socketServer.js        \/*webSocket处理函数*\/\n\/webServer.js           \n    \x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs stylus\x22\x3e\x3ccode\x3e\/API\n    \/funMap\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e            \x3cspan class=\x22hljs-comment\x22\x3e\/*http功能函数集合*\/\x3c\/span\x3e\n    \/xxx\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e\n\/socketAPI\n    \/funMap\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e          \x3cspan class=\x22hljs-comment\x22\x3e\/*webSocket功能函数集合*\/\x3c\/span\x3e\n    \/xxx\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e\n\/Util                    \x3cspan class=\x22hljs-comment\x22\x3e\/*工具目录，获取本地IP，打开默认浏览器*\/\x3c\/span\x3e\n\/webRoot\n    \/common             \x3cspan class=\x22hljs-comment\x22\x3e\/*公共资源目录*\/\x3c\/span\x3e\n        \/js\n            \/lib\n        \/css\n    \/m                  \x3cspan class=\x22hljs-comment\x22\x3e\/*移动端html,js,css等*\/\x3c\/span\x3e\n    \/\x3cspan class=\x22hljs-selector-tag\x22\x3ep\x3c\/span\x3e                  \x3cspan class=\x22hljs-comment\x22\x3e\/*PC端html,js,css等*\/\x3c\/span\x3e\n\/index\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e                  \x3cspan class=\x22hljs-comment\x22\x3e\/*入口文件*\/\x3c\/span\x3e\n\/config\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e                \x3cspan class=\x22hljs-comment\x22\x3e\/*配置文件，端口号，ws最大数据包大小等*\/\x3c\/span\x3e\n\/socketServer\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e        \x3cspan class=\x22hljs-comment\x22\x3e\/*webSocket处理函数*\/\x3c\/span\x3e\n\/webServer\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e           \n    \x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader16\x22\x3e2.2 webServer\x3c\/h3\x3e\n\x3cp\x3e基本规则是这样的，搭建静态服务器，静态资源正常读取返回，html文件用ejs渲染后返回。\x3c\/p\x3e\n\x3cp\x3e由于ejs的原因，html文件并没有被修改，但是渲染后的内容被修改，比如，更改了ws的端口，但是html文件没有修改。所以不能使用\x3ccode\x3eLast-Modified\x3c\/code\x3e来判断是文件是否最新，而是要根据返回内容有没有被改变来判断，所以要用\x3ccode\x3eEtag\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3eEtag需要根据内容算出hash值，一般用md5计算。\x3c\/p\x3e\n\x3cp\x3e返回内容之前，需要进行gzip压缩，用来节省带宽。90KB的jquery.min.js可以被gzip到30KB，压缩才是王道。\x3c\/p\x3e\n\x3cp\x3e因为手机端和PC端执行的是完全不同的代码，所以要判断从客户端传过来的\x3ccode\x3euser-agent\x3c\/code\x3e是否包含\x3ccode\x3eMobile\x3c\/code\x3e字符串，以来区分客户端是PC还是手机，以便返回正确的资源。\x3c\/p\x3e\n\x3cp\x3e通过简单的约定，来区分静态文件和REST请求\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    if (libPath.extname(pathName) == \x26quot;\x26quot;) {\n      \/\/如果路径没有扩展名 \n      if(params.length\x3c=2){\n        pathName \x2b= \x26quot;\/\x26quot;; \/\/访问根目录 \n      }else if(params[1]==\x26quot;api\x26quot;){   \/\/访问以api开头\n        parseAPI(params,req,res);  \/\/功能函数\n        return ;\n      }else{\n        pathName = params[1]\x2b\x26quot;.html\x26quot;;\n      }\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs cs\x22\x3e\x3ccode class=\x22javasciprt\x22\x3e    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (libPath.extname(pathName) == \x3cspan class=\x22hljs-string\x22\x3e\x22\x22\x3c\/span\x3e) {\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/如果路径没有扩展名 \x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3eparams\x3c\/span\x3e.length\x26lt;=\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e){\n        pathName \x2b= \x3cspan class=\x22hljs-string\x22\x3e\x22\/\x22\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/访问根目录 \x3c\/span\x3e\n      }\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eif\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eparams\x3c\/span\x3e[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e]==\x3cspan class=\x22hljs-string\x22\x3e\x22api\x22\x3c\/span\x3e\x3c\/span\x3e)\x3c\/span\x3e{   \x3cspan class=\x22hljs-comment\x22\x3e\/\/访问以api开头\x3c\/span\x3e\n        parseAPI(\x3cspan class=\x22hljs-keyword\x22\x3eparams\x3c\/span\x3e,req,res);  \x3cspan class=\x22hljs-comment\x22\x3e\/\/功能函数\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e ;\n      }\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e{\n        pathName = \x3cspan class=\x22hljs-keyword\x22\x3eparams\x3c\/span\x3e[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e]\x2b\x3cspan class=\x22hljs-string\x22\x3e\x22.html\x22\x3c\/span\x3e;\n      }\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我在这里做了一个简单的框架，在API目录或者socketAPI目录下新增js文件，一个js文件对应一个处理函数，然后在funMap.js中聚合为一个Map，方便查找函数，也容易隔离和修改函数名。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var funMap = {\n  \x26quot;room\x26quot;:require(\x26quot;.\/room\x26quot;),\n  \x26quot;changeName\x26quot;:require(\x26quot;.\/xxx\x26quot;),\n  \x26quot;changeName2\x26quot;:require(\x26quot;.\/xxxyyy\x26quot;)\n};\nmodule.exports = funMap;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e funMap = {\n  \x3cspan class=\x22hljs-string\x22\x3e\x22room\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22.\/room\x22\x3c\/span\x3e),\n  \x3cspan class=\x22hljs-string\x22\x3e\x22changeName\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22.\/xxx\x22\x3c\/span\x3e),\n  \x3cspan class=\x22hljs-string\x22\x3e\x22changeName2\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22.\/xxxyyy\x22\x3c\/span\x3e)\n};\n\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = funMap;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e客户端访问时就可以通过 \/api\/[functionName] 来访问想要的服务了。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader17\x22\x3e3 webSocketServer\x3c\/h3\x3e\n\x3cp\x3enodejs本身并没有提供webSockerServer的模块，所以需要另外安装一个。\x3c\/p\x3e\n\x3cp\x3e在npm install的时候会安装一个ws模块，require(\x22ws\x22) 就可以用了。用法与http模块相似，都用 \x3ccode\x3ecreateServer({options},MainHandlerFunction)\x3c\/code\x3e 创建服务，只是ws多了几个参数。\x3c\/p\x3e\n\x3cp\x3e主要是\x3ccode\x3eport\x3c\/code\x3e，注意不要和webserver端口重复。\x3cbr\x3e还有一个 \x3ccode\x3emaxPayload\x3c\/code\x3e 就是单个ws数据包最大大小，单位是bytes，自己估计项目传输数据时候数据包大小。默认值是65535 即 64KB。一般webSocket用于小包传输，不用太大，我设置了1024 , 1KB。\x3c\/p\x3e\n\x3cp\x3e主处理函数\x3ccode\x3eMainHandlerFunction\x3c\/code\x3e，在有客户端连接进来时会传入一个参数\x3ccode\x3econnection\x3c\/code\x3e,这个对象内容非常丰富，不看手册，可以打印出来也慢慢研究。\x3cbr\x3e成功建立连接的方法就是要\x3ccode\x3econnection\x3c\/code\x3e绑定\x3ccode\x3emessage\x3c\/code\x3e方法。\x3c\/p\x3e\n\x3cp\x3e由于wsSocket访问是可以带着url的，所以我们可以用url隔离不同的功能函数，而不是去解析message主体。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var connectHandler = function(connection){\n  \/\/ :4002\/api\/Function1 \n  var URIarray = connection.upgradeReq.url.split(\x26quot;\/\x26quot;)\n  if(funMap[URIarray[2]]){\n    funMap[URIarray[2]](connection);\n  }else{\n    connection.send(\x26quot;{err:Function Not Found!!}\x26quot;);\n  }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e connectHandler = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3econnection\x3c\/span\x3e)\x3c\/span\x3e{\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ :4002\/api\/Function1 \x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e URIarray = connection.upgradeReq.url.split(\x3cspan class=\x22hljs-string\x22\x3e\x22\/\x22\x3c\/span\x3e)\n  \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(funMap[URIarray[\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e]]){\n    funMap[URIarray[\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e]](connection);\n  }\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e{\n    connection.send(\x3cspan class=\x22hljs-string\x22\x3e\x22{err:Function Not Found!!}\x22\x3c\/span\x3e);\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader18\x22\x3e3.1 消息，广播，保活\x3c\/h3\x3e\n\x3cp\x3e每当有ws连接进来，都有类似文件描述符的id来区分每个不同的连接。\x3cbr\x3e\x3ccode\x3econnection._ultron.id\x3c\/code\x3e 用它可以区分自己与别人的连接，很有用。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/消息格式\nfunction msgPack(){\n  return JSON.stringify({\n    \x26quot;who\x26quot;:arguments[0],      \/\/ Mobile , PC\n    \x26quot;place\x26quot;:arguments[1],    \/\/ 座位\n    \x26quot;dowhat\x26quot;:arguments[2],   \/\/ \x26quot;connect\x26quot;,\x26quot;ready\x26quot;,\x26quot;message\x26quot;,\x26quot;lost\x26quot;\n    \x26quot;content\x26quot;:arguments[3]||\x26quot;\x26quot; \/\/ 内容\n  })\n} \n\n\/\/以room为单位广播，广播房间内所有角色\nfunction boradCast(room,msg,ignore){\n  room.projector.forEach(function(item,index){\n    if(ignore\x26amp;\x26amp;ignore._ultron.id===item.socket._ultron.id){\n      \/\/ console.log(\x26quot;ignore!!!\x26quot;)\n      \/\/ 忽略自己不发送给自己\n    }\n    else{\n      try{\n        item.socket.send(msg);\n      }catch(e){\n        console.log(e);\n      }\n    }\n  });\n  room.player.forEach(function(item,index){\n    if(ignore\x26amp;\x26amp;ignore._ultron.id===item.socket._ultron.id){\n      \/\/ console.log(\x26quot;ignore!!!\x26quot;)\n      \/\/ 忽略自己不发送给自己\n    }\n    else{\n      try{\n        item.socket.send(msg);\n      }catch(e){\n        console.log(e);\n      }\n    }\n  });\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/消息格式\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3emsgPack\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify({\n    \x3cspan class=\x22hljs-string\x22\x3e\x22who\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e],      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ Mobile , PC\x3c\/span\x3e\n    \x3cspan class=\x22hljs-string\x22\x3e\x22place\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e[\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e],    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 座位\x3c\/span\x3e\n    \x3cspan class=\x22hljs-string\x22\x3e\x22dowhat\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e[\x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e],   \x3cspan class=\x22hljs-comment\x22\x3e\/\/ \x22connect\x22,\x22ready\x22,\x22message\x22,\x22lost\x22\x3c\/span\x3e\n    \x3cspan class=\x22hljs-string\x22\x3e\x22content\x22\x3c\/span\x3e:\x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e[\x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e]||\x3cspan class=\x22hljs-string\x22\x3e\x22\x22\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 内容\x3c\/span\x3e\n  })\n} \n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/以room为单位广播，广播房间内所有角色\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eboradCast\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eroom,msg,ignore\x3c\/span\x3e)\x3c\/span\x3e{\n  room.projector.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eitem,index\x3c\/span\x3e)\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(ignore\x26amp;\x26amp;ignore._ultron.id===item.socket._ultron.id){\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ console.log(\x22ignore!!!\x22)\x3c\/span\x3e\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 忽略自己不发送给自己\x3c\/span\x3e\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e{\n        item.socket.send(msg);\n      }\x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(e){\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(e);\n      }\n    }\n  });\n  room.player.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eitem,index\x3c\/span\x3e)\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(ignore\x26amp;\x26amp;ignore._ultron.id===item.socket._ultron.id){\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ console.log(\x22ignore!!!\x22)\x3c\/span\x3e\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 忽略自己不发送给自己\x3c\/span\x3e\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e{\n        item.socket.send(msg);\n      }\x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(e){\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(e);\n      }\n    }\n  });\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e为了检查客户端是否掉线，在建立连接时手动加入保活机制，方法很简单：\x3cbr\x3e给客户端发送空消息时lastkeeplife为1，只要客户端返回任意消息，那么更新lastkeeplife为0，如果5秒之内，没有任何回复判定为掉线。\x3cbr\x3e如果客户端掉线，那么关闭连接，从连接池中移除。并广播掉线消息给房间内其他角色。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22  var keeplifeHandler = setInterval(function(){\n    if(lastkeeplife == 0){\n      connection.close();\n      connection.emit(\x26quot;close\x26quot;);\n      clearInterval(keeplifeHandler);\n    }\n    try{\n      lastkeeplife = 0;\n      connection.send(\x26quot;{}\x26quot;);\n    }catch(e){\n      console.log(\x26quot;keep live error! \x26quot;\x2b e \x2b\x26quot;\\n\\n\x26quot;);\n      connection.close();\n      connection.emit(\x26quot;close\x26quot;);\n      clearInterval(keeplifeHandler);\n    }\n  },5000)\n\n  connection.on(\x27close\x27,function(msg){\n      if(keeplifeHandler){  \/\/关闭保活循环\n        clearInterval(keeplifeHandler);\n      }\n      console.log(\x26quot;close!\x26quot;,roomid,place);\n      var room = global.ShareMem.rooms[roomid];\n      if(!room)\n        return;\n      \n      \/\/从连接池移除连接句柄\n      if(platform === PC){\n          room.projector.forEach(function(item,index){\n              if(item.socket === connection){\n                  room.projector.splice(index,1);\n                  return false;\n              }\n          })\n      }else{\n          room.player.forEach(function(item,index){\n              if(item.socket === connection){\n                  room.player.splice(index,1);\n                  return false;\n              }\n          })\n      }\n      \/\/发送掉线消息\n      boradCast( room, msgPack(platform,place,\x26quot;lost\x26quot;) , connection );\n  });\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e keeplifeHandler = setInterval(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(lastkeeplife == \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e){\n      connection.close();\n      connection.emit(\x3cspan class=\x22hljs-string\x22\x3e\x22close\x22\x3c\/span\x3e);\n      clearInterval(keeplifeHandler);\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e{\n      lastkeeplife = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e;\n      connection.send(\x3cspan class=\x22hljs-string\x22\x3e\x22{}\x22\x3c\/span\x3e);\n    }\x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e(e){\n      \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22keep live error! \x22\x3c\/span\x3e\x2b e \x2b\x3cspan class=\x22hljs-string\x22\x3e\x22\\n\\n\x22\x3c\/span\x3e);\n      connection.close();\n      connection.emit(\x3cspan class=\x22hljs-string\x22\x3e\x22close\x22\x3c\/span\x3e);\n      clearInterval(keeplifeHandler);\n    }\n  },\x3cspan class=\x22hljs-number\x22\x3e5000\x3c\/span\x3e)\n\n  connection.on(\x3cspan class=\x22hljs-string\x22\x3e\x27close\x27\x3c\/span\x3e,\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3emsg\x3c\/span\x3e)\x3c\/span\x3e{\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(keeplifeHandler){  \x3cspan class=\x22hljs-comment\x22\x3e\/\/关闭保活循环\x3c\/span\x3e\n        clearInterval(keeplifeHandler);\n      }\n      \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22close!\x22\x3c\/span\x3e,roomid,place);\n      \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e room = global.ShareMem.rooms[roomid];\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(!room)\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n      \n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/从连接池移除连接句柄\x3c\/span\x3e\n      \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(platform === PC){\n          room.projector.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eitem,index\x3c\/span\x3e)\x3c\/span\x3e{\n              \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(item.socket === connection){\n                  room.projector.splice(index,\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e);\n                  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n              }\n          })\n      }\x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e{\n          room.player.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eitem,index\x3c\/span\x3e)\x3c\/span\x3e{\n              \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(item.socket === connection){\n                  room.player.splice(index,\x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e);\n                  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e;\n              }\n          })\n      }\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/发送掉线消息\x3c\/span\x3e\n      boradCast( room, msgPack(platform,place,\x3cspan class=\x22hljs-string\x22\x3e\x22lost\x22\x3c\/span\x3e) , connection );\n  });\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eiOS设备如果锁屏，会发送断开信息给服务器，而安卓不会。想要断开链接，必须等到默认120秒超时后关闭。\x3cbr\x3ews初始化时并没有提供初始化timeout的配置。通过修改\x3cbr\x3ews._server.timeout = 1000;\/\/1秒超时 \x3cbr\x3e并不会生效。问题来了，怎么修改才能设置超时时间呢？\x3c\/p\x3e\n\x3cp\x3e目前只能用上述比较捉急的方法来及时断开掉线设备。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader19\x22\x3e最后\x3c\/h2\x3e\n\x3cp\x3e多屏互动已经不是新鲜的东西了，我做这个Demo还是受chrome实验室一个叫做\x3ca href=\x22https:\/\/lightsaber.withgoogle.com\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e【光剑出鞘】\x3c\/a\x3e的项目的启发。因为体验时需要手机端和PC同时翻-墙，导致体验差，然后自己才想做一个。做出来的时候感觉好酷炫，好神奇，好兴奋。\x3cbr\x3e后续还是有很多可以拓展和改进的，希望最终可以变为一个成熟的产品，而不是仅仅止步于Demo。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader20\x22\x3e相关阅读\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/blog.maxleap.cn\/archives\/705\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e无需Flash实现图片裁剪——HTML5中级进阶\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/blog.maxleap.cn\/archives\/512\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e5个提高Node.js应用性能的技巧\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/blog.maxleap.cn\/archives\/555\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e浏览器存储及使用\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3chr\x3e\n\x3cp\x3e\x3cstrong\x3e作者信息\x3c\/strong\x3e\x3cbr\x3e作者来自力谱宿云 LeapCloud 团队_UX成员：王诗诗 【原创】\x3cbr\x3e首发地址：\x3ca href=\x22https:\/\/blog.maxleap.cn\/archives\/985\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/blog.maxleap.cn\/archi...\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e王诗诗，前端新人，专职前端工作两年。曾供职于AMI做底层软件开发。喜欢分析H5代码，追崇用简单的CSS，构建精美动效，做前端之前，这些是业余爱好。现任职于MaxLeap UX 组，负责MaxWon 的开发和维护。现热衷于Real-time WebApp。\x3c\/p\x3e\n\x3cp\x3e欢迎关注微信订阅号：MaxLeap_yidongyanfa\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>多屏互动——H5 中级进阶</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000005988744">https://segmentfault.com/a/1190000005988744</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/c2ekhqxwtcj/" target="_blank">https://alili.tech/archive/c2ekhqxwtcj/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>