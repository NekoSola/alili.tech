<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="【PWA学习与实践】(5)在Web中进行服务端消息推送"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>【PWA学习与实践】(5)在Web中进行服务端消息推送 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/a2rlb5a200l/",
				"appid": "1613049289050283", 
				"title": "【PWA学习与实践】(5)在Web中进行服务端消息推送 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-15T02:30:44"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/1tiojscatsf/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/c4c6s3beftb/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fa2rlb5a200l%2f&text=%e3%80%90PWA%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5%e3%80%91%285%29%e5%9c%a8Web%e4%b8%ad%e8%bf%9b%e8%a1%8c%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fa2rlb5a200l%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fa2rlb5a200l%2f&text=%e3%80%90PWA%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5%e3%80%91%285%29%e5%9c%a8Web%e4%b8%ad%e8%bf%9b%e8%a1%8c%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fa2rlb5a200l%2f&title=%e3%80%90PWA%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5%e3%80%91%285%29%e5%9c%a8Web%e4%b8%ad%e8%bf%9b%e8%a1%8c%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fa2rlb5a200l%2f&is_video=false&description=%e3%80%90PWA%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5%e3%80%91%285%29%e5%9c%a8Web%e4%b8%ad%e8%bf%9b%e8%a1%8c%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e3%80%90PWA%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5%e3%80%91%285%29%e5%9c%a8Web%e4%b8%ad%e8%bf%9b%e8%a1%8c%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fa2rlb5a200l%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fa2rlb5a200l%2f&title=%e3%80%90PWA%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5%e3%80%91%285%29%e5%9c%a8Web%e4%b8%ad%e8%bf%9b%e8%a1%8c%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fa2rlb5a200l%2f&title=%e3%80%90PWA%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5%e3%80%91%285%29%e5%9c%a8Web%e4%b8%ad%e8%bf%9b%e8%a1%8c%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fa2rlb5a200l%2f&title=%e3%80%90PWA%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5%e3%80%91%285%29%e5%9c%a8Web%e4%b8%ad%e8%bf%9b%e8%a1%8c%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fa2rlb5a200l%2f&title=%e3%80%90PWA%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5%e3%80%91%285%29%e5%9c%a8Web%e4%b8%ad%e8%bf%9b%e8%a1%8c%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">【PWA学习与实践】(5)在Web中进行服务端消息推送</h1><div class="meta"><div class="postdate"><time datetime="2019-02-15" itemprop="datePublished">2019-02-15</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cblockquote\x3e《PWA学习与实践》系列文章已整理至\x3ca href=\x22https:\/\/alienzhou.gitbook.io\/learning-pwa\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3egitbook - PWA学习手册\x3c\/a\x3e，文字内容已同步至\x3ca href=\x22https:\/\/github.com\/alienzhou\/learning-pwa-ebook\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3elearning-pwa-ebook\x3c\/a\x3e。转载请注明作者与出处。\x3c\/blockquote\x3e\n\x3cp\x3e本文是\x3ca href=\x22https:\/\/juejin.im\/user\/59ad5377518825244d206d2d\/posts\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e《PWA学习与实践》\x3c\/a\x3e系列的第五篇文章。文中的代码都可以在\x3ca href=\x22https:\/\/github.com\/alienzhou\/learning-pwa\/tree\/push\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3elearning-pwa的push分支\x3c\/a\x3e上找到（\x3ccode\x3egit clone\x3c\/code\x3e后注意切换到push分支）。\x3c\/p\x3e\n\x3cp\x3ePWA作为时下最火热的技术概念之一，对提升Web应用的安全、性能和体验有着很大的意义，非常值得我们去了解与学习。对PWA感兴趣的朋友欢迎关注《PWA学习与实践》系列文章。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3e1. 引言\x3c\/h2\x3e\n\x3cp\x3e在之前的几篇文章中，我和大家分享了如何使用manifest（以及meta标签）让你的Web App更加“native”；以及如何使用Service Worker来cache资源，加速Web App的访问速度，提供部分离线功能。在接下来的内容里，我们会探究PWA中的另一个重要功能——消息推送与提醒（Push \x26amp; Notification）。这个能力让我们可以从服务端向用户推送各类消息并引导用户触发相应交互。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/user-gold-cdn.xitu.io\/2018\/4\/13\/162bc97ba69e1679?w=1284\x26amp;h=746\x26amp;f=gif\x26amp;s=1843125\x22 src=\x22https:\/\/static.alili.techhttps:\/\/user-gold-cdn.xitu.io\/2018\/4\/13\/162bc97ba69e1679?w=1284\x26amp;h=746\x26amp;f=gif\x26amp;s=1843125\x22 alt=\x22Web Push效果\x22 title=\x22Web Push效果\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e实际上，消息推送与提醒是两个功能——Push API 和 Notification API。为了大家能够更好理解其中的相关技术，我也会分为Push（推送消息）与Notification（展示提醒）两部分来介绍。在这一篇里，我们先来学习如何使用Push API进行消息推送。\x3c\/p\x3e\n\x3cblockquote\x3ePush API 和 Notification API其实是两个独立的技术，完全可以分开使用；不过Push API 和 Notification API相结合是一个常见的模式。\x3c\/blockquote\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e2. 浏览器是如何实现服务器消息Push的\x3c\/h2\x3e\n\x3cp\x3eWeb Push的整个流程相较之前的内容来说有些复杂。因此，在进入具体技术细节之前，我们需要先了解一下整个Push的基本流程与相关概念。\x3c\/p\x3e\n\x3cp\x3e如果你对Push完全不了解，可能会认为，Push是我们的服务端直接与浏览器进行交互，使用长连接、WebSocket或是其他技术手段来向客户端推送消息。然而，这里的Web Push并非如此，它其实是一个三方交互的过程。\x3c\/p\x3e\n\x3cp\x3e在Push中登场的三个重要“角色”分别是：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e浏览器：就是我们的客户端\x3c\/li\x3e\n\x3cli\x3ePush Service：专门的Push服务，你可以认为是一个第三方服务，目前chrome与firefox都有自己的Push Service Service。理论上只要浏览器支持，可以使用任意的Push Service\x3c\/li\x3e\n\x3cli\x3e后端服务：这里就是指我们自己的后端服务\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e下面就介绍一下这三者在Web Push中是如何交互。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3e2.1. 消息推送流程\x3c\/h3\x3e\n\x3cp\x3e下图来自\x3ca href=\x22https:\/\/tools.ietf.org\/html\/draft-ietf-webpush-protocol-12\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eWeb Push协议草案\x3c\/a\x3e，是Web Push的整个流程：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    \x2b-------\x2b           \x2b--------------\x2b       \x2b-------------\x2b\n    |  UA   |           | Push Service |       | Application |\n    \x2b-------\x2b           \x2b--------------\x2b       |   Server    |\n        |                      |               \x2b-------------\x2b\n        |      Subscribe       |                      |\n        |---------------------\x3e|                      |\n        |       Monitor        |                      |\n        |\x3c====================\x3e|                      |\n        |                      |                      |\n        |          Distribute Push Resource           |\n        |--------------------------------------------\x3e|\n        |                      |                      |\n        :                      :                      :\n        |                      |     Push Message     |\n        |    Push Message      |\x3c---------------------|\n        |\x3c---------------------|                      |\n        |                      |                      |\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs gherkin\x22\x3e\x3ccode\x3e    \x2b-------\x2b           \x2b--------------\x2b       \x2b-------------\x2b\n    |\x3cspan class=\x22hljs-string\x22\x3e  UA   \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e           \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e Push Service \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e       \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e Application \x3c\/span\x3e|\n    \x2b-------\x2b           \x2b--------------\x2b       |\x3cspan class=\x22hljs-string\x22\x3e   Server    \x3c\/span\x3e|\n        |\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e               \x2b-------------\x2b\n        \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e      Subscribe       \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\n        |\x3cspan class=\x22hljs-string\x22\x3e---------------------\x26gt;\x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\n        |\x3cspan class=\x22hljs-string\x22\x3e       Monitor        \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\n        |\x3cspan class=\x22hljs-string\x22\x3e\x26lt;====================\x26gt;\x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\n        |\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\n        |\x3cspan class=\x22hljs-string\x22\x3e          Distribute Push Resource           \x3c\/span\x3e|\n        |\x3cspan class=\x22hljs-string\x22\x3e--------------------------------------------\x26gt;\x3c\/span\x3e|\n        |\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\n        :                      :                      :\n        |\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e     Push Message     \x3c\/span\x3e|\n        |\x3cspan class=\x22hljs-string\x22\x3e    Push Message      \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e\x26lt;---------------------\x3c\/span\x3e|\n        |\x3cspan class=\x22hljs-string\x22\x3e\x26lt;---------------------\x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\n        |\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\x3cspan class=\x22hljs-string\x22\x3e                      \x3c\/span\x3e|\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e该时序图表明了Web Push的各个步骤，我们可以将其分为订阅（subscribe）与推送（push）两部分来看。\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\n\x3cp\x3e\x3cstrong\x3esubscribe\x3c\/strong\x3e，首先是订阅：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3eAsk Permission：这一步不再上图的流程中，这其实是浏览器中的策略。浏览器会询问用户是否允许通知，只有在用户允许后，才能进行后面的操作。\x3c\/li\x3e\n\x3cli\x3eSubscribe：浏览器（客户端）需要向Push Service发起订阅（subscribe），订阅后会得到一个\x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/API\/PushSubscription\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e\x3ccode\x3ePushSubscription\x3c\/code\x3e\x3c\/a\x3e对象\x3c\/li\x3e\n\x3cli\x3eMonitor：订阅操作会和Push Service进行通信，生成相应的订阅信息，Push Service会维护相应信息，并基于此保持与客户端的联系；\x3c\/li\x3e\n\x3cli\x3eDistribute Push Resource：浏览器订阅完成后，会获取订阅的相关信息（存在于\x3ccode\x3ePushSubscription\x3c\/code\x3e对象中），我们需要将这些信息发送到自己的服务端，在服务端进行保存。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/user-gold-cdn.xitu.io\/2018\/4\/12\/162ba587f2a42eca?w=832\x26amp;h=207\x26amp;f=png\x26amp;s=28689\x22 src=\x22https:\/\/static.alili.techhttps:\/\/user-gold-cdn.xitu.io\/2018\/4\/12\/162ba587f2a42eca?w=832\x26amp;h=207\x26amp;f=png\x26amp;s=28689\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\n\x3cp\x3e\x3cstrong\x3ePush Message\x3c\/strong\x3e，然后是推送：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3ePush Message阶段一：我们的服务端需要推送消息时，不直接和客户端交互，而是通过Web Push协议，将相关信息通知Push Service；\x3c\/li\x3e\n\x3cli\x3ePush Message阶段二：Push Service收到消息，通过校验后，基于其维护的客户端信息，将消息推送给订阅了的客户端；\x3c\/li\x3e\n\x3cli\x3e最后，客户端收到消息，完成整个推送过程。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/user-gold-cdn.xitu.io\/2018\/4\/12\/162ba59261481104?w=817\x26amp;h=218\x26amp;f=png\x26amp;s=31789\x22 src=\x22https:\/\/static.alili.techhttps:\/\/user-gold-cdn.xitu.io\/2018\/4\/12\/162ba59261481104?w=817\x26amp;h=218\x26amp;f=png\x26amp;s=31789\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e2.2. 什么是Push Service\x3c\/h3\x3e\n\x3cp\x3e在上面的Push流程中，出现了一个比较少接触到的角色：Push Service。那么什么是Push Service呢？\x3c\/p\x3e\n\x3cblockquote\x3eA push service receives a network request, validates it and delivers a push message to the appropriate browser.\x3c\/blockquote\x3e\n\x3cp\x3ePush Service可以接收网络请求，校验该请求并将其推送给合适的浏览器客户端。Push Service还有一个非常重要的功能：当用户离线时，可以帮我们保存消息队列，直到用户联网后再发送给他们。\x3c\/p\x3e\n\x3cp\x3e目前，不同的浏览器厂商使用了不同的Push Service。例如，chrome使用了google自家的FCM（前身为GCM），firefox也是使用自家的服务。那么我们是否需要写不同的代码来兼容不同的浏览器所使用的服务呢？答案是并不用。Push Service遵循\x3ca href=\x22https:\/\/tools.ietf.org\/html\/draft-ietf-webpush-protocol-12\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eWeb Push Protocol\x3c\/a\x3e，其规定了请求及其处理的各种细节，这就保证了，不同的Push Service也会具有标准的调用方式。\x3c\/p\x3e\n\x3cp\x3e这里再提一点：我们在上一节中说了Push的标准流程，其中第一步就是浏览器发起订阅，生成一个\x3ccode\x3ePushSubscription\x3c\/code\x3e对。Push Service会为每个发起订阅的浏览器生成一个唯一的URL，这样，我们在服务端推送消息时，向这个URL进行推送后，Push Service就会知道要通知哪个浏览器。而这个URL信息也在\x3ccode\x3ePushSubscription\x3c\/code\x3e对象里，叫做\x3ccode\x3eendpoint\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/user-gold-cdn.xitu.io\/2018\/4\/14\/162bfd2d499ba656?w=1408\x26amp;h=300\x26amp;f=png\x26amp;s=86505\x22 src=\x22https:\/\/static.alili.techhttps:\/\/user-gold-cdn.xitu.io\/2018\/4\/14\/162bfd2d499ba656?w=1408\x26amp;h=300\x26amp;f=png\x26amp;s=86505\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e那么，如果我们知道了\x3ccode\x3eendpoint\x3c\/code\x3e的值，是否就代表我们可以向客户端推送消息了呢？并非如此。下面会简单介绍一下Web Push中的安全策略。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e2.3. 如何保证Push的安全性\x3c\/h3\x3e\n\x3cp\x3e在Web Push中，为了保证客户端只会收到其订阅的服务端推送的消息（其他的服务端即使在拿到\x3ccode\x3eendpoint\x3c\/code\x3e也无法推送消息），需要对推送信息进行数字签名。该过程大致如下：\x3c\/p\x3e\n\x3cp\x3e在Web Push中会有一对公钥与私钥。客户端持有公钥，而服务端持有私钥。客户端在订阅时，会将公钥发送给Push Service，而Push Service会将该公钥与相应的\x3ccode\x3eendpoint\x3c\/code\x3e维护起来。而当服务端要推送消息时，会使用私钥对发送的数据进行数字签名，并根据数字签名生成一个叫】\x3ccode\x3eAuthorization\x3c\/code\x3e请求头。Push Service收到请求后，根据\x3ccode\x3eendpoint\x3c\/code\x3e取到公钥，对数字签名解密验证，如果信息相符则表明该请求是通过对应的私钥加密而成，也表明该请求来自浏览器所订阅的服务端。反之亦然。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/user-gold-cdn.xitu.io\/2018\/4\/12\/162ba68f0d4a5861?w=998\x26amp;h=441\x26amp;f=png\x26amp;s=83966\x22 src=\x22https:\/\/static.alili.techhttps:\/\/user-gold-cdn.xitu.io\/2018\/4\/12\/162ba68f0d4a5861?w=998\x26amp;h=441\x26amp;f=png\x26amp;s=83966\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e而公钥与私钥如何生成，会在第三部分的实例中讲解。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader5\x22\x3e3. 如何使用Push API来推送向用户推送信息\x3c\/h2\x3e\n\x3cp\x3e到这里，我们已经基本了解了Web Push的流程。光说不练假把式，下面我就通过具体代码来说明如何使用Web Push。\x3c\/p\x3e\n\x3cp\x3e这部分会基于\x3ca href=\x22https:\/\/github.com\/alienzhou\/learning-pwa\/tree\/sw-cache\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3esw-cache\x3c\/a\x3e分支上的代码，继续增强我们的“图书搜索”WebApp。\x3c\/p\x3e\n\x3cp\x3e为了使文章与代码更清晰，将Web Push分为这几个部分：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e浏览器发起订阅，并将订阅信息发送至后端；\x3c\/li\x3e\n\x3cli\x3e将订阅信息保存在服务端，以便今后推送使用；\x3c\/li\x3e\n\x3cli\x3e服务端推送消息，向Push Service发起请求；\x3c\/li\x3e\n\x3cli\x3e浏览器接收Push信息并处理。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cblockquote\x3e友情提醒：由于Chrome所依赖的Push Service——FCM在国内不可访问，所以要正常运行demo中的代码需要“梯子”，或者可以选择Firefox来进行测试。\x3c\/blockquote\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3e3.1. 浏览器（客户端）生成subscription信息\x3c\/h3\x3e\n\x3cp\x3e首先，我们需要使用\x3ccode\x3ePushManager\x3c\/code\x3e的\x3ccode\x3esubscribe\x3c\/code\x3e方法来在浏览器中进行订阅。\x3c\/p\x3e\n\x3cp\x3e在\x3ca href=\x22https:\/\/juejin.im\/post\/5aca14b6f265da237c692e6f\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e《让你的WebApp离线可用》\x3c\/a\x3e中我们已经知道了如何注册Service Worker。当我们注册完Service Worker后会得到一个\x3ccode\x3eRegistration\x3c\/code\x3e对象，通过调用\x3ccode\x3eRegistration\x3c\/code\x3e对象的\x3ccode\x3eregistration.pushManager.subscribe()\x3c\/code\x3e方法可以发起订阅。\x3c\/p\x3e\n\x3cp\x3e为了使代码更清晰，本篇demo在之前的基础上，先抽离出Service Worker的注册方法：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ index.js\nfunction registerServiceWorker(file) {\n    return navigator.serviceWorker.register(file);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ index.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eregisterServiceWorker\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3efile\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e navigator.serviceWorker.register(file);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e然后定义了\x3ccode\x3esubscribeUserToPush()\x3c\/code\x3e方法来发起订阅：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ index.js\nfunction subscribeUserToPush(registration, publicKey) {\n    var subscribeOptions = {\n        userVisibleOnly: true,\n        applicationServerKey: window.urlBase64ToUint8Array(publicKey)\n    }; \n    return registration.pushManager.subscribe(subscribeOptions).then(function (pushSubscription) {\n        console.log(\x27Received PushSubscription: \x27, JSON.stringify(pushSubscription));\n        return pushSubscription;\n    });\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ index.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esubscribeUserToPush\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eregistration, publicKey\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e subscribeOptions = {\n        \x3cspan class=\x22hljs-attr\x22\x3euserVisibleOnly\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3eapplicationServerKey\x3c\/span\x3e: \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.urlBase64ToUint8Array(publicKey)\n    }; \n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e registration.pushManager.subscribe(subscribeOptions).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3epushSubscription\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27Received PushSubscription: \x27\x3c\/span\x3e, \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(pushSubscription));\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e pushSubscription;\n    });\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这里使用了\x3ccode\x3eregistration.pushManager.subscribe()\x3c\/code\x3e方法中的两个配置参数：\x3ccode\x3euserVisibleOnly\x3c\/code\x3e和\x3ccode\x3eapplicationServerKey\x3c\/code\x3e。\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\n\x3ccode\x3euserVisibleOnly\x3c\/code\x3e表明该推送是否需要显性地展示给用户，即推送时是否会有消息提醒。如果没有消息提醒就表明是进行“静默”推送。在Chrome中，必须要将其设置为\x3ccode\x3etrue\x3c\/code\x3e，否则浏览器就会在控制台报错：\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/user-gold-cdn.xitu.io\/2018\/4\/13\/162ba99a6b69af03?w=1458\x26amp;h=120\x26amp;f=png\x26amp;s=58047\x22 src=\x22https:\/\/static.alili.techhttps:\/\/user-gold-cdn.xitu.io\/2018\/4\/13\/162ba99a6b69af03?w=1458\x26amp;h=120\x26amp;f=png\x26amp;s=58047\x22 alt=\x22userVisibleOnly不为true时的报错信息\x22 title=\x22userVisibleOnly不为true时的报错信息\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cul\x3e\x3cli\x3e\n\x3ccode\x3eapplicationServerKey\x3c\/code\x3e是一个客户端的公钥，\x3ca href=\x22https:\/\/tools.ietf.org\/html\/draft-thomson-webpush-vapid-02\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eVAPID\x3c\/a\x3e定义了其规范，因此也可以称为VAPID keys。如果你还记得2.3中提到的安全策略，应该对这个公钥不陌生。该参数需要Unit8Array类型。因此定义了一个\x3ca href=\x22https:\/\/github.com\/alienzhou\/learning-pwa\/blob\/push\/public\/base64util.js\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e\x3ccode\x3eurlBase64ToUint8Array\x3c\/code\x3e\x3c\/a\x3e方法将base64的公钥字符串转为Unit8Array。\x3ccode\x3esubscribe()\x3c\/code\x3e也是一个Promise方法，在then中我们可以得到订阅的相关信息——一个\x3ccode\x3ePushSubscription\x3c\/code\x3e对象。下图展示了这个对象中的一些信息。注意其中的\x3ccode\x3eendpoint\x3c\/code\x3e，Push Service会为每个客户端随机生成一个不同的值.\x3c\/li\x3e\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/user-gold-cdn.xitu.io\/2018\/4\/14\/162bfd2d499ba656?w=1408\x26amp;h=300\x26amp;f=png\x26amp;s=86505\x22 src=\x22https:\/\/static.alili.techhttps:\/\/user-gold-cdn.xitu.io\/2018\/4\/14\/162bfd2d499ba656?w=1408\x26amp;h=300\x26amp;f=png\x26amp;s=86505\x22 alt=\x22PushSubscription信息\x22 title=\x22PushSubscription信息\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e之后，我们再将\x3ccode\x3ePushSubscription\x3c\/code\x3e信息发送到后端。这里定义了一个\x3ccode\x3esendSubscriptionToServer()\x3c\/code\x3e方法，该方法就是一个普通的XHR请求，会向接口post订阅信息，为了节约篇幅就不列出具体代码了。\x3c\/p\x3e\n\x3cp\x3e最后，将这一系列方法组合在一起。当然，使用Web Push前，还是需要进行特性检测\x3ccode\x3e\x27PushManager\x27 in window\x3c\/code\x3e。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ index.js\nif (\x27serviceWorker\x27 in navigator \x26amp;\x26amp; \x27PushManager\x27 in window) {\n    var publicKey = \x27BOEQSjdhorIf8M0XFNlwohK3sTzO9iJwvbYU-fuXRF0tvRpPPMGO6d_gJC_pUQwBT7wD8rKutpNTFHOHN3VqJ0A\x27;\n    \/\/ 注册service worker\n    registerServiceWorker(\x27.\/sw.js\x27).then(function (registration) {\n        console.log(\x27Service Worker 注册成功\x27);\n        \/\/ 开启该客户端的消息推送订阅功能\n        return subscribeUserToPush(registration, publicKey);\n    }).then(function (subscription) {\n        var body = {subscription: subscription};\n        \/\/ 为了方便之后的推送，为每个客户端简单生成一个标识\n        body.uniqueid = new Date().getTime();\n        console.log(\x27uniqueid\x27, body.uniqueid);\n        \/\/ 将生成的客户端订阅信息存储在自己的服务器上\n        return sendSubscriptionToServer(JSON.stringify(body));\n    }).then(function (res) {\n        console.log(res);\n    }).catch(function (err) {\n        console.log(err);\n    });\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ index.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-string\x22\x3e\x27serviceWorker\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e navigator \x26amp;\x26amp; \x3cspan class=\x22hljs-string\x22\x3e\x27PushManager\x27\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ein\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e) {\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e publicKey = \x3cspan class=\x22hljs-string\x22\x3e\x27BOEQSjdhorIf8M0XFNlwohK3sTzO9iJwvbYU-fuXRF0tvRpPPMGO6d_gJC_pUQwBT7wD8rKutpNTFHOHN3VqJ0A\x27\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 注册service worker\x3c\/span\x3e\n    registerServiceWorker(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/sw.js\x27\x3c\/span\x3e).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eregistration\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27Service Worker 注册成功\x27\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 开启该客户端的消息推送订阅功能\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e subscribeUserToPush(registration, publicKey);\n    }).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3esubscription\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e body = {\x3cspan class=\x22hljs-attr\x22\x3esubscription\x3c\/span\x3e: subscription};\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 为了方便之后的推送，为每个客户端简单生成一个标识\x3c\/span\x3e\n        body.uniqueid = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e().getTime();\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27uniqueid\x27\x3c\/span\x3e, body.uniqueid);\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 将生成的客户端订阅信息存储在自己的服务器上\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e sendSubscriptionToServer(\x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(body));\n    }).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eres\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(res);\n    }).catch(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(err);\n    });\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e注意，这里为了方便我们后面的推送，为每个客户端生成了一个唯一ID\x3ccode\x3euniqueid\x3c\/code\x3e，这里使用了时间戳生成简单的\x3ccode\x3euniqueid\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e此外，由于\x3ccode\x3euserVisibleOnly\x3c\/code\x3e为\x3ccode\x3etrue\x3c\/code\x3e，所以需要用户授权开启通知权限，因此我们会看到下面的提示框，选择“允许”即可。你可以在设置中进行通知的管理。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/user-gold-cdn.xitu.io\/2018\/4\/12\/162ba85304cba1f5?w=724\x26amp;h=340\x26amp;f=png\x26amp;s=39311\x22 src=\x22https:\/\/static.alili.techhttps:\/\/user-gold-cdn.xitu.io\/2018\/4\/12\/162ba85304cba1f5?w=724\x26amp;h=340\x26amp;f=png\x26amp;s=39311\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader7\x22\x3e3.2. 服务端存储客户端subscription信息\x3c\/h3\x3e\n\x3cp\x3e为了存储浏览器post来的订阅信息，服务端需要增加一个接口\x3ccode\x3e\/subscription\x3c\/code\x3e，同时添加中间件\x3ccode\x3ekoa-body\x3c\/code\x3e用于处理body\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ app.js\nconst koaBody = require(\x27koa-body\x27);\n\/**\n * 提交subscription信息，并保存\n *\/\nrouter.post(\x27\/subscription\x27, koaBody(), async ctx =\x3e {\n    let body = ctx.request.body;\n    await util.saveRecord(body);\n    ctx.response.body = {\n        status: 0\n    };\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ app.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e koaBody = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa-body\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * 提交subscription信息，并保存\n *\/\x3c\/span\x3e\nrouter.post(\x3cspan class=\x22hljs-string\x22\x3e\x27\/subscription\x27\x3c\/span\x3e, koaBody(), \x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e ctx =\x26gt; {\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e body = ctx.request.body;\n    \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e util.saveRecord(body);\n    ctx.response.body = {\n        \x3cspan class=\x22hljs-attr\x22\x3estatus\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e\n    };\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e接收到subscription信息后，需要在服务端进行保存，你可使用任何方式来保存它：mysql、redis、mongodb……这里为了方便，我使用了\x3ca href=\x22https:\/\/github.com\/louischatriot\/nedb\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3enedb\x3c\/a\x3e来进行简单的存储。nedb不需要部署安装，可以将数据存储在内存中，也可以持久化，nedb的api和mongodb也比较类似。\x3c\/p\x3e\n\x3cp\x3e这里\x3ccode\x3eutil.saveRecord()\x3c\/code\x3e做了这些工作：首先，查询\x3ccode\x3esubscription\x3c\/code\x3e信息是否存在，若已存在则只更新\x3ccode\x3euniqueid\x3c\/code\x3e；否则，直接进行存储。\x3c\/p\x3e\n\x3cp\x3e至此，我们就将客户端的订阅信息存储完毕了。现在，就可以等待今后推送时使用。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3e3.3. 使用subscription信息推送信息\x3c\/h3\x3e\n\x3cp\x3e在实际中，我们一般会给运营或产品同学提供一个推送配置后台。可以选择相应的客户端，填写推送信息，并发起推送。为了简单起见，我并没有写一个推送配置后台，而只提供了一个post接口\x3ccode\x3e\/push\x3c\/code\x3e来提交推送信息。后期我们完全可以开发相应的推送后台来调用该接口。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ app.js\n\/**\n * 消息推送API，可以在管理后台进行调用\n * 本例子中，可以直接post一个请求来查看效果\n *\/\nrouter.post(\x27\/push\x27, koaBody(), async ctx =\x3e {\n    let {uniqueid, payload} = ctx.request.body;\n    let list = uniqueid ? await util.find({uniqueid}) : await util.findAll();\n    let status = list.length \x3e 0 ? 0 : -1;\n\n    for (let i = 0; i \x3c list.length; i\x2b\x2b) {\n        let subscription = list[i].subscription;\n        pushMessage(subscription, JSON.stringify(payload));\n    }\n\n    ctx.response.body = {\n        status\n    };\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ app.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * 消息推送API，可以在管理后台进行调用\n * 本例子中，可以直接post一个请求来查看效果\n *\/\x3c\/span\x3e\nrouter.post(\x3cspan class=\x22hljs-string\x22\x3e\x27\/push\x27\x3c\/span\x3e, koaBody(), \x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e ctx =\x26gt; {\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e {uniqueid, payload} = ctx.request.body;\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e list = uniqueid ? \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e util.find({uniqueid}) : \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e util.findAll();\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e status = list.length \x26gt; \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e ? \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e : \x3cspan class=\x22hljs-number\x22\x3e-1\x3c\/span\x3e;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; list.length; i\x2b\x2b) {\n        \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e subscription = list[i].subscription;\n        pushMessage(subscription, \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(payload));\n    }\n\n    ctx.response.body = {\n        status\n    };\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e来看一下\x3ccode\x3e\/push\x3c\/code\x3e接口。\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e首先，根据post的参数不同，我们可以通过\x3ccode\x3euniqueid\x3c\/code\x3e来查询某条订阅信息：\x3ccode\x3eutil.find({uniqueid})\x3c\/code\x3e；也可以从数据库中查询出所有订阅信息：\x3ccode\x3eutil.findAll()\x3c\/code\x3e。\x3c\/li\x3e\n\x3cli\x3e然后通过\x3ccode\x3epushMessage()\x3c\/code\x3e方法向Push Service发送请求。根据第二节的介绍，我们知道，该请求需要符合Web Push协议。然而，Web Push协议的请求封装、加密处理相关操作非常繁琐。因此，Web Push为各种语言的开发者提供了一系列对应的库：\x3ca href=\x22https:\/\/github.com\/web-push-libs\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eWeb Push Libaray\x3c\/a\x3e，目前有NodeJS、PHP、Python、Java等。把这些复杂而繁琐的操作交给它们可以让我们事半功倍。\x3c\/li\x3e\n\x3cli\x3e最后返回结果，这里只是简单的根据是否有订阅信息来进行返回。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e安装node版web-push\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22npm install web-push --save\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22bash hljs\x22\x3e\x3ccode class=\x22bash\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3enpm install web-push --save\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e前面我们提到的公钥与私钥，也可以通过web-push来生成\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/user-gold-cdn.xitu.io\/2018\/4\/13\/162badb18824ff12?w=644\x26amp;h=159\x26amp;f=png\x26amp;s=26820\x22 src=\x22https:\/\/static.alili.techhttps:\/\/user-gold-cdn.xitu.io\/2018\/4\/13\/162badb18824ff12?w=644\x26amp;h=159\x26amp;f=png\x26amp;s=26820\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e使用web-push非常简单，首先设置VAPID keys：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ app.js\nconst webpush = require(\x27web-push\x27);\n\/**\n * VAPID值\n * 这里可以替换为你业务中实际的值\n *\/\nconst vapidKeys = {\n    publicKey: \x27BOEQSjdhorIf8M0XFNlwohK3sTzO9iJwvbYU-fuXRF0tvRpPPMGO6d_gJC_pUQwBT7wD8rKutpNTFHOHN3VqJ0A\x27,\n    privateKey: \x27TVe_nJlciDOn130gFyFYP8UiGxxWd3QdH6C5axXpSgM\x27\n};\n\n\/\/ 设置web-push的VAPID值\nwebpush.setVapidDetails(\n    \x27mailto:alienzhou16@163.com\x27,\n    vapidKeys.publicKey,\n    vapidKeys.privateKey\n);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ app.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e webpush = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27web-push\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * VAPID值\n * 这里可以替换为你业务中实际的值\n *\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e vapidKeys = {\n    \x3cspan class=\x22hljs-attr\x22\x3epublicKey\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27BOEQSjdhorIf8M0XFNlwohK3sTzO9iJwvbYU-fuXRF0tvRpPPMGO6d_gJC_pUQwBT7wD8rKutpNTFHOHN3VqJ0A\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-attr\x22\x3eprivateKey\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27TVe_nJlciDOn130gFyFYP8UiGxxWd3QdH6C5axXpSgM\x27\x3c\/span\x3e\n};\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 设置web-push的VAPID值\x3c\/span\x3e\nwebpush.setVapidDetails(\n    \x3cspan class=\x22hljs-string\x22\x3e\x27mailto:alienzhou16@163.com\x27\x3c\/span\x3e,\n    vapidKeys.publicKey,\n    vapidKeys.privateKey\n);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e设置完成后即可使用\x3ccode\x3ewebpush.sendNotification()\x3c\/code\x3e方法向Push Service发起请求。\x3c\/p\x3e\n\x3cp\x3e最后我们来看下\x3ccode\x3epushMessage()\x3c\/code\x3e方法的细节：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ app.js\n\/**\n * 向push service推送信息\n * @param {*} subscription \n * @param {*} data \n *\/\nfunction pushMessage(subscription, data = {}) {\n    webpush.sendNotification(subscription, data, options).then(data =\x3e {\n        console.log(\x27push service的相应数据:\x27, JSON.stringify(data));\n        return;\n    }).catch(err =\x3e {\n        \/\/ 判断状态码，440和410表示失效\n        if (err.statusCode === 410 || err.statusCode === 404) {\n            return util.remove(subscription);\n        }\n        else {\n            console.log(subscription);\n            console.log(err);\n        }\n    })\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ app.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-comment\x22\x3e\/**\n * 向push service推送信息\n * @param {*} subscription \n * @param {*} data \n *\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3epushMessage\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3esubscription, data = {}\x3c\/span\x3e) \x3c\/span\x3e{\n    webpush.sendNotification(subscription, data, options).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3edata\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27push service的相应数据:\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(data));\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n    }).catch(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eerr\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 判断状态码，440和410表示失效\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (err.statusCode === \x3cspan class=\x22hljs-number\x22\x3e410\x3c\/span\x3e || err.statusCode === \x3cspan class=\x22hljs-number\x22\x3e404\x3c\/span\x3e) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e util.remove(subscription);\n        }\n        \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n            \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(subscription);\n            \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(err);\n        }\n    })\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3ewebpush.sendNotification\x3c\/code\x3e为我们封装了请求的处理细节。状态码401和404表示该subscription已经无效，可以从数据库中删除。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader9\x22\x3e3.4. Service Worker监听Push消息\x3c\/h3\x3e\n\x3cp\x3e调用\x3ccode\x3ewebpush.sendNotification()\x3c\/code\x3e后，我们就已经把消息发送至Push Service了；而Push Service会将我们的消息推送至浏览器。\x3c\/p\x3e\n\x3cp\x3e要想在浏览器中获取推送信息，只需在Service Worker中监听\x3ccode\x3epush\x3c\/code\x3e的事件即可：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ sw.js\nself.addEventListener(\x27push\x27, function (e) {\n    var data = e.data;\n    if (e.data) {\n        data = data.json();\n        console.log(\x27push的数据为：\x27, data);\n        self.registration.showNotification(data.text);        \n    } \n    else {\n        console.log(\x27push没有任何数据\x27);\n    }\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ sw.js\x3c\/span\x3e\nself.addEventListener(\x3cspan class=\x22hljs-string\x22\x3e\x27push\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3ee\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e data = e.data;\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (e.data) {\n        data = data.json();\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27push的数据为：\x27\x3c\/span\x3e, data);\n        self.registration.showNotification(data.text);        \n    } \n    \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x27push没有任何数据\x27\x3c\/span\x3e);\n    }\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader10\x22\x3e4. 效果展示\x3c\/h2\x3e\n\x3cp\x3e我们同时使用firefox与chrome来访问该WebApp，并分别向这两个客户端推送消息。我们可以使用console中打印出来的uniqueid，在postman中发起\x3ccode\x3e\/push\x3c\/code\x3e请求进行测试。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/user-gold-cdn.xitu.io\/2018\/4\/13\/162bc954b09d78cf?w=1277\x26amp;h=774\x26amp;f=gif\x26amp;s=2877596\x22 src=\x22https:\/\/static.alili.techhttps:\/\/user-gold-cdn.xitu.io\/2018\/4\/13\/162bc954b09d78cf?w=1277\x26amp;h=774\x26amp;f=gif\x26amp;s=2877596\x22 alt=\x22Web Push效果\x22 title=\x22Web Push效果\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e可以看到，我们分别向firefox与chrome中推送了“welcome to PWA”这条消息。console中的输出来自于Service Worker中对push事件的监听。而弹出的浏览器提醒则来自于之前提到的、订阅时配置的\x3ccode\x3euserVisibleOnly: true\x3c\/code\x3e属性。在后续的文章里，我继续带大家了解Notification API（提醒）的使用。\x3c\/p\x3e\n\x3cp\x3e正如前文所述，Push Service可以在设备离线时，帮你维护推送消息。当浏览器设备重新联网时，就会收到该推送。下面展示了在设备恢复联网后，就会收到推送：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/user-gold-cdn.xitu.io\/2018\/4\/14\/162bfe83b578881f?w=2560\x26amp;h=1600\x26amp;f=gif\x26amp;s=2478281\x22 src=\x22https:\/\/static.alili.techhttps:\/\/user-gold-cdn.xitu.io\/2018\/4\/14\/162bfe83b578881f?w=2560\x26amp;h=1600\x26amp;f=gif\x26amp;s=2478281\x22 alt=\x22恢复网络则会收到推送消息\x22 title=\x22恢复网络则会收到推送消息\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader11\x22\x3e5. 万恶的兼容性\x3c\/h2\x3e\n\x3cp\x3e又到了查看\x3ca href=\x22https:\/\/caniuse.com\/#search=push\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e兼容性\x3c\/a\x3e的时间了。比较重要的是，对于Push API，目前Safari团队并没有明确表态计划支持。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/user-gold-cdn.xitu.io\/2018\/4\/13\/162bfa0147d2b40d?w=2346\x26amp;h=918\x26amp;f=png\x26amp;s=192351\x22 src=\x22https:\/\/static.alili.techhttps:\/\/user-gold-cdn.xitu.io\/2018\/4\/13\/162bfa0147d2b40d?w=2346\x26amp;h=918\x26amp;f=png\x26amp;s=192351\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e当然，其实比兼容性更大的一个问题是，Chrome所依赖的FCM服务在国内是无法访问的，而Firefox的服务在国内可以正常使用。这也是为什么在代码中会有这一项设置：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const options = {\n    \/\/ proxy: \x27http:\/\/localhost:1087\x27 \/\/ 使用FCM（Chrome）需要配置代理\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e options = {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ proxy: \x27http:\/\/localhost:1087\x27 \/\/ 使用FCM（Chrome）需要配置代理\x3c\/span\x3e\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e上面代码其实是用来配置web-push代理的。这里有一点需要注意，目前从npm上安装的web-push是不支持设置代理选项的。针对这点github上专门有\x3ca href=\x22https:\/\/github.com\/web-push-libs\/web-push\/issues\/280\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eissue\x3c\/a\x3e进行了讨论，并在最近（两周前）合入了\x3ca href=\x22https:\/\/github.com\/web-push-libs\/web-push\/commit\/f099ec8ff97e86fb6778ece04bd27a36ef93655e\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e相应的PR\x3c\/a\x3e。因此，如果需要web-push支持代理，简单的方式就是基于master进行web-push代码的相应调整。\x3c\/p\x3e\n\x3cp\x3e虽然由于google服务被屏蔽，导致国内Push功能无法在chrome上使用，但是作为一个重要的技术点，Web Push还是非常值得我们了解与学习的。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader12\x22\x3e6. 写在最后\x3c\/h2\x3e\n\x3cp\x3e本文中所有的代码示例均可以在\x3ca href=\x22https:\/\/github.com\/alienzhou\/learning-pwa\/tree\/push\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3elearn-pwa\/push\x3c\/a\x3e上找到。注意在git clone之后，切换到push分支。切换其他分支可以看到不同的版本：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3ebasic分支：基础项目demo，一个普通的图书搜索应用（网站）；\x3c\/li\x3e\n\x3cli\x3emanifest分支：基于basic分支，添加manifest等功能；\x3c\/li\x3e\n\x3cli\x3esw-cache分支：基于manifest分支，添加缓存与离线功能；\x3c\/li\x3e\n\x3cli\x3epush分支：基于sw-cache分支，添加服务端消息推送功能；\x3c\/li\x3e\n\x3cli\x3emaster分支：应用的最新代码。\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e如果你喜欢或想要了解更多的PWA相关知识，欢迎关注我，关注\x3ca href=\x22https:\/\/juejin.im\/user\/59ad5377518825244d206d2d\/posts\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e《PWA学习与实践》\x3c\/a\x3e系列文章。我会总结整理自己学习PWA过程的遇到的疑问与技术点，并通过实际代码和大家一起实践。\x3c\/p\x3e\n\x3cp\x3e在下一篇文章里，我们先缓下脚步——工欲善其事，必先利其器。在继续了解更多PWA相关技术之前，先了解一些chrome上的PWA调试技巧。之后，我们会再回来继续了解另一个经常与Push API组合在一起的功能——消息提醒，Notification API。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader13\x22\x3e《PWA学习与实践》系列\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/juejin.im\/post\/5ac8a67c5188255c5668b0b8\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e第一篇：2018，开始你的PWA学习之旅\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/juejin.im\/post\/5ac8a89ef265da238440d60a\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e第二篇：10分钟学会使用Manifest，让你的WebApp更“Native”\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/juejin.im\/post\/5aca14b6f265da237c692e6f\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e第三篇：从今天起，让你的WebApp离线可用\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/juejin.im\/post\/5accc3c9f265da23870f2abc\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e第四篇：TroubleShooting: 解决FireBase login验证失败问题\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e第五篇：与你的用户保持联系: Web Push功能（本文）\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/juejin.im\/post\/5ae56f926fb9a07aca79edf6\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e第六篇：How to Debug? 在chrome中调试你的PWA\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/juejin.im\/post\/5ae7f7fd518825670960fe96\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e第七篇：增强交互：使用Notification API来进行提醒\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/juejin.im\/post\/5af80c336fb9a07aab29f19c\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e第八篇：使用Service Worker进行后台数据同步\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/juejin.im\/post\/5b02e5f1f265da0b767dc81d\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e第九篇：PWA实践中的问题与解决方案\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/juejin.im\/post\/5b4b66f0f265da0f9155feb6\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e第十篇：Resource Hint - 提升页面加载性能与体验\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e第十一篇：从PWA离线工具集workbox中学习各类离线策略（写作中…）\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch2 id=\x22articleHeader14\x22\x3e参考资料\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/tools.ietf.org\/html\/draft-ietf-webpush-protocol-12\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eGeneric Event Delivery Using HTTP Pus (draft-ietf-webpush-protocol-12)\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000010977980\x22\x3eFCM简单介绍\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/developers.google.com\/web\/fundamentals\/push-notifications\/how-push-works\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eHow Push Works\x3c\/a\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>【PWA学习与实践】(5)在Web中进行服务端消息推送</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000016916664">https://segmentfault.com/a/1190000016916664</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/a2rlb5a200l/" target="_blank">https://alili.tech/archive/a2rlb5a200l/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>