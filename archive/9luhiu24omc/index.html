<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="WebSocket的简单介绍及应用"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>WebSocket的简单介绍及应用 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/9luhiu24omc/",
				"appid": "1613049289050283", 
				"title": "WebSocket的简单介绍及应用 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-12T02:30:12"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/j2a8l3mpk3/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/uxsgax9sgi/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f9luhiu24omc%2f&text=WebSocket%e7%9a%84%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d%e5%8f%8a%e5%ba%94%e7%94%a8"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f9luhiu24omc%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f9luhiu24omc%2f&text=WebSocket%e7%9a%84%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d%e5%8f%8a%e5%ba%94%e7%94%a8"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f9luhiu24omc%2f&title=WebSocket%e7%9a%84%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d%e5%8f%8a%e5%ba%94%e7%94%a8"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f9luhiu24omc%2f&is_video=false&description=WebSocket%e7%9a%84%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d%e5%8f%8a%e5%ba%94%e7%94%a8"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=WebSocket%e7%9a%84%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d%e5%8f%8a%e5%ba%94%e7%94%a8&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f9luhiu24omc%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f9luhiu24omc%2f&title=WebSocket%e7%9a%84%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d%e5%8f%8a%e5%ba%94%e7%94%a8"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f9luhiu24omc%2f&title=WebSocket%e7%9a%84%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d%e5%8f%8a%e5%ba%94%e7%94%a8"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f9luhiu24omc%2f&title=WebSocket%e7%9a%84%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d%e5%8f%8a%e5%ba%94%e7%94%a8"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f9luhiu24omc%2f&title=WebSocket%e7%9a%84%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d%e5%8f%8a%e5%ba%94%e7%94%a8"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">WebSocket的简单介绍及应用</h1><div class="meta"><div class="postdate"><time datetime="2019-02-12" itemprop="datePublished">2019-02-12</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3ch2 id=\x22articleHeader0\x22\x3e定时刷新的不足与改进\x3c\/h2\x3e\n\x3cp\x3eweb开发中可能遇到这样的场景：网页里的某一块区域里写了一些内容，但这些内容不是固定的，即使看网页的人没有做任何操作，它们也会随时间不断变化。股票行情、活动或游戏的榜单都是比较常见的例子。\x3c\/p\x3e\n\x3cp\x3e对此，一般的做法是用\x3ccode\x3esetTimeout()\x3c\/code\x3e或\x3ccode\x3esetInverval()\x3c\/code\x3e定时执行任务，任务内容是Ajax访问一次服务器，并在成功拿到返回数据后去更新页面。\x3c\/p\x3e\n\x3cp\x3e这种定时刷新的做法会有这样一些感觉不足的地方：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e频繁的定时网络请求对浏览器（客户端）和服务器来说都是一种负担，尤其是当网页里有多个定时刷新区域的时候。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e某几次的定时任务可能是不必要的，因为服务器可能并没有新数据，还是返回了和上一次一样的内容。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e页面内容可能不够新，因为服务器可能刚更新了数据，但下一轮定时任务还没有开始。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e造成这些不足的原因归结起来，主要还是由于服务器的响应总是被动的。HTTP协议限制了一次通信总是由客户端发起请求，再由服务器端来返回响应。\x3c\/p\x3e\n\x3cp\x3e因此，如果让服务器端也可以主动发送信息到客户端，就可以很大程度改进这些不足。WebSocket就是一个实现这种双向通信的新协议。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3eWebSocket是基于HTTP的功能追加协议\x3c\/h2\x3e\n\x3cp\x3eWebSocket最初由html5提出，但现在已经发展为一个独立的协议标准。WebSocket可以分为协议（\x3ca href=\x22https:\/\/tools.ietf.org\/html\/rfc6455\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eProtocol\x3c\/a\x3e）和\x3ca href=\x22https:\/\/www.w3.org\/TR\/websockets\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eAPI\x3c\/a\x3e两部分，分别由\x3ca href=\x22https:\/\/zh.wikipedia.org\/wiki\/%E4%BA%92%E8%81%94%E7%BD%91%E5%B7%A5%E7%A8%8B%E4%BB%BB%E5%8A%A1%E7%BB%84\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eIETF\x3c\/a\x3e和W3C制定了标准。\x3c\/p\x3e\n\x3cp\x3e先来看看WebSocket协议的建立过程。\x3c\/p\x3e\n\x3cp\x3e为了实现WebSocket通信，首先需要客户端发起一次普通HTTP请求（也就是说，WebSocket的建立是依赖HTTP的）。请求报文可能像这样：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22GET ws:\/\/websocket.example.com\/ HTTP\/1.1\nHost: websocket.example.com\nUpgrade: websocket\nConnection: Upgrade\nOrigin: http:\/\/example.com\nSec-WebSocket-Key:pAloKxsGSHtpIHrJdWLvzQ==\nSec-WebSocket-Version:13\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22http hljs\x22\x3e\x3ccode class=\x22http\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eGET\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3ews:\/\/websocket.example.com\/\x3c\/span\x3e HTTP\/1.1\n\x3cspan class=\x22hljs-attribute\x22\x3eHost\x3c\/span\x3e: websocket.example.com\n\x3cspan class=\x22hljs-attribute\x22\x3eUpgrade\x3c\/span\x3e: websocket\n\x3cspan class=\x22hljs-attribute\x22\x3eConnection\x3c\/span\x3e: Upgrade\n\x3cspan class=\x22hljs-attribute\x22\x3eOrigin\x3c\/span\x3e: http:\/\/example.com\n\x3cspan class=\x22hljs-attribute\x22\x3eSec-WebSocket-Key:pAloKxsGSHtpIHrJdWLvzQ==\nSec-WebSocket-Version:13\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其中HTTP头部字段\x3ccode\x3eUpgrade: websocket\x3c\/code\x3e和\x3ccode\x3eConnection: Upgrade\x3c\/code\x3e很重要，告诉服务器通信协议将发生改变，转为WebSocket协议。支持WebSocket的服务器端在确认以上请求后，应返回状态码为\x3ccode\x3e101 Switching Protocols\x3c\/code\x3e的响应：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22HTTP\/1.1 101 Switching Protocols\nUpgrade: websocket\nConnection: Upgrade\nSec-WebSocket-Accept: nRu4KAPUPjjWYrnzxDVeqOxCvlM=\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22http hljs\x22\x3e\x3ccode class=\x22http\x22\x3eHTTP\/1.1 \x3cspan class=\x22hljs-number\x22\x3e101\x3c\/span\x3e Switching Protocols\n\x3cspan class=\x22hljs-attribute\x22\x3eUpgrade\x3c\/span\x3e: websocket\n\x3cspan class=\x22hljs-attribute\x22\x3eConnection\x3c\/span\x3e: Upgrade\n\x3cspan class=\x22hljs-attribute\x22\x3eSec-WebSocket-Accept\x3c\/span\x3e: nRu4KAPUPjjWYrnzxDVeqOxCvlM=\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其中字段\x3ccode\x3eSec-WebSocket-Accept\x3c\/code\x3e是由服务器对前面客户端发送的\x3ccode\x3eSec-WebSocket-Key\x3c\/code\x3e进行确认和加密后的结果，相当于一次验证，以帮助客户端确信对方是真实可用的WebSocket服务器。\x3c\/p\x3e\n\x3cp\x3e验证通过后，这个握手响应就确立了WebSocket连接，此后，服务器端就可以主动发信息给客户端了。此时的状态比较像服务器端和客户端接通了电话，无论是谁有什么信息想告诉对方，开口就好了。\x3c\/p\x3e\n\x3cp\x3e一旦建立了WebSocket连接，此后的通信就不再使用HTTP了，改为使用WebSocket独立的数据帧（这个帧有办法看到，见后文）。\x3c\/p\x3e\n\x3cp\x3e整个过程像这样：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVtFz0\x22 src=\x22https:\/\/static.alili.tech\/img\/bVtFz0\x22 alt=\x22Websocket协议建立过程\x22 title=\x22Websocket协议建立过程\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e简单的应用示例\x3c\/h2\x3e\n\x3cp\x3e应用WebSocket有这样几件事要做：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e选用\x3ca href=\x22http:\/\/caniuse.com\/#feat=websockets\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e支持WebSocket的浏览器\x3c\/a\x3e。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e网页内添加创建WebSocket的代码。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e服务器端添加使用WebSocket通信的代码。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch3 id=\x22articleHeader3\x22\x3e服务器端\x3c\/h3\x3e\n\x3cp\x3e以Node的服务器为例，我们使用\x3ca href=\x22https:\/\/www.npmjs.com\/package\/ws\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ews\x3c\/a\x3e这个组件，这样搭建一个支持WebSocket的服务器端：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var request = require(\x26quot;request\x26quot;);\nvar dateFormat = require(\x26quot;dateformat\x26quot;);\nvar WebSocket = require(\x26quot;ws\x26quot;),\n    WebSocketServer = WebSocket.Server,\n    wss = new WebSocketServer({\n        port: 8080,\n        path: \x26quot;\/guest\x26quot;\n    });\n\n\/\/ 收到来自客户端的连接请求后，开始给客户端推消息\nwss.on(\x26quot;connection\x26quot;, function(ws) {\n    ws.on(\x26quot;message\x26quot;, function(message) {\n        console.log(\x26quot;received: %s\x26quot;, message);\n    });\n    sendGuestInfo(ws);\n});\n\nfunction sendGuestInfo(ws) {\n    request(\x26quot;http:\/\/uinames.com\/api?region=china\x26quot;,\n        function(error, response, body) {\n            if (!error \x26amp;\x26amp; response.statusCode === 200) {\n                var jsonObject = JSON.parse(body),\n                    guest = jsonObject.name \x2b jsonObject.surname,\n                    guestInfo = {\n                        guest: guest,\n                        time: dateFormat(new Date(), \x26quot;HH:MM:ss\x26quot;)\n                    };\n\n                if (ws.readyState === WebSocket.OPEN) {\n\n                    \/\/ 发，送\n                    ws.send(JSON.stringify(guestInfo));\n\n                    \/\/ 用随机来“装”得更像不定时推送一些\n                    setTimeout(function() {\n                        sendGuestInfo(ws);\n                    }, (Math.random() * 5 \x2b 3) * 1000);\n                }\n            }\n        });\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e request = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22request\x22\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e dateFormat = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22dateformat\x22\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e WebSocket = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22ws\x22\x3c\/span\x3e),\n    WebSocketServer = WebSocket.Server,\n    wss = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e WebSocketServer({\n        \x3cspan class=\x22hljs-attr\x22\x3eport\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e8080\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-attr\x22\x3epath\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x22\/guest\x22\x3c\/span\x3e\n    });\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 收到来自客户端的连接请求后，开始给客户端推消息\x3c\/span\x3e\nwss.on(\x3cspan class=\x22hljs-string\x22\x3e\x22connection\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ews\x3c\/span\x3e) \x3c\/span\x3e{\n    ws.on(\x3cspan class=\x22hljs-string\x22\x3e\x22message\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3emessage\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22received: %s\x22\x3c\/span\x3e, message);\n    });\n    sendGuestInfo(ws);\n});\n\n\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3esendGuestInfo\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ews\x3c\/span\x3e) \x3c\/span\x3e{\n    request(\x3cspan class=\x22hljs-string\x22\x3e\x22http:\/\/uinames.com\/api?region=china\x22\x3c\/span\x3e,\n        \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eerror, response, body\x3c\/span\x3e) \x3c\/span\x3e{\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!error \x26amp;\x26amp; response.statusCode === \x3cspan class=\x22hljs-number\x22\x3e200\x3c\/span\x3e) {\n                \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e jsonObject = \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.parse(body),\n                    guest = jsonObject.name \x2b jsonObject.surname,\n                    guestInfo = {\n                        \x3cspan class=\x22hljs-attr\x22\x3eguest\x3c\/span\x3e: guest,\n                        \x3cspan class=\x22hljs-attr\x22\x3etime\x3c\/span\x3e: dateFormat(\x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eDate\x3c\/span\x3e(), \x3cspan class=\x22hljs-string\x22\x3e\x22HH:MM:ss\x22\x3c\/span\x3e)\n                    };\n\n                \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (ws.readyState === WebSocket.OPEN) {\n\n                    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 发，送\x3c\/span\x3e\n                    ws.send(\x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.stringify(guestInfo));\n\n                    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 用随机来“装”得更像不定时推送一些\x3c\/span\x3e\n                    setTimeout(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n                        sendGuestInfo(ws);\n                    }, (\x3cspan class=\x22hljs-built_in\x22\x3eMath\x3c\/span\x3e.random() * \x3cspan class=\x22hljs-number\x22\x3e5\x3c\/span\x3e \x2b \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e) * \x3cspan class=\x22hljs-number\x22\x3e1000\x3c\/span\x3e);\n                }\n            }\n        });\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这个例子使用了姓名生成站点\x3ca href=\x22http:\/\/uinames.com\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3euinames\x3c\/a\x3e的API服务，来生成\x3ccode\x3e{guest: \x22人名\x22, time: \x2215:26:01\x22}\x3c\/code\x3e这样的数据。函数\x3ccode\x3esendGuestInfo()\x3c\/code\x3e会不定时执行，并把包含姓名和时间的信息通过\x3ccode\x3esend()\x3c\/code\x3e方法发送给客户端。另外，注意\x3ccode\x3esend()\x3c\/code\x3e方法需要以字符串形式来发送json数据。\x3c\/p\x3e\n\x3cp\x3e这就像是服务器自己在做一些事，然后在需要的时候会通知客户端一些信息。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3e客户端\x3c\/h3\x3e\n\x3cp\x3e客户端我们使用原生javascript来完成（仅支持WebSocket的浏览器）：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var socket = new WebSocket(\x26quot;ws:\/\/localhost:8080\/guest\x26quot;);\n\nsocket.onopen = function(openEvent) {\n    console.log(\x26quot;WebSocket conntected.\x26quot;);\n};\n\nsocket.onmessage = function(messageEvent) {\n    var data = messageEvent.data,\n        dataObject = JSON.parse(data);\n    console.log(\x26quot;Guest at \x26quot; \x2b dataObject.time \x2b \x26quot;: \x26quot; \x2b dataObject.guest);\n};\n\nsocket.onerror = function(errorEvent) {\n    console.log(\x26quot;WebSocket error: \x26quot;, errorEvent);\n};\n\nsocket.onclose = function(closeEvent) {\n    console.log(\x26quot;WebSocket closed.\x26quot;);\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e socket = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e WebSocket(\x3cspan class=\x22hljs-string\x22\x3e\x22ws:\/\/localhost:8080\/guest\x22\x3c\/span\x3e);\n\nsocket.onopen = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eopenEvent\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22WebSocket conntected.\x22\x3c\/span\x3e);\n};\n\nsocket.onmessage = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3emessageEvent\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e data = messageEvent.data,\n        dataObject = \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.parse(data);\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22Guest at \x22\x3c\/span\x3e \x2b dataObject.time \x2b \x3cspan class=\x22hljs-string\x22\x3e\x22: \x22\x3c\/span\x3e \x2b dataObject.guest);\n};\n\nsocket.onerror = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eerrorEvent\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22WebSocket error: \x22\x3c\/span\x3e, errorEvent);\n};\n\nsocket.onclose = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ecloseEvent\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22WebSocket closed.\x22\x3c\/span\x3e);\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eWebSocket的URL格式是\x3ccode\x3ews:\/\/\x3c\/code\x3e与\x3ccode\x3ewss:\/\/\x3c\/code\x3e。因此，需要注意下URL地址的写法，这也包括注意WebSocket服务器端的路径（如这里的\x3ccode\x3e\/guest\x3c\/code\x3e）等信息。因为是本地的示例所以这里是\x3ccode\x3elocalhost\x3c\/code\x3e。\x3c\/p\x3e\n\x3cp\x3e客户端代码的流程很简单：创建\x3ccode\x3eWebSocket\x3c\/code\x3e对象，然后指定\x3ccode\x3eonopen\x3c\/code\x3e、\x3ccode\x3eonmessage\x3c\/code\x3e等事件的回调即可。其中\x3ccode\x3eonmessage\x3c\/code\x3e是客户端与服务器端通过WebSocket通信的关键事件，想要在收到服务器通知后做点什么，写在\x3ccode\x3eonmessage\x3c\/code\x3e事件的回调函数里就好了。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e效果及分析\x3c\/h3\x3e\n\x3cp\x3e通过\x3ccode\x3enode server\x3c\/code\x3e（假定服务器端的文件名为\x3ccode\x3eserver.js\x3c\/code\x3e）启动WebSocket服务器后，用浏览器打开一个引入了前面客户端代码的html（直接文件路径\x3ccode\x3efile:\/\/\/\x3c\/code\x3e就可以），就可以得到像这样的结果：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVtFz2\x22 src=\x22https:\/\/static.alili.tech\/img\/bVtFz2\x22 alt=\x22websocket的即时姓名\x22 title=\x22websocket的即时姓名\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e联系前面客户端的代码可以想到，实际从创建\x3ccode\x3eWebSocket\x3c\/code\x3e对象的语句开始，连接请求就会发送，并很快建立起WebSocket连接（不出错误的话），此后就可以收到来自服务器端的通知。如果此时客户端还想再告诉服务器点什么，这样做：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22socket.send(\x26quot;Hello, server!\x26quot;);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3esocket.send(\x3cspan class=\x22hljs-string\x22\x3e\x22Hello, server!\x22\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e服务器就可以收到：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVtFz5\x22 src=\x22https:\/\/static.alili.tech\/img\/bVtFz5\x22 alt=\x22服务器端已收到\x22 title=\x22服务器端已收到\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e当然，这也是因为前面服务器端的代码内同样设置了\x3ccode\x3emessage\x3c\/code\x3e事件的回调。在这个客户端和服务器都是javascript的例子中，无论是服务器端还是客户端，都用\x3ccode\x3esend()\x3c\/code\x3e发送信息，都通过\x3ccode\x3emessage\x3c\/code\x3e事件设置回调，形式上可以说非常一致。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader6\x22\x3e其他可用的数据类型\x3c\/h2\x3e\n\x3cp\x3eWebSocket的\x3ccode\x3esend()\x3c\/code\x3e可以发送的消息，除了前面用的字符串类型之外，还有两种可用，它们是\x3ca href=\x22https:\/\/developer.mozilla.org\/zh-CN\/docs\/Web\/API\/Blob\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eBlob\x3c\/a\x3e和\x3ca href=\x22https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/JavaScript\/Reference\/Global_Objects\/ArrayBuffer\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eArrayBuffer\x3c\/a\x3e。\x3c\/p\x3e\n\x3cp\x3e它们都代表二进制数据，可用于原始文件数据的发送。比如，这是一个发送Blob类型数据以完成向服务器上传图片的例子：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var fileEl = document.getElementById(\x26quot;image_upload\x26quot;);\nvar file = fileEl.files[0];\nsocket.send(file);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e fileEl = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x22image_upload\x22\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e file = fileEl.files[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e];\nsocket.send(file);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e然后服务器端可以这样把文件保存下来：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var fs = require(\x26quot;fs\x26quot;);\n\nwss.on(\x26quot;connection\x26quot;, function(ws) {\n    ws.on(\x26quot;message\x26quot;, function(message) {\n        fs.writeFile(\x26quot;upload.png\x26quot;, message, \x26quot;binary\x26quot;, function(error) {\n            if (!error) {\n                console.log(\x26quot;File saved.\x26quot;);\n            }\n        });\n    });\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e fs = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x22fs\x22\x3c\/span\x3e);\n\nwss.on(\x3cspan class=\x22hljs-string\x22\x3e\x22connection\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ews\x3c\/span\x3e) \x3c\/span\x3e{\n    ws.on(\x3cspan class=\x22hljs-string\x22\x3e\x22message\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3emessage\x3c\/span\x3e) \x3c\/span\x3e{\n        fs.writeFile(\x3cspan class=\x22hljs-string\x22\x3e\x22upload.png\x22\x3c\/span\x3e, message, \x3cspan class=\x22hljs-string\x22\x3e\x22binary\x22\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eerror\x3c\/span\x3e) \x3c\/span\x3e{\n            \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!error) {\n                \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x22File saved.\x22\x3c\/span\x3e);\n            }\n        });\n    });\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在客户端接收二进制数据时，需注意WebSocket对象有一个属性\x3ccode\x3ebinaryType\x3c\/code\x3e，初始值为\x3ccode\x3e\x22blob\x22\x3c\/code\x3e。因此，如果接收的二进制数据是\x3ccode\x3eArrayBuffer\x3c\/code\x3e，应在接收之前这样做：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22socket.binaryType = \x26quot;arraybuffer\x26quot;;\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3esocket.binaryType = \x3cspan class=\x22hljs-string\x22\x3e\x22arraybuffer\x22\x3c\/span\x3e;\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e其他WebSocket服务器端\x3c\/h2\x3e\n\x3cp\x3e其他语言来做WebSocket服务器是怎样的呢？下面是一个php的WebSocket服务器的例子（使用\x3ca href=\x22http:\/\/socketo.me\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eRatchet\x3c\/a\x3e）：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3c?php\nuse Ratchet\\ConnectionInterface;\nuse Ratchet\\MessageComponentInterface;\n\nrequire __DIR__ . \x27\/vendor\/autoload.php\x27;\n\nclass GuestServer implements MessageComponentInterface {\n\n    public function onOpen(ConnectionInterface $conn) {\n        $conn-\x3esend(\x27The server is listening to you now.\x27);\n    }\n\n    public function onMessage(ConnectionInterface $conn, $msg) {\n        $conn-\x3esend($this-\x3egenerateGuestInfo());\n    }\n\n    public function onClose(ConnectionInterface $conn) {\n    }\n\n    public function onError(ConnectionInterface $conn, \\Exception $e) {\n        $conn-\x3eclose();\n    }\n\n    private function generateGuestInfo() {\n        $jsonString = file_get_contents(\x27http:\/\/uinames.com\/api?region=china\x27);\n        $jsonObject = json_decode($jsonString, true);\n        $guest = $jsonObject[\x27name\x27] . $jsonObject[\x27surname\x27];\n        $guestInfo = array(\n            \x27guest\x27 =\x3e $guest,\n            \x27time\x27 =\x3e date(\x27H:i:s\x27, time()),\n        );\n\n        return json_encode($guestInfo);\n    }\n}\n\n$app = new Ratchet\\App(\x27localhost\x27, 8080);\n$app-\x3eroute(\x27\/guest\x27, new GuestServer(), array(\x27*\x27));\n$app-\x3erun();\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22php hljs\x22\x3e\x3ccode class=\x22php\x22\x3e\x3cspan class=\x22hljs-meta\x22\x3e\x26lt;?php\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3euse\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eRatchet\x3c\/span\x3e\\\x3cspan class=\x22hljs-title\x22\x3eConnectionInterface\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3euse\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eRatchet\x3c\/span\x3e\\\x3cspan class=\x22hljs-title\x22\x3eMessageComponentInterface\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-keyword\x22\x3erequire\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3e__DIR__\x3c\/span\x3e . \x3cspan class=\x22hljs-string\x22\x3e\x27\/vendor\/autoload.php\x27\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eGuestServer\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eimplements\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eMessageComponentInterface\x3c\/span\x3e \x3c\/span\x3e{\n\n    \x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eonOpen\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(ConnectionInterface $conn)\x3c\/span\x3e \x3c\/span\x3e{\n        $conn-\x26gt;send(\x3cspan class=\x22hljs-string\x22\x3e\x27The server is listening to you now.\x27\x3c\/span\x3e);\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eonMessage\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(ConnectionInterface $conn, $msg)\x3c\/span\x3e \x3c\/span\x3e{\n        $conn-\x26gt;send(\x3cspan class=\x22hljs-keyword\x22\x3e$this\x3c\/span\x3e-\x26gt;generateGuestInfo());\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eonClose\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(ConnectionInterface $conn)\x3c\/span\x3e \x3c\/span\x3e{\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3epublic\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eonError\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(ConnectionInterface $conn, \\Exception $e)\x3c\/span\x3e \x3c\/span\x3e{\n        $conn-\x26gt;close();\n    }\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eprivate\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egenerateGuestInfo\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n        $jsonString = file_get_contents(\x3cspan class=\x22hljs-string\x22\x3e\x27http:\/\/uinames.com\/api?region=china\x27\x3c\/span\x3e);\n        $jsonObject = json_decode($jsonString, \x3cspan class=\x22hljs-keyword\x22\x3etrue\x3c\/span\x3e);\n        $guest = $jsonObject[\x3cspan class=\x22hljs-string\x22\x3e\x27name\x27\x3c\/span\x3e] . $jsonObject[\x3cspan class=\x22hljs-string\x22\x3e\x27surname\x27\x3c\/span\x3e];\n        $guestInfo = \x3cspan class=\x22hljs-keyword\x22\x3earray\x3c\/span\x3e(\n            \x3cspan class=\x22hljs-string\x22\x3e\x27guest\x27\x3c\/span\x3e =\x26gt; $guest,\n            \x3cspan class=\x22hljs-string\x22\x3e\x27time\x27\x3c\/span\x3e =\x26gt; date(\x3cspan class=\x22hljs-string\x22\x3e\x27H:i:s\x27\x3c\/span\x3e, time()),\n        );\n\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e json_encode($guestInfo);\n    }\n}\n\n$app = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Ratchet\\App(\x3cspan class=\x22hljs-string\x22\x3e\x27localhost\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e8080\x3c\/span\x3e);\n$app-\x26gt;route(\x3cspan class=\x22hljs-string\x22\x3e\x27\/guest\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e GuestServer(), \x3cspan class=\x22hljs-keyword\x22\x3earray\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27*\x27\x3c\/span\x3e));\n$app-\x26gt;run();\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这个例子也同样是由服务器返回\x3ccode\x3e{guest: \x22人名\x22, time: \x2215:26:01\x22}\x3c\/code\x3e的json数据，不过由于php不像Node那样可以用\x3ccode\x3esetTimeout()\x3c\/code\x3e很容易地实现异步定时任务，这里改为在客户端发送一次任意信息后，再去uinames取得信息并返回。\x3c\/p\x3e\n\x3cp\x3e也可以看到，php搭建的WebSocket服务器仍然是近似的，主要通过WebSocket的\x3ccode\x3eopen\x3c\/code\x3e、\x3ccode\x3emessage\x3c\/code\x3e等事件来实现功能。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader8\x22\x3e在Chrome开发工具中查看WebSocket数据帧\x3c\/h2\x3e\n\x3cp\x3eChrome开发工具中选择Network，然后找到WebSocket的那个请求，里面可以选择Frames。在Frames里看到的，就是WebSocket的数据帧了：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVtFAf\x22 src=\x22https:\/\/static.alili.tech\/img\/bVtFAf\x22 alt=\x22查看WebSocket数据帧\x22 title=\x22查看WebSocket数据帧\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e可以看到很像聊天记录，其中用浅绿色标注的是由客户端发送给服务器的部分。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader9\x22\x3e结语\x3c\/h2\x3e\n\x3cp\x3e总的来说，把服务器和客户端拉到了一个聊天窗口来办事，这确实是很棒的想法。\x3c\/p\x3e\n\x3cp\x3e即使只从形式上说，WebSocket的事件回调感觉也比定时任务用起来要更亲切一些。\x3c\/p\x3e\n\x3cp\x3e（重新编辑自我的博客，原文地址：\x3ca href=\x22http:\/\/acgtofe.com\/posts\/2016\/03\/websocket-how-to\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttp:\/\/acgtofe.com\/posts\/2016\/03\/websocket-how-to\x3c\/a\x3e）\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>WebSocket的简单介绍及应用</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000004649040">https://segmentfault.com/a/1190000004649040</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/9luhiu24omc/" target="_blank">https://alili.tech/archive/9luhiu24omc/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>