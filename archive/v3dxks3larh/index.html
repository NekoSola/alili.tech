<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="Under the Hood: NaN of JS"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>Under the Hood: NaN of JS | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/v3dxks3larh/",
				"appid": "1613049289050283", 
				"title": "Under the Hood: NaN of JS | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-13T02:31:23"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/jczs4kd3b3a/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/5sk300yp4o/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fv3dxks3larh%2f&text=Under%20the%20Hood%3a%20NaN%20of%20JS"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fv3dxks3larh%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fv3dxks3larh%2f&text=Under%20the%20Hood%3a%20NaN%20of%20JS"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fv3dxks3larh%2f&title=Under%20the%20Hood%3a%20NaN%20of%20JS"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fv3dxks3larh%2f&is_video=false&description=Under%20the%20Hood%3a%20NaN%20of%20JS"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=Under%20the%20Hood%3a%20NaN%20of%20JS&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fv3dxks3larh%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fv3dxks3larh%2f&title=Under%20the%20Hood%3a%20NaN%20of%20JS"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fv3dxks3larh%2f&title=Under%20the%20Hood%3a%20NaN%20of%20JS"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fv3dxks3larh%2f&title=Under%20the%20Hood%3a%20NaN%20of%20JS"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fv3dxks3larh%2f&title=Under%20the%20Hood%3a%20NaN%20of%20JS"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Under the Hood: NaN of JS</h1><div class="meta"><div class="postdate"><time datetime="2019-02-13" itemprop="datePublished">2019-02-13</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e在查看本文之前，请先思考两个问题。\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\n\x3ccode\x3etypeof (1 \/ undefined)\x3c\/code\x3e 是多少\x3c\/li\x3e\n\x3cli\x3e\n\x3ccode\x3e[1,2,NaN].indexOf(NaN)\x3c\/code\x3e 输出什么\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e如果你还不确定这两题的答案的话，请仔细阅读本文。\x3cbr\x3e这两题的答案不会直接解释，请从文章中寻找答案。\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader0\x22\x3eNaN 的本质\x3c\/h1\x3e\n\x3cp\x3e我们知道 NaN(Not A Number) 会出现在\x3cstrong\x3e任何不符合实数领域内计算规则\x3c\/strong\x3e的场景下。比如 \x3ccode\x3eMath.sqrt(-1)\x3c\/code\x3e 就是 NaN，而 \x3ccode\x3e1 \/ 0\x3c\/code\x3e 就不是 NaN。前者属于复数的范畴，而后者属于实数的范围。\x3c\/p\x3e\n\x3cp\x3e同时需要注意的是，NaN 只会出现在浮点类型中，而不会出现在 int 类型里（当然 JS 并没有这个概念）\x3c\/p\x3e\n\x3cp\x3e什么意思？用你熟悉的任何支持 int 和 double 两种类型的语言（比如 C）。在保证它不会偷偷做隐式类型转换的情况下，分别用 int 和 double 打印出 \x3ccode\x3esqrt(-1)\x3c\/code\x3e， 你就能发现只有在 double 的类型下才能看到 NaN 出现，而 int 呢？编译器甚至会给你一个 \x3cstrong\x3eWarning。\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e那么在浮点数下是如何表示一个 NaN 的呢？为了方便，下面用单精度 float 来表示，请看下图。\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016802120\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016802120\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3cbr\x3e在 3b 情况中，NaN 得满足：\x3cstrong\x3e从左到右，以 1 开始，不关心第 1 位的值，第 2 位到第 9 位都是 1，剩下的位不全 为 0。\x3c\/strong\x3e 关于 \x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/IEEE_754\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e浮点数内部的组成\x3c\/a\x3e，这里不做具体的介绍，我们只需要了解到浮点数分为 3 个部分就可以：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e符号位\x3c\/li\x3e\n\x3cli\x3e指数位\x3c\/li\x3e\n\x3cli\x3e精度位\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e其中 float 的指数位有 8 位，精度位有 32 - 1 - 8 = 23 位\x3cbr\x3edouble 的指数位有 11 位，精度位有 64 - 1 - 11 = 52 位\x3cbr\x3e所以上面 NaN 的满足条件，可以看成：\x3cstrong\x3e精度位不全为 0，指数位全 1\x3c\/strong\x3e 就可以了。\x3c\/p\x3e\n\x3cp\x3e所以按上面的说法，\x3ccode\x3e0x7f81111, 0x7fcccccc\x3c\/code\x3e 等等这些都符合 NaN 的要求了。我们可以尝试一下，自己写一个函数，用来往 \x3cstrong\x3e8\x3c\/strong\x3e 个字节的内存的前两个字节写入全 1. 也就是连续 16 个 1，这就符合 NaN 的定义了。看下面这段代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22double createNaN() {\n  unsigned char *bits = calloc(sizeof(double), 1);\n  \/\/ 大部分人的电脑是小端，所以要从 6 和 7 开始，而不是 0 和 1\n  \/\/ 不清楚概念的可以参考阮老师：\n  \/\/ [理解字节序 - 阮一峰的网络日志](http:\/\/www.ruanyifeng.com\/blog\/2016\/11\/byte-order.html)\n  bits[6] = 255;\n  bits[7] = 255;\n  unsigned char *start = bits;\n\n  double nan = *(double *)(bits);\n  output(nan);\n  free(bits);\n  return nan;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs cpp\x22\x3e\x3ccode class=\x22c\x22\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3edouble\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecreateNaN\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3eunsigned\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3echar\x3c\/span\x3e *bits = \x3cspan class=\x22hljs-built_in\x22\x3ecalloc\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3esizeof\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3edouble\x3c\/span\x3e), \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e);\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 大部分人的电脑是小端，所以要从 6 和 7 开始，而不是 0 和 1\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 不清楚概念的可以参考阮老师：\x3c\/span\x3e\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ [理解字节序 - 阮一峰的网络日志](http:\/\/www.ruanyifeng.com\/blog\/2016\/11\/byte-order.html)\x3c\/span\x3e\n  bits[\x3cspan class=\x22hljs-number\x22\x3e6\x3c\/span\x3e] = \x3cspan class=\x22hljs-number\x22\x3e255\x3c\/span\x3e;\n  bits[\x3cspan class=\x22hljs-number\x22\x3e7\x3c\/span\x3e] = \x3cspan class=\x22hljs-number\x22\x3e255\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-keyword\x22\x3eunsigned\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3echar\x3c\/span\x3e *start = bits;\n\n  \x3cspan class=\x22hljs-keyword\x22\x3edouble\x3c\/span\x3e nan = *(\x3cspan class=\x22hljs-keyword\x22\x3edouble\x3c\/span\x3e *)(bits);\n  output(nan);\n  \x3cspan class=\x22hljs-built_in\x22\x3efree\x3c\/span\x3e(bits);\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e nan;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其中 output 是一个封装，用来输出任意一个 double 的内部二进制表示。详细代码查看 \x3ca href=\x22https:\/\/gist.github.com\/thoamsy\/28b278a098d0daeb495c8dbeca40cc1a\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3egist\x3c\/a\x3e\x3cbutton class=\x22btn btn-xs btn-default ml10 preview\x22 data-url=\x22thoamsy\/28b278a098d0daeb495c8dbeca40cc1a\x22 data-typeid=\x221\x22\x3e点击预览\x3c\/button\x3e。\x3cbr\x3e最后我们得到了：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016802121\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016802121\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e看来创造一个 NaN 不是很难，对吧？\x3cbr\x3e同样的，为了证明上面的图的正确性，再看看 \x3ccode\x3eInfinity\x3c\/code\x3e 的内部结构是否符合\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016802122\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016802122\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3chr\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e两种 NaN\x3c\/h2\x3e\n\x3cp\x3e如果再细分的话，NaN 还可分为两种：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3eQuiet NaN\x3c\/li\x3e\n\x3cli\x3eSignaling NaN\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e从性质上，可以认为第一种 NaN 属于“脾气比较好”，比较“文静”的一种，你甚至可以直接定义它，并使用它。\x3cbr\x3e比如我们在 JS 中可以使用类似于 \x3ccode\x3eNaN \x2b 1, NaN \x2b \x27123\x27\x3c\/code\x3e 的操作，还不会报错。\x3c\/p\x3e\n\x3cp\x3e而 Signaling NaN 就是一个“爆脾气”。如果你想直接操作它的话，会抛出一个异常（或者称为 Trap）。也就不允许 NaN \x2b 1 这种操作了。像这种不好惹的 NaN，根据 WiKi 中的介绍，它可以被用来：\x3c\/p\x3e\n\x3cblockquote\x3eFilling uninitialized memory with signaling NaNs would produce the invalid operation exception if the data is used before it is initialized\x3cbr\x3eUsing an sNaN as a placeholder for a more complicated \x3ca\x3eobject\x3c\/a\x3e , such as:\x3cbr\x3eA representation of a number that has \x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/Arithmetic_underflow\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eunderflowed\x3c\/a\x3e\x3cbr\x3eA representation of a number that has \x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/Arithmetic_overflow\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eoverflowed\x3c\/a\x3e\x3cbr\x3eNumber in a higher precision format\x3cbr\x3eA \x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/Complex_number\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ecomplex number\x3c\/a\x3e\n\x3c\/blockquote\x3e\n\x3ch1 id=\x22articleHeader2\x22\x3eNaN != NaN\x3c\/h1\x3e\n\x3cp\x3e如果换个角度理解，因为 NaN 的表示方式实在太多，仅仅在 float 类型中，就有 \x3cem\x3e2^(32-8)\x3c\/em\x3e 中情况，所以 NaN 碰到一个和它二进制表示一模一样的概率实在太低了，所以我们可以认为 \x3cstrong\x3eNaN 不等于 NaN\x3c\/strong\x3e 😏\x3c\/p\x3e\n\x3cp\x3e嗯。看上去似乎问题不大，但是我们都知道计算机在大多数情况下，都是按规矩办事，这种玄学问题肯定不是内部的本质吧？要是真这样，世界上每一个程序员同时输出 \x3ccode\x3eNaN === NaN\x3c\/code\x3e，总有一个人会得到 true，然后他就到 stackoverflow 上发了一个帖：\x3cstrong\x3e你看 NaN 其实是会等于 NaN 的！\x3c\/strong\x3e 但我们从来没有见过这样的帖子，所以计算机内部肯定不是用这种颇为靠运气的方式在处理这个问题。\x3c\/p\x3e\n\x3cp\x3e考虑换一种方式，假设计算机内部是通过\x3cstrong\x3e位运算\x3c\/strong\x3e来判断的。如果某一个数的内部结构满足\x3cstrong\x3e第 2 位到第 9 位全 1，剩下的 22 位不为 0\x3c\/strong\x3e，那它就是 NaN。我们可以这样写\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22_Bool isnan(double whatever) {\n  long long num = *(long long *)(\x26amp;whatever); \/\/ 浮点数不能进行位运算，所以要改成整数类型，同时保留内部的二进制组成\n  long long fmask = 0xfffffffffffff; \/\/ 不要数了，13 个 f，52 个 1\n  long long emask = 0x7ff; \/\/ 11 个 1\n  num \x3c\x3c= 1;\n  num \x3e\x3e= 1; \/\/ 清除符号位\n  return ((num \x26amp; fmask) != 0) \x26amp;\x26amp; (((num \x3e\x3e 53) \x26amp; emask) == emask);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs cpp\x22\x3e\x3ccode class=\x22c\x22\x3e_\x3cspan class=\x22hljs-function\x22\x3eBool \x3cspan class=\x22hljs-title\x22\x3eisnan\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(\x3cspan class=\x22hljs-keyword\x22\x3edouble\x3c\/span\x3e whatever)\x3c\/span\x3e \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3elong\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3elong\x3c\/span\x3e num = *(\x3cspan class=\x22hljs-keyword\x22\x3elong\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3elong\x3c\/span\x3e *)(\x26amp;whatever); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 浮点数不能进行位运算，所以要改成整数类型，同时保留内部的二进制组成\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3elong\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3elong\x3c\/span\x3e fmask = \x3cspan class=\x22hljs-number\x22\x3e0xfffffffffffff\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 不要数了，13 个 f，52 个 1\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3elong\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3elong\x3c\/span\x3e emask = \x3cspan class=\x22hljs-number\x22\x3e0x7ff\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 11 个 1\x3c\/span\x3e\n  num \x26lt;\x26lt;= \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e;\n  num \x26gt;\x26gt;= \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e; \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 清除符号位\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e ((num \x26amp; fmask) != \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e) \x26amp;\x26amp; (((num \x26gt;\x26gt; \x3cspan class=\x22hljs-number\x22\x3e53\x3c\/span\x3e) \x26amp; emask) == emask);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e你可以试着把这段 C 代码运行一下，配合上面的 \x3ccode\x3ecreateNaN\x3c\/code\x3e 可以试一下，他是真的可行的！\x3c\/p\x3e\n\x3cp\x3e接着要实现 NaN != NaN 的特性，只需要在每次 == 的时候进行检测：只要有一个操作数是 NaN，那么就返回 false。\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader3\x22\x3e实际情况下的 NaN != NaN 的实现\x3c\/h1\x3e\n\x3cp\x3e那么实际情况到底是怎样的呢？不同的系统会有不同的实现。\x3c\/p\x3e\n\x3cp\x3e在 Apple 实现的 \x3ca href=\x22https:\/\/opensource.apple.com\/\/source\/Libm\/Libm-315\/Source\/PowerPC\/math.h\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eC 库的头文件中\x3c\/a\x3e，可以看到，nan 在 float 下，仅仅就是一个数，它等于 \x3cstrong\x3e0x7fc00000\x3c\/strong\x3e，也就是 \x3cstrong\x3e0b0111 1111 1100 0000 0000 0000 0000 0000\x3c\/strong\x3e，符合上面的 NaN 的定义。\x3cbr\x3e\x3ccode\x3e#define NAN __builtin_nanf(\x220x7fc00000\x22)\x3c\/code\x3e\x3cbr\x3e而它们的 \x3ccode\x3eisnan\x3c\/code\x3e 的实现也相当简单\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22#define isnan(x)    \\\n    (sizeof (x) == sizeof(float)    ?  __inline_isnanf((float)(x))    \\\n  :  sizeof (x) == sizeof(double)  ?      __inline_isnand((double)(x))    \\\n    :    __inline_isnan ((long double)(x)))\n\nstatic __inline__ int __inline_isnanf( float __x ) {\n    return __x != __x;\n}\nstatic __inline__ int __inline_isnand( double __x ) {\n    return __x != __x;\n}\nstatic __inline__ int __inline_isnan( long double __x ) {\n  return __x != __x;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs cs\x22\x3e\x3ccode class=\x22c\x22\x3e\x3cspan class=\x22hljs-meta\x22\x3e#\x3cspan class=\x22hljs-meta-keyword\x22\x3edefine\x3c\/span\x3e isnan(x)    \\\x3c\/span\x3e\n    (\x3cspan class=\x22hljs-keyword\x22\x3esizeof\x3c\/span\x3e (x) == \x3cspan class=\x22hljs-keyword\x22\x3esizeof\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3efloat\x3c\/span\x3e)    ?  __inline_isnanf((\x3cspan class=\x22hljs-keyword\x22\x3efloat\x3c\/span\x3e)(x))    \\\n  :  \x3cspan class=\x22hljs-keyword\x22\x3esizeof\x3c\/span\x3e (x) == \x3cspan class=\x22hljs-keyword\x22\x3esizeof\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3edouble\x3c\/span\x3e)  ?      __inline_isnand((\x3cspan class=\x22hljs-keyword\x22\x3edouble\x3c\/span\x3e)(x))    \\\n    :    __inline_isnan ((\x3cspan class=\x22hljs-keyword\x22\x3elong\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edouble\x3c\/span\x3e)(x)))\n\n\x3cspan class=\x22hljs-keyword\x22\x3estatic\x3c\/span\x3e __inline__ \x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e __inline_isnanf( \x3cspan class=\x22hljs-keyword\x22\x3efloat\x3c\/span\x3e __x ) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e __x != __x;\n}\n\x3cspan class=\x22hljs-keyword\x22\x3estatic\x3c\/span\x3e __inline__ \x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e __inline_isnand( \x3cspan class=\x22hljs-keyword\x22\x3edouble\x3c\/span\x3e __x ) {\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e __x != __x;\n}\n\x3cspan class=\x22hljs-keyword\x22\x3estatic\x3c\/span\x3e __inline__ \x3cspan class=\x22hljs-keyword\x22\x3eint\x3c\/span\x3e __inline_isnan( \x3cspan class=\x22hljs-keyword\x22\x3elong\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3edouble\x3c\/span\x3e __x ) {\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e __x != __x;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e仅仅只是简单的判断自己是否等于自己 🌚。在 C 中具体如何实现 \x3ccode\x3ex !== x\x3c\/code\x3e，有两种可能：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e硬件支持 NaN 异常，所以永远都是 false\x3c\/li\x3e\n\x3cli\x3e像下文中提到的 V8 的实现方式\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e而在 V8 中，分为两个阶段：\/Compile Time and Runtime\/。\x3c\/p\x3e\n\x3cp\x3e在 Compile Time，编译器如果在代码中碰到了 NaN 常量，就会自动将替换成 NaN 对应的那个常量，比如上文提到的 \x3cstrong\x3e0x7fc00000\x3c\/strong\x3e。因为编译器已经明确知道了谁是 NaN，所以在写出形如 \x3ccode\x3eNaN === NaN\x3c\/code\x3e 这种代码的时候，就能直接得到 false。\x3c\/p\x3e\n\x3cp\x3e而在 Runtime 阶段，不是用户直接定义的 NaN，比如下面代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const obj = { a: 1, b: 2 };\nlet { c, d } = obj;\nc *= 100;\nd *= 100;\nconsole.log(c === d);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22js\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e obj = { \x3cspan class=\x22hljs-attr\x22\x3ea\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e, \x3cspan class=\x22hljs-attr\x22\x3eb\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e };\n\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e { c, d } = obj;\nc *= \x3cspan class=\x22hljs-number\x22\x3e100\x3c\/span\x3e;\nd *= \x3cspan class=\x22hljs-number\x22\x3e100\x3c\/span\x3e;\n\x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(c === d);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这种情况下，我们虽然一眼可以看出最后的 c 和 d 都是 undefined，但是编译器刚开始不知道，所以它只能在最后判等的时候，才能得到结果。而具体判断的逻辑如下图所示：\x3cstrong\x3e我们先检查，操作数是否有 NaN，如果有？那就返回 false 吧\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016802123\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016802123\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e所以 \x3ccode\x3eNumber.isNaN\x3c\/code\x3e 的 polyfill 可以怎么实现呢？\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Number.isNaN = function(value) {\n  return value !== value;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs fortran\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3eNumber\x3c\/span\x3e.isNaN = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(value)\x3c\/span\x3e\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3evalue\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e!== value;\x3c\/span\x3e\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e就是这么简单 😎\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3e参考文献\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22http:\/\/www.ruanyifeng.com\/blog\/2016\/11\/byte-order.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e理解字节序 - 阮一峰的网络日志\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/medium.com\/engineering-housing\/nan-is-not-equal-to-nan-771321379694\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eNaN is not equal to NaN\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/en.wikipedia.org\/wiki\/NaN#Quiet_NaN\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eQuiet NaN\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22https:\/\/book.douban.com\/subject\/26912767\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e深入理解计算机系统（原书第 3 版） (豆瓣)\x3c\/a\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bV50Mk?w=640\x26amp;h=400\x22 src=\x22https:\/\/static.alili.tech\/img\/bV50Mk?w=640\x26amp;h=400\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>Under the Hood: NaN of JS</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000016802117">https://segmentfault.com/a/1190000016802117</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/v3dxks3larh/" target="_blank">https://alili.tech/archive/v3dxks3larh/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>