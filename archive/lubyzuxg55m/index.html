<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="React 同构实践与思考"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>React 同构实践与思考 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/lubyzuxg55m/",
				"appid": "1613049289050283", 
				"title": "React 同构实践与思考 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-12T02:30:12"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/nuu192oo477/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/jlycre09agi/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2flubyzuxg55m%2f&text=React%20%e5%90%8c%e6%9e%84%e5%ae%9e%e8%b7%b5%e4%b8%8e%e6%80%9d%e8%80%83"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2flubyzuxg55m%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2flubyzuxg55m%2f&text=React%20%e5%90%8c%e6%9e%84%e5%ae%9e%e8%b7%b5%e4%b8%8e%e6%80%9d%e8%80%83"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2flubyzuxg55m%2f&title=React%20%e5%90%8c%e6%9e%84%e5%ae%9e%e8%b7%b5%e4%b8%8e%e6%80%9d%e8%80%83"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2flubyzuxg55m%2f&is_video=false&description=React%20%e5%90%8c%e6%9e%84%e5%ae%9e%e8%b7%b5%e4%b8%8e%e6%80%9d%e8%80%83"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=React%20%e5%90%8c%e6%9e%84%e5%ae%9e%e8%b7%b5%e4%b8%8e%e6%80%9d%e8%80%83&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2flubyzuxg55m%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2flubyzuxg55m%2f&title=React%20%e5%90%8c%e6%9e%84%e5%ae%9e%e8%b7%b5%e4%b8%8e%e6%80%9d%e8%80%83"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2flubyzuxg55m%2f&title=React%20%e5%90%8c%e6%9e%84%e5%ae%9e%e8%b7%b5%e4%b8%8e%e6%80%9d%e8%80%83"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2flubyzuxg55m%2f&title=React%20%e5%90%8c%e6%9e%84%e5%ae%9e%e8%b7%b5%e4%b8%8e%e6%80%9d%e8%80%83"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2flubyzuxg55m%2f&title=React%20%e5%90%8c%e6%9e%84%e5%ae%9e%e8%b7%b5%e4%b8%8e%e6%80%9d%e8%80%83"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">React 同构实践与思考</h1><div class="meta"><div class="postdate"><time datetime="2019-02-12" itemprop="datePublished">2019-02-12</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e众所周知，目前的 WEB 应用，用户体验要求越来越高，WEB 交互变得越来越丰富！前端可以做的事越来越多，去年 Node 引领了前后端分层的浪潮，而 React 的出现让分层思想可以更多彻底的执行，尤其是 React 同构 (Universal or Isomorphic) 这个黑科技到底是怎么实现的，我们来一探究竟。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3eReact 服务端方法\x3c\/h2\x3e\n\x3cp\x3e如果熟悉 React 开发，那么一定对 \x3ccode\x3eReactDOM.render\x3c\/code\x3e 方法不陌生，这是 React 渲染到 DOM 中的方法。\x3c\/p\x3e\n\x3cp\x3e现有的任何开发模式都离不开 DOM 树，如图：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22http:\/\/dt-daily.alicdn.com\/pic\/render-client.png\x22 src=\x22https:\/\/static.alili.techhttp:\/\/dt-daily.alicdn.com\/pic\/render-client.png\x22 alt=\x22客户端渲染\x22 title=\x22客户端渲染\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e服务端渲染就要稍作改动，如图：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22http:\/\/dt-daily.alicdn.com\/pic\/render-server.png\x22 src=\x22https:\/\/static.alili.techhttp:\/\/dt-daily.alicdn.com\/pic\/render-server.png\x22 alt=\x22服务端渲染\x22 title=\x22服务端渲染\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e比较两张图可以看出，服务端渲染需要把 React 的初次渲染放到服务端，让 React 帮我们把业务 component 翻译成 string 类型的 DOM 树，再通过后端语言的 IO 流输出至浏览器。\x3c\/p\x3e\n\x3cp\x3e我们来看 React 官方给我们提供的服务端渲染的API：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eReact.renderToString\x3c\/code\x3e 是把 React 元素转成一个 HTML 字符串，因为服务端渲染已经标识了 reactid，所以在浏览器端再次渲染，React 只是做事件绑定，而不会将所有的 DOM 树重新渲染，这样能带来高性能的页面首次加载！同构黑魔法主要从这个 API 而来。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3eReact.renderToStaticMarkup\x3c\/code\x3e，这个 API 相当于一个简化版的 renderToString，如果你的应用基本上是静态文本，建议用这个方法，少了一大批的 reactid，DOM 树自然精简了，在 IO 流传输上节省一部分流量。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e配合 \x3ccode\x3erenderToString\x3c\/code\x3e 和 \x3ccode\x3erenderToStaticMarkup\x3c\/code\x3e 使用，\x3ccode\x3ecreateElement\x3c\/code\x3e 返回的 ReactElement 作为参数传递给前面两个方法。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3eReact 玩转 Node\x3c\/h2\x3e\n\x3cp\x3e有了解决方案，我们就可以动手在 Node 来做一些事了。后面会利用 KOA 这个 Node 框架来做实践。\x3c\/p\x3e\n\x3cp\x3e我们新建应用，目录结构如下，\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22react-server-koa-simple\n├── app\n│   ├── assets\n│   │   ├── build\n│   │   ├── src\n│   │   │    ├── img\n│   │   │    ├── js\n│   │   │    └── css\n│   │   ├── package.json\n│   │   └── webpack.config.js\n│   ├── middleware\n│   │   └── static.js（前端静态资源托管中间件）\n│   ├── plugin\n│   │   └── reactview（reactview 插件）\n│   └── views\n│       ├── layout\n│       │    └── Default.js\n│       ├── Device.js\n│       └── Home.js\n├── .babelrc\n├── .gitgnore\n├── app.js\n├── package.json\n└── README.md\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs stylus\x22\x3e\x3ccode\x3ereact-server-koa-simple\n├── app\n│   ├── assets\n│   │   ├── build\n│   │   ├── src\n│   │   │    ├── \x3cspan class=\x22hljs-selector-tag\x22\x3eimg\x3c\/span\x3e\n│   │   │    ├── js\n│   │   │    └── css\n│   │   ├── package\x3cspan class=\x22hljs-selector-class\x22\x3e.json\x3c\/span\x3e\n│   │   └── webpack\x3cspan class=\x22hljs-selector-class\x22\x3e.config\x3c\/span\x3e\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e\n│   ├── middleware\n│   │   └── static.js（前端静态资源托管中间件）\n│   ├── plugin\n│   │   └── reactview（reactview 插件）\n│   └── views\n│       ├── layout\n│       │    └── Default\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e\n│       ├── Device\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e\n│       └── Home\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e\n├── \x3cspan class=\x22hljs-selector-class\x22\x3e.babelrc\x3c\/span\x3e\n├── \x3cspan class=\x22hljs-selector-class\x22\x3e.gitgnore\x3c\/span\x3e\n├── app\x3cspan class=\x22hljs-selector-class\x22\x3e.js\x3c\/span\x3e\n├── package\x3cspan class=\x22hljs-selector-class\x22\x3e.json\x3c\/span\x3e\n└── README\x3cspan class=\x22hljs-selector-class\x22\x3e.md\x3c\/span\x3e\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e首先，我们需要实现一个 KOA 插件，用来实现 React 作为服务端模板的渲染工作，方法是将 \x3ccode\x3erender\x3c\/code\x3e 方法插入到 app 上下文中，目的是在 controller 层中调用，\x3ccode\x3ethis.render(viewFileName, props, children)\x3c\/code\x3e 并通过 \x3ccode\x3ethis.body\x3c\/code\x3e 输出文档流至浏览器端。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/*\n * koa-react-view.js\n * 提供 react server render 功能\n * {\n *   options : {\n *     viewpath: viewpath,                 \/\/ the root directory of view files\n *     doctype: \x27\x3c!DOCTYPE html\x3e\x27,\n *     extname: \x27.js\x27,                     \/\/ view层直接渲染文件名后缀\n *     writeResp: true,                    \/\/ 是否需要在view层直接输出\n *   }\n * }\n *\/\nmodule.exports = function(app) {\n  const opts = app.config.reactview || {};\n  assert(opts \x26amp;\x26amp; opts.viewpath \x26amp;\x26amp; util.isString(opts.viewpath), \x27[reactview] viewpath is required, please check config!\x27);\n  const options = Object.assign({}, defaultOpts, opts);\n\n  app.context.render = function(filename, _locals, children) {\n    let filepath = path.join(options.viewpath, filename);\n\n    let render = opts.internals\n      ? ReactDOMServer.renderToString\n      : ReactDOMServer.renderToStaticMarkup;\n\n    \/\/ merge koa state\n    let props = Object.assign({}, this.state, _locals);\n    let markup = options.doctype || \x27\x3c!DOCTYPE html\x3e\x27;\n\n    try {\n      let component = require(filepath);\n      \/\/ Transpiled ES6 may export components as { default: Component }\n      component = component.default || component;\n      markup \x2b= render(React.createElement(component, props, children));\n    } catch (err) {\n      err.code = \x27REACT\x27;\n      throw err;\n    }\n    if (options.writeResp) {\n      this.type = \x27html\x27;\n      this.body = markup;\n    }\n    return markup;\n  };\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/*\n * koa-react-view.js\n * 提供 react server render 功能\n * {\n *   options : {\n *     viewpath: viewpath,                 \/\/ the root directory of view files\n *     doctype: \x27\x26lt;!DOCTYPE html\x26gt;\x27,\n *     extname: \x27.js\x27,                     \/\/ view层直接渲染文件名后缀\n *     writeResp: true,                    \/\/ 是否需要在view层直接输出\n *   }\n * }\n *\/\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3emodule\x3c\/span\x3e.exports = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eapp\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e opts = app.config.reactview || {};\n  assert(opts \x26amp;\x26amp; opts.viewpath \x26amp;\x26amp; util.isString(opts.viewpath), \x3cspan class=\x22hljs-string\x22\x3e\x27[reactview] viewpath is required, please check config!\x27\x3c\/span\x3e);\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e options = \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.assign({}, defaultOpts, opts);\n\n  app.context.render = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3efilename, _locals, children\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e filepath = path.join(options.viewpath, filename);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e render = opts.internals\n      ? ReactDOMServer.renderToString\n      : ReactDOMServer.renderToStaticMarkup;\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ merge koa state\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e props = \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.assign({}, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state, _locals);\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e markup = options.doctype || \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;!DOCTYPE html\x26gt;\x27\x3c\/span\x3e;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3etry\x3c\/span\x3e {\n      \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e component = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(filepath);\n      \x3cspan class=\x22hljs-comment\x22\x3e\/\/ Transpiled ES6 may export components as { default: Component }\x3c\/span\x3e\n      component = component.default || component;\n      markup \x2b= render(React.createElement(component, props, children));\n    } \x3cspan class=\x22hljs-keyword\x22\x3ecatch\x3c\/span\x3e (err) {\n      err.code = \x3cspan class=\x22hljs-string\x22\x3e\x27REACT\x27\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-keyword\x22\x3ethrow\x3c\/span\x3e err;\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (options.writeResp) {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.type = \x3cspan class=\x22hljs-string\x22\x3e\x27html\x27\x3c\/span\x3e;\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.body = markup;\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e markup;\n  };\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e然后，我们来写用 React 实现的服务端的 Components，\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/*\n * react-server-koa-simple - app\/views\/Home.js\n * home模板\n *\/\n\nrender() {\n  let { microdata, mydata } = this.props;\n  let homeJs = `${microdata.styleDomain}\/build\/${microdata.styleVersion}\/js\/home.js`;\n  let scriptUrls = [homeJs];\n\n  return (\n    \x3cDefault\n      microdata={microdata}\n      scriptUrls={scriptUrls}\n      title={\x26quot;demo\x26quot;}\x3e\n      \x3cdiv id=\x26quot;demoApp\x26quot;\n        data-microdata={JSON.stringify(microdata)}\n        data-mydata={JSON.stringify(mydata)}\x3e\n        \x3cContent mydata={mydata} microdata={microdata} \/\x3e\n      \x3c\/div\x3e\n    \x3c\/Default\x3e\n  );\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/*\n * react-server-koa-simple - app\/views\/Home.js\n * home模板\n *\/\x3c\/span\x3e\n\nrender() {\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e { microdata, mydata } = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.props;\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e homeJs = \x3cspan class=\x22hljs-string\x22\x3e`\x3cspan class=\x22hljs-subst\x22\x3e${microdata.styleDomain}\x3c\/span\x3e\/build\/\x3cspan class=\x22hljs-subst\x22\x3e${microdata.styleVersion}\x3c\/span\x3e\/js\/home.js`\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e scriptUrls = [homeJs];\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n    \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eDefault\x3c\/span\x3e\n      \x3cspan class=\x22hljs-attr\x22\x3emicrodata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{microdata}\x3c\/span\x3e\n      \x3cspan class=\x22hljs-attr\x22\x3escriptUrls\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{scriptUrls}\x3c\/span\x3e\n      \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{\x3c\/span\x3e\x22\x3cspan class=\x22hljs-attr\x22\x3edemo\x3c\/span\x3e\x22}\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eid\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22demoApp\x22\x3c\/span\x3e\n        \x3cspan class=\x22hljs-attr\x22\x3edata-microdata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{JSON.stringify(microdata)}\x3c\/span\x3e\n        \x3cspan class=\x22hljs-attr\x22\x3edata-mydata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{JSON.stringify(mydata)}\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eContent\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3emydata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{mydata}\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3emicrodata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{microdata}\x3c\/span\x3e \/\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eDefault\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n  );\n}\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这里做了几件事，初始化 DOM 树，用 data 属性作服务端数据埋点，渲染前后端公共 Content 模块，引用前端模块\x3c\/p\x3e\n\x3cp\x3e而客户端，我们就可以很方便地拿到了服务端的数据，可以直接拿来使用，\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22import ReactDOM from \x27react-dom\x27;\nimport Content from \x27.\/components\/Content.js\x27;\n\nconst microdata = JSON.parse(appEle.getAttribute(\x27data-microdata\x27));\nconst mydata = JSON.parse(appEle.getAttribute(\x27data-mydata\x27));\n\nReactDOM.render(\n  \x3cContent mydata={mydata} microdata={microdata} \/\x3e,\n  document.getElementById(\x27demoApp\x27)\n);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e ReactDOM \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27react-dom\x27\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e Content \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27.\/components\/Content.js\x27\x3c\/span\x3e;\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e microdata = \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.parse(appEle.getAttribute(\x3cspan class=\x22hljs-string\x22\x3e\x27data-microdata\x27\x3c\/span\x3e));\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e mydata = \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.parse(appEle.getAttribute(\x3cspan class=\x22hljs-string\x22\x3e\x27data-mydata\x27\x3c\/span\x3e));\n\nReactDOM.render(\n  \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eContent\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3emydata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{mydata}\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3emicrodata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{microdata}\x3c\/span\x3e \/\x26gt;\x3c\/span\x3e,\n  document.getElementById(\x27demoApp\x27)\n);\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e然后，到了启动一个简单的 koa 应用的时候，完善入口 app.js 来验证我们的想法，\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const koa = require(\x27koa\x27);\nconst koaRouter = require(\x27koa-router\x27);\nconst path = require(\x27path\x27);\nconst reactview = require(\x27.\/app\/plugin\/reactview\/app.js\x27);\nconst Static = require(\x27.\/app\/middleware\/static.js\x27);\n\nconst App = ()=\x3e {\n  let app = koa();\n  let router = koaRouter();\n\n  \/\/ 初始化 \/home 路由 dispatch 的 generator\n  router.get(\x27\/home\x27, function*() {\n    \/\/ 执行view插件\n    this.body = this.render(\x27Home\x27, {\n      microdata: {\n        domain: \x26quot;\/\/localhost:3000\x26quot;\n      },\n      mydata: {\n        nick: \x27server render body\x27\n      }\n    });\n  });\n  app.use(router.routes()).use(router.allowedMethods());\n\n  \/\/ 注入 reactview\n  const viewpath = path.join(__dirname, \x27app\/views\x27);\n  app.config = {\n    reactview: {\n      viewpath: viewpath,                 \/\/ the root directory of view files\n      doctype: \x27\x3c!DOCTYPE html\x3e\x27,\n      extname: \x27.js\x27,                     \/\/ view层直接渲染文件名后缀\n      beautify: true,                     \/\/ 是否需要对dom结构进行格式化\n      writeResp: false,                    \/\/ 是否需要在view层直接输出\n    }\n  }\n  reactview(app);\n\n  return app;\n};\n\nconst createApp = ()=\x3e {\n  const app = App();\n\n  \/\/ http服务端口监听\n  app.listen(3000, ()=\x3e {\n    console.log(\x273000 is listening!\x27);\n  });\n\n  return app;\n};\ncreateApp();\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs typescript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e koa = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e koaRouter = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27koa-router\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e path = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27path\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e reactview = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/app\/plugin\/reactview\/app.js\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e Static = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/app\/middleware\/static.js\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e App = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e=\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e app = koa();\n  \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e router = koaRouter();\n\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 初始化 \/home 路由 dispatch 的 generator\x3c\/span\x3e\n  router.get(\x3cspan class=\x22hljs-string\x22\x3e\x27\/home\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e*(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 执行view插件\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.body = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.render(\x3cspan class=\x22hljs-string\x22\x3e\x27Home\x27\x3c\/span\x3e, {\n      microdata: {\n        domain: \x3cspan class=\x22hljs-string\x22\x3e\x22\/\/localhost:3000\x22\x3c\/span\x3e\n      },\n      mydata: {\n        nick: \x3cspan class=\x22hljs-string\x22\x3e\x27server render body\x27\x3c\/span\x3e\n      }\n    });\n  });\n  app.use(router.routes()).use(router.allowedMethods());\n\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 注入 reactview\x3c\/span\x3e\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e viewpath = path.join(__dirname, \x3cspan class=\x22hljs-string\x22\x3e\x27app\/views\x27\x3c\/span\x3e);\n  app.config = {\n    reactview: {\n      viewpath: viewpath,                 \x3cspan class=\x22hljs-comment\x22\x3e\/\/ the root directory of view files\x3c\/span\x3e\n      doctype: \x3cspan class=\x22hljs-string\x22\x3e\x27\x26lt;!DOCTYPE html\x26gt;\x27\x3c\/span\x3e,\n      extname: \x3cspan class=\x22hljs-string\x22\x3e\x27.js\x27\x3c\/span\x3e,                     \x3cspan class=\x22hljs-comment\x22\x3e\/\/ view层直接渲染文件名后缀\x3c\/span\x3e\n      beautify: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,                     \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 是否需要对dom结构进行格式化\x3c\/span\x3e\n      writeResp: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,                    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 是否需要在view层直接输出\x3c\/span\x3e\n    }\n  }\n  reactview(app);\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e app;\n};\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e createApp = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e=\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e app = App();\n\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ http服务端口监听\x3c\/span\x3e\n  app.listen(\x3cspan class=\x22hljs-number\x22\x3e3000\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e()\x3c\/span\x3e=\x26gt;\x3c\/span\x3e {\n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(\x3cspan class=\x22hljs-string\x22\x3e\x273000 is listening!\x27\x3c\/span\x3e);\n  });\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e app;\n};\ncreateApp();\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e现在，访问上面预先设置好的路由，\x3ca href=\x22http:\/\/localhost:3000\/home\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttp:\/\/localhost:3000\/home\x3c\/a\x3e 来验证 server render，\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e服务端： \x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/img.alicdn.com\/tps\/TB1LcVBLFXXXXazXpXXXXXXXXXX-1872-844.png\x22 src=\x22https:\/\/static.alili.techhttps:\/\/img.alicdn.com\/tps\/TB1LcVBLFXXXXazXpXXXXXXXXXX-1872-844.png\x22 alt=\x22server-dom\x22 title=\x22server-dom\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e浏览器端： \x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22https:\/\/dt-daily.alicdn.com\/browserdom.png\x22 src=\x22https:\/\/static.alili.techhttps:\/\/dt-daily.alicdn.com\/browserdom.png\x22 alt=\x22browser-dom\x22 title=\x22browser-dom\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3ereact-router 和 koa-router 统一\x3c\/h2\x3e\n\x3cp\x3e我们已经建立了服务端渲染的基础了，接着再考虑下如何把后端和前端的路由做统一。\x3c\/p\x3e\n\x3cp\x3e假设我们的路由设置成 \x3ccode\x3e\/device\/:deviceID\x3c\/code\x3e 这种形式，\x3cbr\x3e那么服务端是这么来实现的，\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 初始化 device\/:deviceID 路由 dispatch 的 generator\nrouter.get(\x27\/device\/:deviceID\x27, function*() {\n  \/\/ 执行view插件\n  let deviceID = this.params.deviceID;\n  this.body = this.render(\x27Device\x27, {\n    isServer: true,\n    microdata: microdata,\n    mydata: {\n      path: this.path,\n      deviceID: deviceID,\n    }\n  });\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 初始化 device\/:deviceID 路由 dispatch 的 generator\x3c\/span\x3e\nrouter.\x3cspan class=\x22hljs-keyword\x22\x3eget\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27\/device\/:deviceID\x27\x3c\/span\x3e, function*() {\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 执行view插件\x3c\/span\x3e\n  let deviceID = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.params.deviceID;\n  \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.body = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.render(\x3cspan class=\x22hljs-string\x22\x3e\x27Device\x27\x3c\/span\x3e, {\n    isServer: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n    microdata: microdata,\n    mydata: {\n      path: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.path,\n      deviceID: deviceID,\n    }\n  });\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e以及服务端 View 模板，\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22render() {\n  const { microdata, mydata, isServer } = this.props;\n  const deviceJs = `${microdata.styleDomain}\/build\/${microdata.styleVersion}\/js\/device.js`;\n  const scriptUrls = [deviceJs];\n\n  return (\n    \x3cDefault\n      microdata={microdata}\n      scriptUrls={scriptUrls}\n      title={\x26quot;demo\x26quot;}\x3e\n      \x3cdiv id=\x26quot;demoApp\x26quot;\n        data-microdata={JSON.stringify(microdata)}\n        data-mydata={JSON.stringify(mydata)}\x3e\n        \x3cIso\n          microdata={microdata}\n          mydata={mydata}\n          isServer={isServer}\n        \/\x3e\n      \x3c\/div\x3e\n    \x3c\/Default\x3e\n  );\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3erender() {\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e { microdata, mydata, isServer } = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.props;\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e deviceJs = \x3cspan class=\x22hljs-string\x22\x3e`\x3cspan class=\x22hljs-subst\x22\x3e${microdata.styleDomain}\x3c\/span\x3e\/build\/\x3cspan class=\x22hljs-subst\x22\x3e${microdata.styleVersion}\x3c\/span\x3e\/js\/device.js`\x3c\/span\x3e;\n  \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e scriptUrls = [deviceJs];\n\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n    \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eDefault\x3c\/span\x3e\n      \x3cspan class=\x22hljs-attr\x22\x3emicrodata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{microdata}\x3c\/span\x3e\n      \x3cspan class=\x22hljs-attr\x22\x3escriptUrls\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{scriptUrls}\x3c\/span\x3e\n      \x3cspan class=\x22hljs-attr\x22\x3etitle\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{\x3c\/span\x3e\x22\x3cspan class=\x22hljs-attr\x22\x3edemo\x3c\/span\x3e\x22}\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eid\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22demoApp\x22\x3c\/span\x3e\n        \x3cspan class=\x22hljs-attr\x22\x3edata-microdata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{JSON.stringify(microdata)}\x3c\/span\x3e\n        \x3cspan class=\x22hljs-attr\x22\x3edata-mydata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{JSON.stringify(mydata)}\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eIso\x3c\/span\x3e\n          \x3cspan class=\x22hljs-attr\x22\x3emicrodata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{microdata}\x3c\/span\x3e\n          \x3cspan class=\x22hljs-attr\x22\x3emydata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{mydata}\x3c\/span\x3e\n          \x3cspan class=\x22hljs-attr\x22\x3eisServer\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{isServer}\x3c\/span\x3e\n        \/\x26gt;\x3c\/span\x3e\n      \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eDefault\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n  );\n}\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e前端 app 入口：app.js\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22function getServerData(key) {\n  return JSON.parse(appEle.getAttribute(`data-${key}`));\n};\n\n\/\/ 从服务端埋点处 \x3cdiv id=\x26quot;demoApp\x26quot;\x3e 获取 microdata, mydata\nlet microdata = getServerData(\x27microdata\x27);\nlet mydata = getServerData(\x27mydata\x27);\n\nReactDOM.render(\n  \x3cIso microdata={microdata} mydata={mydata} isServer={false} \/\x3e,\n  document.getElementById(\x27demoApp\x27));\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3egetServerData\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ekey\x3c\/span\x3e) \x3c\/span\x3e{\n  \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eJSON\x3c\/span\x3e.parse(appEle.getAttribute(\x3cspan class=\x22hljs-string\x22\x3e`data-\x3cspan class=\x22hljs-subst\x22\x3e${key}\x3c\/span\x3e`\x3c\/span\x3e));\n};\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 从服务端埋点处 \x26lt;div id=\x22demoApp\x22\x26gt; 获取 microdata, mydata\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e microdata = getServerData(\x3cspan class=\x22hljs-string\x22\x3e\x27microdata\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e mydata = getServerData(\x3cspan class=\x22hljs-string\x22\x3e\x27mydata\x27\x3c\/span\x3e);\n\nReactDOM.render(\n  \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eIso\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3emicrodata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{microdata}\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3emydata\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{mydata}\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eisServer\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{false}\x3c\/span\x3e \/\x26gt;\x3c\/span\x3e,\n  document.getElementById(\x27demoApp\x27));\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e前后端公用的 Iso.js 模块，前端路由同样设置成 \x3ccode\x3e\/device\/:deviceID\x3c\/code\x3e：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22class Iso extends Component {\n  static propTypes = {\n    \/\/ ...\n  };\n\n  \/\/ 包裹 Route 的 Component，目的是注入服务端传入的 props\n  wrapComponent(Component) {\n    const { microdata, mydata } = this.props;\n\n    return React.createClass({\n      render() {\n        return React.createElement(Component, {\n          microdata: microdata,\n          mydata: mydata\n        }, this.props.children);\n      }\n    });\n  }\n\n  \/\/ LayoutView 为路由的布局; DeviceView 为参数处理模块\n  render() {\n    const { isServer, mydata } = this.props;\n\n    return (\n      \x3cRouter history={isServer ? createMemoryHistory(mydata.path || \x27\/\x27) : browserHistory}\x3e\n        \x3cRoute path=\x26quot;\/\x26quot;\n          component={this.wrapComponent(LayoutView)}\x3e\n          \x3cIndexRoute component={this.wrapComponent(DeviceView)} \/\x3e\n          \x3cRoute path=\x26quot;\/device\/:deviceID\x26quot; component={DeviceView} \/\x3e\n        \x3c\/Route\x3e\n      \x3c\/Router\x3e\n    );\n  }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs scala\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eIso\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eComponent\x3c\/span\x3e \x3c\/span\x3e{\n  static propTypes = {\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ...\x3c\/span\x3e\n  };\n\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 包裹 Route 的 Component，目的是注入服务端传入的 props\x3c\/span\x3e\n  wrapComponent(\x3cspan class=\x22hljs-type\x22\x3eComponent\x3c\/span\x3e) {\n    const { microdata, mydata } = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.props;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eReact\x3c\/span\x3e.createClass({\n      render() {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eReact\x3c\/span\x3e.createElement(\x3cspan class=\x22hljs-type\x22\x3eComponent\x3c\/span\x3e, {\n          microdata: microdata,\n          mydata: mydata\n        }, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.props.children);\n      }\n    });\n  }\n\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ LayoutView 为路由的布局; DeviceView 为参数处理模块\x3c\/span\x3e\n  render() {\n    const { isServer, mydata } = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.props;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n      \x26lt;\x3cspan class=\x22hljs-type\x22\x3eRouter\x3c\/span\x3e history={isServer ? createMemoryHistory(mydata.path || \x27\/\x27) : browserHistory}\x26gt;\n        \x26lt;\x3cspan class=\x22hljs-type\x22\x3eRoute\x3c\/span\x3e path=\x3cspan class=\x22hljs-string\x22\x3e\x22\/\x22\x3c\/span\x3e\n          component={\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.wrapComponent(\x3cspan class=\x22hljs-type\x22\x3eLayoutView\x3c\/span\x3e)}\x26gt;\n          \x26lt;\x3cspan class=\x22hljs-type\x22\x3eIndexRoute\x3c\/span\x3e component={\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.wrapComponent(\x3cspan class=\x22hljs-type\x22\x3eDeviceView\x3c\/span\x3e)} \/\x26gt;\n          \x26lt;\x3cspan class=\x22hljs-type\x22\x3eRoute\x3c\/span\x3e path=\x3cspan class=\x22hljs-string\x22\x3e\x22\/device\/:deviceID\x22\x3c\/span\x3e component={\x3cspan class=\x22hljs-type\x22\x3eDeviceView\x3c\/span\x3e} \/\x26gt;\n        \x26lt;\/\x3cspan class=\x22hljs-type\x22\x3eRoute\x3c\/span\x3e\x26gt;\n      \x26lt;\/\x3cspan class=\x22hljs-type\x22\x3eRouter\x3c\/span\x3e\x26gt;\n    );\n  }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这样我就实现了服务端和前端路由的同构！\x3c\/p\x3e\n\x3cp\x3e无论你是初次访问这些资源路径： \x3ccode\x3e\/device\/all， \/device\/pc， \/device\/wireless\x3c\/code\x3e，还是在页面手动切换这些资源路径效果都是一样的，既保证了初次渲染有符合预期的 DOM 输出的用户体验，又保证了代码的简洁性，最重要的是前后端代码是一套，并且由一位工程师开发，有没有觉得很棒？\x3c\/p\x3e\n\x3cp\x3e其中注意几点：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3eIso 的 render 模块需要判断isServer，服务端用createMemoryHistory，前端用browserHistory；\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3ereact-router 的 component 如果需要注入 props 必须对其进行包裹 wrapComponent。因为服务端渲染的数据需要通过传 props 的方式，而react-router-route 只提供了 component，并不支持继续追加 props。截取 Route 的源码，\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22propTypes: {\n  path: string,\n  component: _PropTypes.component,\n  components: _PropTypes.components,\n  getComponent: func,\n  getComponents: func\n},\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs dts\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-symbol\x22\x3epropTypes:\x3c\/span\x3e {\n\x3cspan class=\x22hljs-symbol\x22\x3e  path:\x3c\/span\x3e string,\n\x3cspan class=\x22hljs-symbol\x22\x3e  component:\x3c\/span\x3e _PropTypes.component,\n\x3cspan class=\x22hljs-symbol\x22\x3e  components:\x3c\/span\x3e _PropTypes.components,\n\x3cspan class=\x22hljs-symbol\x22\x3e  getComponent:\x3c\/span\x3e func,\n\x3cspan class=\x22hljs-symbol\x22\x3e  getComponents:\x3c\/span\x3e func\n},\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e为什么服务端获取数据不和前端保持一致，在 Component 里作数据绑定，使用 fetchData 和数据绑定！只能说，你可以大胆的假设。接下来就是我们要继续探讨的同构model！\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e同构数据处理的探讨\x3c\/h2\x3e\n\x3cp\x3e我们都知道，浏览器端获取数据需要发起 ajax 请求，实际上发起的请求 URL 就是对应服务端一个路由控制器。\x3c\/p\x3e\n\x3cp\x3eReact 是有生命周期的，官方给我们指出的绑定 Model，fetchData 应该在 \x3ccode\x3ecomponentDidMount\x3c\/code\x3e 里来进行。在服务端，React 是不会去执行\x3ccode\x3ecomponentDidMount\x3c\/code\x3e 方法的，因为，React 的 \x3ccode\x3erenderTranscation\x3c\/code\x3e 分成两块： \x3ccode\x3eReactReconcileTransaction\x3c\/code\x3e 和\x3ccode\x3eReactServerRenderingTransaction\x3c\/code\x3e，其在服务端的实现移除掉了在浏览器端的一些特定方法。\x3c\/p\x3e\n\x3cp\x3e而服务端处理数据是线性的，是不可逆的，发起请求 \x26gt; 去数据库获取数据 \x26gt; 业务逻辑处理 \x26gt; 组装成 html-\x26gt; IO流输出给浏览器。显然，服务端和浏览器端是矛盾的！\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3e实验的方案\x3c\/h2\x3e\n\x3cp\x3e你或许会想到利用 \x3ccode\x3eReactClass\x3c\/code\x3e 提供的 statics 来做点文章，React 确实提供了入口，不仅能包裹静态属性，还能包裹静态方法，并且能 DEFINE_MANY：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/**\n * An object containing properties and methods that should be defined on\n * the component\x27s constructor instead of its prototype (static methods).\n *\n * @type {object}\n * @optional\n *\/\nstatics: SpecPolicy.DEFINE_MANY,\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs elm\x22\x3e\x3ccode\x3e\/**\n * \x3cspan class=\x22hljs-type\x22\x3eAn\x3c\/span\x3e object containing properties and methods that should be defined on\n * the component\x27s constructor instead \x3cspan class=\x22hljs-keyword\x22\x3eof\x3c\/span\x3e its proto\x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e (static methods).\n *\n * @\x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e {object}\n * @optional\n *\/\n\x3cspan class=\x22hljs-title\x22\x3estatics\x3c\/span\x3e: \x3cspan class=\x22hljs-type\x22\x3eSpecPolicy\x3c\/span\x3e.\x3cspan class=\x22hljs-type\x22\x3eDEFINE_MANY\x3c\/span\x3e,\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e利用 statics 把我们的组件扩展成这样，\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22class ContentView extends Component {\n  statics: {\n    fetchData: function (callback) {\n      ContentData.fetch().then((data)=\x3e {\n        callback(data);\n      });\n    }\n  };\n  \/\/ 浏览器端这样获取数据\n  componentDidMount() {\n    this.constructor.fetchData((data)=\x3e {\n      this.setState({\n        data: data\n      });\n    });\n  }\n  ...\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs scala\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eContentView\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eComponent\x3c\/span\x3e \x3c\/span\x3e{\n  statics: {\n    fetchData: function (callback) {\n      \x3cspan class=\x22hljs-type\x22\x3eContentData\x3c\/span\x3e.fetch().then((data)=\x26gt; {\n        callback(data);\n      });\n    }\n  };\n  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 浏览器端这样获取数据\x3c\/span\x3e\n  componentDidMount() {\n    \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.constructor.fetchData((data)=\x26gt; {\n      \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setState({\n        data: data\n      });\n    });\n  }\n  ...\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3eContentData.fetch() 需要实现两套：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e服务端：封装服务端service层方法\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e浏览器端：封装ajax或Fetch方法\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e服务端调用：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22require(\x27ContentView\x27).fetchData((data)=\x3e {\n  this.body = this.render(\x27Device\x27, {\n    isServer: true,\n    microdata: microdata,\n    mydata: data\n  });\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs coffeescript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27ContentView\x27\x3c\/span\x3e).fetchData(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e(data)\x3c\/span\x3e=\x26gt;\x3c\/span\x3e {\n  \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.body = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.render(\x3cspan class=\x22hljs-string\x22\x3e\x27Device\x27\x3c\/span\x3e, {\n    isServer: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n    microdata: microdata,\n    mydata: data\n  });\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这样可以解决数据层的同构！但我并不认为这是一个好的方法，好像回到 JSP 时代。\x3c\/p\x3e\n\x3cp\x3e我们团队现在使用的方法：\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22http:\/\/dt-daily.alicdn.com\/pic\/iso-data-flow2.png\x22 src=\x22https:\/\/static.alili.techhttp:\/\/dt-daily.alicdn.com\/pic\/iso-data-flow2.png\x22 alt=\x22流程图\x22 title=\x22流程图\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader5\x22\x3e参考资料\x3c\/h2\x3e\n\x3cp\x3e本文完整运行的 \x3ca href=\x22https:\/\/github.com\/huqingliang\/react-server\/tree\/master\/react-server-koa-simple\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e例子\x3c\/a\x3e\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/facebook.github.io\/react\/docs\/getting-started.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/facebook.github.io\/react\/docs\/getting-started.html\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/facebook\/react\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/facebook\/react\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/rackt\/react-router\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/rackt\/react-router\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/koajs\/koa\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/koajs\/koa\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/alexmingoia\/koa-router\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/alexmingoia\/koa-router\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/koajs\/react-view\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/koajs\/react-view\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>React 同构实践与思考</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000004671209">https://segmentfault.com/a/1190000004671209</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/lubyzuxg55m/" target="_blank">https://alili.tech/archive/lubyzuxg55m/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>