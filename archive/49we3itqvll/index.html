<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="Sails.js 内存暴涨 &amp; 源码分析"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>Sails.js 内存暴涨 &amp; 源码分析 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/49we3itqvll/",
				"appid": "1613049289050283", 
				"title": "Sails.js 内存暴涨 &amp; 源码分析 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-12T02:30:12"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/d5my6x5axii/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/q6rl37s7v5/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f49we3itqvll%2f&text=Sails.js%20%e5%86%85%e5%ad%98%e6%9a%b4%e6%b6%a8%20%26%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f49we3itqvll%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f49we3itqvll%2f&text=Sails.js%20%e5%86%85%e5%ad%98%e6%9a%b4%e6%b6%a8%20%26%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f49we3itqvll%2f&title=Sails.js%20%e5%86%85%e5%ad%98%e6%9a%b4%e6%b6%a8%20%26%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f49we3itqvll%2f&is_video=false&description=Sails.js%20%e5%86%85%e5%ad%98%e6%9a%b4%e6%b6%a8%20%26%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=Sails.js%20%e5%86%85%e5%ad%98%e6%9a%b4%e6%b6%a8%20%26%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f49we3itqvll%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f49we3itqvll%2f&title=Sails.js%20%e5%86%85%e5%ad%98%e6%9a%b4%e6%b6%a8%20%26%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f49we3itqvll%2f&title=Sails.js%20%e5%86%85%e5%ad%98%e6%9a%b4%e6%b6%a8%20%26%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f49we3itqvll%2f&title=Sails.js%20%e5%86%85%e5%ad%98%e6%9a%b4%e6%b6%a8%20%26%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f49we3itqvll%2f&title=Sails.js%20%e5%86%85%e5%ad%98%e6%9a%b4%e6%b6%a8%20%26%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Sails.js 内存暴涨 &amp; 源码分析</h1><div class="meta"><div class="postdate"><time datetime="2019-02-12" itemprop="datePublished">2019-02-12</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3eSails.js 是 node 下的一个优秀的 MVC 框架，但是使用 Sails 后，在流量增长时， node 进程有时突然内存暴涨、保持高占用。经过翻阅源码后，发现这个问题与 session \/ GC 都有关系。\x3c\/p\x3e\n\x3cp\x3e\x3cem\x3ePS： 如果是内存泄露引起的，则需要细心检查代码，确定变量能正常回收。\x3c\/em\x3e\x3c\/p\x3e\n\x3ch2\x3e举个栗子\x3c\/h2\x3e\n\x3cp\x3e新建一个 sails app ：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22shell\x22\x3e# new sails app memory\n\x26gt; sails new memeory\n\x26gt; cd memory\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e修改 \x3ccode\x3econfig\/bootstrap.js\x3c\/code\x3e 增加内存快照，写入一个 xls（方便画图）：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3evar fs = require(\x27fs\x27);\n\/\/ (see note below)\nsetInterval(function takeSnapshot() {\n  var mem = process.memoryUsage();\n  fs.appendFile(\x27.\/memorysnapshot.xls\x27, mem.rss \/ 1024 \/ 1024 \x2b \x27\\t\x27\n    \x2b mem.heapUsed \/ 1024 \/ 1024 \x2b \x27\\t\x27 \x2b mem.heapTotal \/ 1024 \/ 1024 \x2b \x27\\n\x27, \x27utf8\x27);\n}, 1000); \/\/ Snapshot every second\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e使用 pm2 启动 sails\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22shell\x22\x3e\x26gt; pm2 start app.js\n\x26gt; pm2 monit\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e使用压测工具，10W 请求，100 并发\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22shell\x22\x3e# ab 压测工具\n\x26gt; ab -n 100000 -c 100 http:\/\/127.0.0.1:1337\/\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e内存占用喜人\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22shell\x22\x3eConcurrency Level:      100\nTime taken for tests:   276.154 seconds\nComplete requests:      100000\nFailed requests:        0\nTotal transferred:      1094761464 bytes\nHTML transferred:       1044700000 bytes\nRequests per second:    362.12 [#\/sec] (mean)\nTime per request:       276.154 [ms] (mean)\nTime per request:       2.762 [ms] (mean, across all concurrent requests)\nTransfer rate:          3871.40 [Kbytes\/sec] received\n\n\nPM2 monitoring (To go further check out https:\/\/app.keymetrics.io)\n\napp                                 [                              ] 0 %%%\n[0] [fork_mode]                     [||||||||                      ] 893.184 MB\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22http:\/\/7xl4og.com1.z0.glb.clouddn.com\/memory-all.png\x22 src=\x22https:\/\/static.alili.techhttp:\/\/7xl4og.com1.z0.glb.clouddn.com\/memory-all.png\x22 alt=\x22all\x22 title=\x22all\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2\x3e关闭 session\x3c\/h2\x3e\n\x3cpre\x3e\x3ccode class=\x22shell\x22\x3e# 关闭 session\n{\n    \x22hooks\x22: {\n      ...\n      \x22session\x22: false,\n      ...\n    }\n}\n\n# 压测结果与之前并没有什么区别\nRequests per second:    381.06 [#\/sec] (mean)\n\n# 但是内存很稳定，基本没增加过\nPM2 monitoring (To go further check out https:\/\/app.keymetrics.io) \n\napp                                 [                              ] 0 %%%\n[0] [fork_mode]                     [||||||||||||||                ] 162.609 MB  \x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22http:\/\/7xl4og.com1.z0.glb.clouddn.com\/memory-shutdown.png\x22 src=\x22https:\/\/static.alili.techhttp:\/\/7xl4og.com1.z0.glb.clouddn.com\/memory-shutdown.png\x22 alt=\x22none\x22 title=\x22none\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e结果感人，关闭不必要的服务并没有给访问主页带来多大的性能提升，但是内存占用下降了非常多，下面就翻翻源码看看 Sails 做了什么。\x3c\/p\x3e\n\x3ch2\x3eSails 做了什么\x3c\/h2\x3e\n\x3ch3\x3e源码\x3c\/h3\x3e\n\x3cp\x3esails的源码结构相当清晰：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3esails@0.12.1\n├── bin\/ # sails command 处理\n├── errors\/ # 定义启动加载错误\n└─┬ lib\/\n  ├─┬ app\/\n  │ ├── configuration\/ # 加载各种参数，补全默认参数\n  │ ├── private\/ # 很多方法，最终都 bind 到 Sails\n  │ ├── ... # other module, all bind to Sails\n  │ ├── Sail.js # main entry\n  │ └── index.js \n  ├─┬ hook\/ # 以下部分加载 sails 的相关配置\n  │ ├── blueprints\/\n  │ ├── controllers\/\n  │ ├── cors\/\n  │ ├── csrf\/\n  │ ├── grunt\/\n  │ ├─┬ http\/\n  │ │ ├── middleware\/ # express middleware 加载的地方\n  │ │ ├── public\/ # favicon.ico\n  │ │ ├── start.js \/ # .listen(port)\n  │ │ ├── initialize.js # load express\n  │ │ └── ...\n  │ ├── i18n\/\n  │ ├── logger\/\n  │ ├── moduleloader\/\n  │ ├── orm\/\n  │ ├── policies\/\n  │ ├── pubsub\/\n  │ ├── request\/\n  │ ├── responses\/\n  │ ├── services\/\n  │ ├── session\/ # session 加载的地方\n  │ ├── userconfig\/\n  │ ├── userhook\/\n  │ ├── views\/\n  │ └── index.js\n  └─┬ hook\/ # router\n    ├── bind.js # bind handler to router\n    ├── req.js # sails.request object\n    ├── res.js # Ensure that response object has a minimum set of reasonable defaults Used primarily as a test fixture.\n    ├── ... # default handler config\n    └── index.js\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3\x3e启动\x3c\/h3\x3e\n\x3cp\x3e从 \x3ccode\x3eapp.js\x3c\/code\x3e 开始\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e...\nsails = require(\x27sails\x27)\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e第一句 \x3ccode\x3erequire\x3c\/code\x3e 创建了一个新的 \x3ccode\x3eSails() (sails\/lib\/Sails.js)\x3c\/code\x3e 对象。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3eSails\x3c\/code\x3e 初始化的时候，巴拉巴拉绑定了一堆模块\/函数，并且继承了 \x3ccode\x3eevents.EventEmitter\x3c\/code\x3e ，加载过程中使用 \x3ccode\x3eemit\/on\x3c\/code\x3e 来执行加载后的动作。\x3c\/p\x3e\n\x3ch4\x3e\x3ccode\x3e.lift\x3c\/code\x3e\x3c\/h4\x3e\n\x3cp\x3e之后 \x3ccode\x3elift\x3c\/code\x3e 启动（其他启动参数也最终都会调用到 \x3ccode\x3elift\x3c\/code\x3e）：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e...\nsails.lift(rc(\x27sails\x27)); # rc 读取 .sailsrc 文件\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3esails\/lib\/lift.js\x3c\/code\x3e 对 Sails 执行加载启动：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e...\nasync.series([\n\n    function(cb) {\n      sails.load(configOverride, cb);\n    },\n\n    sails.initialize\n\n  ], function sailsReady(err, async_data){\n       ... # 这里就会打印 sails 那艘小船\n  })\n...\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3e\x3ccode\x3e.load\x3c\/code\x3e\x3c\/h4\x3e\n\x3cp\x3e方法位于  \x3ccode\x3esails\/lib\/app\/load.js\x3c\/code\x3e ，按顺序加载直到最后启动 Sails ：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e...\n    async.auto({\n\n      config: [Configuration.load], # 默认 config\n\n      hooks: [\x27config\x27, loadHooks], # 加载 hooks\n\n      registry: [\x27hooks\x27, # 每个 hook 的 middleware 绑定到 sails.middleware\n        function populateRegistry(cb) {\n          ...\n        }\n      ],\n\n      router: [\x27registry\x27, sails.router.load] # 绑定 express router\n\n    }, ready__(cb));\n...\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3e\x3ccode\x3eloadHooks\x3c\/code\x3e\x3c\/h4\x3e\n\x3cp\x3e\x3ccode\x3eloadHooks\x3c\/code\x3e 会加载 \x3ccode\x3esails\/lib\/hooks\/\x3c\/code\x3e 下所有需要加载的模块：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e...\n    async.series({\n\n        moduleloader: ...,\n\n        userconfig: ...,\n\n        userhooks: ...,\n      \n        \/\/ other hooks\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其中 \x3ccode\x3esails\/lib\/hooks\/moduleloader\/\x3c\/code\x3e 定义了加载其他各个模块的位置、方法：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3econfigure: function() {\n  sails.config.appPath = sails.config.appPath ? path.resolve(sails.config.appPath) : process.cwd()\n  \/\/ path of config\/controllers\/policies\/...\n  ...\n},\n\n\/\/ function of how to load other hooks\nloadUserConfig\/loadUserHooks\/loadBlueprints\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e除了 \x3ccode\x3euserhooks\x3c\/code\x3e 每个 \x3ccode\x3ehook\x3c\/code\x3e 加载均有时间限制：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3evar timeoutInterval = (sails.config[hooks[id].configKey || id] \x26amp;\x26amp; sails.config[hooks[id].configKey || id]._hookTimeout) || sails.config.hookTimeout || 20000;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e加载其他模块的时候使用的是 \x3ccode\x3easync.each\x3c\/code\x3e ，所以实际加载 \x3ccode\x3ehooks\x3c\/code\x3e 是有个顺序的（可以通过后面的 \x3ccode\x3esilly\x3c\/code\x3e 日志看到）：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3easync.each(_.without(_.keys(hooks), \x27userconfig\x27, \x27moduleloader\x27, \x27userhooks\x27)...)\n\/\/ 而默认 hooks 位于 sails\/lib\/app\/configuration\/default-hooks.js\nmodule.exports = {\n  \x27moduleloader\x27: true,\n  \x27logger\x27: true,\n  \x27request\x27: true,\n  \x27orm\x27: true,\n  ...\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cstrong\x3e注意\x3c\/strong\x3e\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3cstrong\x3e\x3ccode\x3euserhooks\x3c\/code\x3e\x3c\/strong\x3e（用于加载项目 \x3ccode\x3eapi\/hooks\/\x3c\/code\x3e 文件下的模块）的加载顺序为第二，而此时其他模块均未加载，如果此时要设置 \x3ccode\x3esails[${name}]\x3c\/code\x3e ，注意属性名不要和 \x3ccode\x3esails\x3c\/code\x3e 其他模块名相同。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e\x3cstrong\x3e\x3ccode\x3ehooks\/http\/\x3c\/code\x3e\x3c\/strong\x3e 会根据项目配置 \x3ccode\x3econfig\/http.js\x3c\/code\x3e 来加载各个 \x3ccode\x3eexpress\x3c\/code\x3e 中间件，默认加载：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3ewww: ..., \/\/ use \x27serve-static\x27 to cache .tmp\/public\nsession: ..., \/\/ use express-session\nfavicon: ..., \/\/ favicon.ico\nstartRequestTimer: ..., \/\/ just set req._startTime = new Date()\ncookieParser: ...,\ncompress: ..., \/\/ use `compression`\nbodyParser: ..., \/\/ Default use `skipper`\nhandleBodyParserError: ...,\n\/\/ Allow simulation of PUT and DELETE HTTP methods for user agents\nmethodOverride: (function() {...})(),\n\/\/ By default, the express router middleware is installed towards the end.\nrouter: app.router,\npoweredBy: ...,\n\/\/ 404 and 500 middleware should be after `router`, `www`, and `favicon`\n404: function handleUnmatchedRequest(req, res, next) {...},\n500: function handleError(err, req, res, next) {...}\x3c\/code\x3e\x3c\/pre\x3e\n\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e并且注册了 \x3ccode\x3eready\x3c\/code\x3e ：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e\/\/ sails\/lib\/hooks\/http\/initialize.js\n...\nsails.on(\x27ready\x27, startServer);\n...\n\n\/\/ sails\/lib\/hooks\/http\/start.js\n\/\/ startSever 启动 express\n...\nvar liftTimeout = sails.config.liftTimeout || 4000; \/\/ 超时\nsails.hooks.http.server.listen(sails.config.port...)\n...\x3c\/code\x3e\x3c\/pre\x3e\n\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e​\x3c\/p\x3e\n\x3ch4\x3e\x3ccode\x3e.initialize\x3c\/code\x3e\x3c\/h4\x3e\n\x3cp\x3e待所有 \x3ccode\x3e.load\x3c\/code\x3e 执行完毕之后，开始执行 \x3ccode\x3esails.config.bootstrap\x3c\/code\x3e ：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3e\/\/ sails\/lib\/app\/private\/bootstrap.js\n...\n\/\/ 超时\nvar timeoutMs = sails.config.bootstrapTimeout || 2000;\n\/\/ run\n...\n\n\/\/ sails\/lib\/app\/private\/initialize.js\n\/\/ afterBootstrap\n...\n\/\/ 调用 startServer\nsails.emit(\x27ready\x27);\n...\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e如果把 log 级别设置到 \x3ccode\x3esilly\x3c\/code\x3e ，启动的时候就可以看到 \x3ccode\x3ehooks\/router\x3c\/code\x3e 的加载信息：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22python\x22\x3e# load hooks\nverbose: logger hook loaded successfully.\nverbose: request hook loaded successfully.\nverbose: Loading the app\x27s models and adapters...\nverbose: Loading app models...\nverbose: Loading app adapters...\nverbose: responses hook loaded successfully.\nverbose: controllers hook loaded successfully.\nverbose: Loading policy modules from app...\nverbose: Finished loading policy middleware logic.\nverbose: policies hook loaded successfully.\nverbose: services hook loaded successfully.\nverbose: cors hook loaded successfully.\nverbose: session hook loaded successfully.\nverbose: http hook loaded successfully.\nverbose: Starting ORM...\nverbose: orm hook loaded successfully.\nverbose: Built-in hooks are ready.\n# 以下是 register\nverbose: Instantiating registry...\n# 以下是 router\nverbose: Loading router...\nsilly: Binding route ::  all \/* (REQUEST HOOK: addMixins)\n# ready\nverbose: All hooks were loaded successfully.\n# 打印小船\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e以上就是 Sails.js 的启动过程，最终的 \x3ccode\x3ehttp\x3c\/code\x3e 请求都是通过 \x3ccode\x3eexpress\x3c\/code\x3e 来处理。\x3c\/p\x3e\n\x3ch2\x3eSession\x3c\/h2\x3e\n\x3cp\x3e看完源码，来具体看看 \x3ccode\x3esession\x3c\/code\x3e 的部分，定位到 \x3ccode\x3esails\/lib\/hooks\/session\/index.js\x3c\/code\x3e 与 \x3ccode\x3esails\/lib\/hooks\/http\/middleware\/defaults.js\x3c\/code\x3e 。\x3c\/p\x3e\n\x3cp\x3e可以看到， Sails 的 \x3ccode\x3esession\x3c\/code\x3e 默认使用 \x3ccode\x3eexpress-session\x3c\/code\x3e 的 \x3ccode\x3eMemoryStore\x3c\/code\x3e 作为默认 \x3ccode\x3estore\x3c\/code\x3e ：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22javascript\x22\x3efunction MemoryStore() {\n  Store.call(this)\n  this.sessions = Object.create(null)\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e内存妥妥的要爆好吗！\x3c\/p\x3e\n\x3cp\x3e然而项目大都使用 \x3ccode\x3emysql\/redis\x3c\/code\x3e 作 session 存储，并不存在使用 \x3ccode\x3ememory\x3c\/code\x3e 的情况。\x3c\/p\x3e\n\x3ch4\x3e\x3ccode\x3eexpress-session\x3c\/code\x3e\x3c\/h4\x3e\n\x3cp\x3e\x3ccode\x3eexpress-session\x3c\/code\x3e 改写了 \x3ccode\x3ered.end (http.ServerResponse)\x3c\/code\x3e ，并根据条件判断是否 \x3ccode\x3e.touch\x3c\/code\x3e 和 \x3ccode\x3e.save\x3c\/code\x3e  session，\x3ccode\x3ememory\/mysql\/redis\x3c\/code\x3e 三个 session 中间件有不同的实现：\x3c\/p\x3e\n\x3ctable\x3e\n\x3cthead\x3e\x3ctr\x3e\n\x3cth align=\x22left\x22\x3e \x3c\/th\x3e\n\x3cth align=\x22left\x22\x3e\x3ccode\x3e.touch\x3c\/code\x3e\x3c\/th\x3e\n\x3cth align=\x22left\x22\x3e\x3ccode\x3e.save\x3c\/code\x3e\x3c\/th\x3e\n\x3c\/tr\x3e\x3c\/thead\x3e\n\x3ctbody\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3eMemoryStore\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e√\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e√\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3eRedisStore\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e√\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e√\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3ctr\x3e\n\x3ctd align=\x22left\x22\x3eMysqlStore\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e×\x3c\/td\x3e\n\x3ctd align=\x22left\x22\x3e√\x3c\/td\x3e\n\x3c\/tr\x3e\n\x3c\/tbody\x3e\n\x3c\/table\x3e\n\x3cp\x3e那么问题来了，如果 \x3ccode\x3estore.save\x3c\/code\x3e 排队阻塞了，那么\x3cstrong\x3e大量的 \x3ccode\x3ereq\/res\x3c\/code\x3e 就会驻留在内存当中\x3c\/strong\x3e，当流量持续到来时，\x3ccode\x3enode\x3c\/code\x3e 进程占用的内存就会哐哐哐的往上蹭！\x3c\/p\x3e\n\x3ch2\x3e垃圾回收\x3c\/h2\x3e\n\x3cp\x3e\x3ccode\x3esession\x3c\/code\x3e 与 \x3ccode\x3ereq\/res\x3c\/code\x3e 只是保持的内存占用，当被垃圾回收处理之后，这部分内存就会回落。\x3c\/p\x3e\n\x3cp\x3e然而 v8 的垃圾回收触发存在一个阈值，并且各个分代区都设置了默认大小，直接在 \x3ca href=\x22https:\/\/github.com\/nodejs\/node\/blob\/master\/deps\/v8\/src\/heap\/heap.cc#L70\x22 rel=\x22nofollow noreferrer\x22\x3eheap.cc\x3c\/a\x3e 就能看到：\x3c\/p\x3e\n\x3cpre\x3e\x3ccode class=\x22c\x2b\x2b\x22\x3eHeap::Heap()\n    : ...\n      \/\/ semispace_size_ should be a power of 2 and old_generation_size_ should\n      \/\/ be a multiple of Page::kPageSize.\n      reserved_semispace_size_(8 * (kPointerSize \/ 4) * MB),\n      max_semi_space_size_(8 * (kPointerSize \/ 4) * MB),\n      initial_semispace_size_(Page::kPageSize),\n      target_semispace_size_(Page::kPageSize),\n      max_old_generation_size_(700ul * (kPointerSize \/ 4) * MB),\n      initial_old_generation_size_(max_old_generation_size_ \/\n                                   kInitalOldGenerationLimitFactor),\n      old_generation_size_configured_(false),\n      max_executable_size_(256ul * (kPointerSize \/ 4) * MB),\n      ...\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3ev8 的 GC 是 “全停顿”（stop-the-world），对这几个几个不同的堆区，使用不同的垃圾回收算法：\x3c\/p\x3e\n\x3cblockquote\x3e\x3cul\x3e\n\x3cli\x3e\x3cp\x3e新生区：大多数对象被分配在这里。新生区是一个很小的区域，垃圾回收在这个区域非常频繁，与其他区域相独立。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e老生指针区：这里包含大多数可能存在指向其他对象的指针的对象。大多数在新生区存活一段时间之后的对象都会被挪到这里。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e老生数据区：这里存放只包含原始数据的对象（这些对象没有指向其他对象的指针）。字符串、封箱的数字以及未封箱的双精度数字数组，在新生区存活一段时间后会被移动到这里。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e大对象区：这里存放体积超越其他区大小的对象。每个对象有自己mmap产生的内存。垃圾回收器从不移动大对象。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e代码区：代码对象，也就是包含JIT之后指令的对象，会被分配到这里。这是唯一拥有执行权限的内存区（不过如果代码对象因过大而放在大对象区，则该大对象所对应的内存也是可执行的。译注：但是大对象内存区本身不是可执行的内存区）。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3eCell区、属性Cell区、Map区：这些区域存放Cell、属性Cell和Map，每个区域因为都是存放相同大小的元素，因此内存结构很简单。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\x3c\/blockquote\x3e\n\x3cp\x3e对于新生代快速 gc，而老生代则使用 Mark-Sweep（标记清除）和 Mark-Compact（标记整理），所以老生代的内存回收并不实时，在持续的访问压力下，老生代的占用会持续增长，并且\x3cstrong\x3e垃圾内存并没有立刻回收\x3c\/strong\x3e，所以整个 node 进程的内存占用也会蹭蹭的涨。\x3c\/p\x3e\n\x3cp\x3e具体的垃圾回收详解可以参加 \x3ca href=\x22http:\/\/www.jayconrod.com\/posts\/55\/a-tour-of-v8-garbage-collection\x22 rel=\x22nofollow noreferrer\x22\x3e这里\x3c\/a\x3e 或者是 \x3ca href=\x22http:\/\/newhtml.net\/v8-garbage-collection\/\x22 rel=\x22nofollow noreferrer\x22\x3e中文版\x3c\/a\x3e 。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>Sails.js 内存暴涨 &amp; 源码分析</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000004888348">https://segmentfault.com/a/1190000004888348</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/49we3itqvll/" target="_blank">https://alili.tech/archive/49we3itqvll/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>