<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="利用 JavaScript 数据绑定实现一个简单的 MVVM 库"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>利用 JavaScript 数据绑定实现一个简单的 MVVM 库 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/v0zwmlt9l0e/",
				"appid": "1613049289050283", 
				"title": "利用 JavaScript 数据绑定实现一个简单的 MVVM 库 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-12T02:30:12"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/hpebislfunw/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/ck6mnll6p5j/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fv0zwmlt9l0e%2f&text=%e5%88%a9%e7%94%a8%20JavaScript%20%e6%95%b0%e6%8d%ae%e7%bb%91%e5%ae%9a%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20MVVM%20%e5%ba%93"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fv0zwmlt9l0e%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fv0zwmlt9l0e%2f&text=%e5%88%a9%e7%94%a8%20JavaScript%20%e6%95%b0%e6%8d%ae%e7%bb%91%e5%ae%9a%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20MVVM%20%e5%ba%93"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fv0zwmlt9l0e%2f&title=%e5%88%a9%e7%94%a8%20JavaScript%20%e6%95%b0%e6%8d%ae%e7%bb%91%e5%ae%9a%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20MVVM%20%e5%ba%93"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fv0zwmlt9l0e%2f&is_video=false&description=%e5%88%a9%e7%94%a8%20JavaScript%20%e6%95%b0%e6%8d%ae%e7%bb%91%e5%ae%9a%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20MVVM%20%e5%ba%93"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%88%a9%e7%94%a8%20JavaScript%20%e6%95%b0%e6%8d%ae%e7%bb%91%e5%ae%9a%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20MVVM%20%e5%ba%93&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fv0zwmlt9l0e%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fv0zwmlt9l0e%2f&title=%e5%88%a9%e7%94%a8%20JavaScript%20%e6%95%b0%e6%8d%ae%e7%bb%91%e5%ae%9a%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20MVVM%20%e5%ba%93"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fv0zwmlt9l0e%2f&title=%e5%88%a9%e7%94%a8%20JavaScript%20%e6%95%b0%e6%8d%ae%e7%bb%91%e5%ae%9a%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20MVVM%20%e5%ba%93"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fv0zwmlt9l0e%2f&title=%e5%88%a9%e7%94%a8%20JavaScript%20%e6%95%b0%e6%8d%ae%e7%bb%91%e5%ae%9a%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20MVVM%20%e5%ba%93"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fv0zwmlt9l0e%2f&title=%e5%88%a9%e7%94%a8%20JavaScript%20%e6%95%b0%e6%8d%ae%e7%bb%91%e5%ae%9a%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%20MVVM%20%e5%ba%93"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">利用 JavaScript 数据绑定实现一个简单的 MVVM 库</h1><div class="meta"><div class="postdate"><time datetime="2019-02-12" itemprop="datePublished">2019-02-12</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3eMVVM 是 Web 前端一种非常流行的开发模式，利用 MVVM 可以使我们的代码更专注于处理业务逻辑而不是去关心 DOM 操作。目前著名的 MVVM 框架有 vue, avalon , angular 等，这些框架各有千秋，但是实现的思想大致上是相同的：数据绑定 \x2b 视图刷新。出于好奇和一颗愿意折腾的心，我自己也沿着这个方向写了一个最简单的 MVVM 库 ( mvvm.js )，总共 2000 多行代码，指令的命名和用法与 vue 相似，在这里分享一下实现的原理以及我的代码组织思路。\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader0\x22\x3e思路整理\x3c\/h1\x3e\n\x3cp\x3eMVVM 在概念上是真正将视图与数据逻辑分离的模式，ViewModel 是整个模式的重点。要实现 ViewModel 就需要将数据模型（Model）和视图（View）关联起来，整个实现思路可以简单的总结成 5 点：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e实现一个 Compiler 对元素的每个节点进行指令的扫描和提取；\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e实现一个 Parser 去解析元素上的指令，能够把指令的意图通过某个刷新函数更新到 dom 上（中间可能需要一个专门负责视图刷新的模块）比如解析节点 \x3ccode\x3e\x26lt;p v-show=\x22isShow\x22\x26gt;\x26lt;\/p\x26gt;\x3c\/code\x3e 时先取得 Model 中 isShow 的值，再根据 isShow 更改 \x3ccode\x3enode.style.display\x3c\/code\x3e 从而控制元素的显示和隐藏;\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e实现一个 Watcher 能将 Parser 中每条指令的刷新函数和对应 Model 的字段联系起来；\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e实现一个 Observer 使得能够对对象的所有字段进行值的变化监测，一旦发生变化时可以拿到最新的值并触发通知回调；\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e利用 Observer 在 Watcher 中建立一个对 Model 的监听 ，当 Model 中的一个值发生变化时，监听被触发，Watcher 拿到新值后调用在步骤 2 中关联的那个刷新函数，就可以实现数据变化的同时刷新视图的目的。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3ch1 id=\x22articleHeader1\x22\x3e效果示例\x3c\/h1\x3e\n\x3cp\x3e首先粗看下最终的使用示例，与其他 MVVM 框架的实例化大同小异：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\x3cdiv id=\x26quot;mobile-list\x26quot;\x3e\n    \x3ch1 v-text=\x26quot;title\x26quot;\x3e\x3c\/h1\x3e\n    \x3cul\x3e\n        \x3cli v-for=\x26quot;item in brands\x26quot;\x3e\n            \x3cb v-text=\x26quot;item.name\x26quot;\x3e\x3c\/b\x3e\n            \x3cspan v-show=\x26quot;showRank\x26quot;\x3eRank: \x22{{\x22item.rank\x22}}\x22\x3c\/span\x3e\n        \x3c\/li\x3e\n    \x3c\/ul\x3e\n\x3c\/div\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22xml hljs\x22\x3e\x3ccode class=\x22html\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eid\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22mobile-list\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eh1\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3ev-text\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22title\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eh1\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eul\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eli\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3ev-for\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22item in brands\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n            \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eb\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3ev-text\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22item.name\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eb\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n            \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3ev-show\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e\x22showRank\x22\x3c\/span\x3e\x26gt;\x3c\/span\x3eRank: \x22{{\x22item.rank\x22}}\x22\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3espan\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eli\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n    \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eul\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var element = document.querySelector(\x27#mobile-list\x27);\nvar vm = new MVVM(element, {\n    \x27title\x27   : \x27Mobile List\x27,\n    \x27showRank\x27: true,\n    \x27brands\x27  : [\n        {\x27name\x27: \x27Apple\x27, \x27rank\x27: 1},\n        {\x27name\x27: \x27Galaxy\x27, \x27rank\x27: 2},\n        {\x27name\x27: \x27OPPO\x27, \x27rank\x27: 3}\n    ]\n});\n\nvm.set(\x27title\x27, \x27Top 3 Mobile Rank List\x27); \/\/ =\x3e \x3ch1\x3eTop 3 Mobile Rank List\x3c\/h1\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e element = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.querySelector(\x3cspan class=\x22hljs-string\x22\x3e\x27#mobile-list\x27\x3c\/span\x3e);\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e vm = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e MVVM(element, {\n    \x3cspan class=\x22hljs-string\x22\x3e\x27title\x27\x3c\/span\x3e   : \x3cspan class=\x22hljs-string\x22\x3e\x27Mobile List\x27\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27showRank\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n    \x3cspan class=\x22hljs-string\x22\x3e\x27brands\x27\x3c\/span\x3e  : [\n        {\x3cspan class=\x22hljs-string\x22\x3e\x27name\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27Apple\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27rank\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e1\x3c\/span\x3e},\n        {\x3cspan class=\x22hljs-string\x22\x3e\x27name\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27Galaxy\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27rank\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e2\x3c\/span\x3e},\n        {\x3cspan class=\x22hljs-string\x22\x3e\x27name\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27OPPO\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27rank\x27\x3c\/span\x3e: \x3cspan class=\x22hljs-number\x22\x3e3\x3c\/span\x3e}\n    ]\n});\n\nvm.set(\x3cspan class=\x22hljs-string\x22\x3e\x27title\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3e\x27Top 3 Mobile Rank List\x27\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ =\x26gt; \x26lt;h1\x26gt;Top 3 Mobile Rank List\x26lt;\/h1\x26gt;\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch1 id=\x22articleHeader2\x22\x3e模块划分\x3c\/h1\x3e\n\x3cp\x3e我把 MVVM 分成了五个模块去实现： 编译模块 Compiler 、解析模块 Parser 、视图刷新模块 Updater 、数据订阅模块 Watcher 和 数据监听模块 Observer 。流程可以简述为：Compiler 编译好指令后将指令信息交给解析器 Parser 解析，Parser 更新初始值并向 Watcher 订阅数据的变化，Observer 监测到数据的变化然后反馈给 Watcher ，Watcher 再将变化结果通知 Updater 找到对应的刷新函数进行视图的刷新。\x3c\/p\x3e\n\x3cp\x3e上述流程如图所示：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVuvga\x22 src=\x22https:\/\/static.alili.tech\/img\/bVuvga\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e下文就介绍下这五个模块实现的基本原理（代码只贴重点部分，完整的实现请到我的\x3ca href=\x22https:\/\/github.com\/tangbc\/sugar\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e Github \x3c\/a\x3e 翻阅）\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e1. 编译模块 Compiler\x3c\/h2\x3e\n\x3cp\x3eCompiler 的职责主要是对元素的每个节点进行指令的扫描和提取。因为编译和解析的过程会多次遍历整个节点树，所以为了提高编译效率在 MVVM 构造函数内部先将 \x3ccode\x3eelement\x3c\/code\x3e 转成一个文档碎片形式的副本 \x3ccode\x3efragment\x3c\/code\x3e 编译对象是这个文档碎片而不应该是目标元素，待全部节点编译完成后再将文档碎片添加回到原来的真实节点中。\x3c\/p\x3e\n\x3cp\x3e\x3ccode\x3evm.complieElement\x3c\/code\x3e 实现了对元素所有节点的扫描和指令提取：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22vm.complieElement = function(fragment, root) {\n    var node, childNodes = fragment.childNodes;\n    \/\/ 扫描子节点\n    for (var i = 0; i \x3c childNodes.length; i\x2b\x2b) {\n        node = childNodes[i];\n        if (this.hasDirective(node)) {\n            this.$unCompileNodes.push(node);\n        }\n        \/\/ 递归扫描子节点的子节点\n        if (node.childNodes.length) {\n            this.complieElement(node, false);\n        }\n    }\n    \/\/ 扫描完成，编译所有含有指令的节点\n    if (root) {\n        this.compileAllNodes();\n    }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3evm.complieElement = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3efragment, root\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e node, childNodes = fragment.childNodes;\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 扫描子节点\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; childNodes.length; i\x2b\x2b) {\n        node = childNodes[i];\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.hasDirective(node)) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.$unCompileNodes.push(node);\n        }\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 递归扫描子节点的子节点\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (node.childNodes.length) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.complieElement(node, \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e);\n        }\n    }\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 扫描完成，编译所有含有指令的节点\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (root) {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.compileAllNodes();\n    }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3evm.compileAllNodes\x3c\/code\x3e 方法将会对 \x3ccode\x3ethis.$unCompileNodes\x3c\/code\x3e 中的每个节点进行编译（将指令信息交给 Parser ），编译完一个节点后就从缓存队列中移除它，同时检查 \x3ccode\x3ethis.$unCompileNodes.length\x3c\/code\x3e 当 length === 0 时说明全部编译完成，可以将文档碎片追加到真实节点上了。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3e2. 指令解析模块 Parser\x3c\/h2\x3e\n\x3cp\x3e当编译器 Compiler 把每个节点的指令提取出来后就可以给到解析器解析了。每一个指令都有不同的解析方法，所有指令的解析方法只要做好两件事：一是将数据值更新到视图上（初始状态），二是将刷新函数订阅到 Model 的变化监测中。这里以解析 \x3ccode\x3ev-text\x3c\/code\x3e 为例描述一个指令的大致解析方法：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22parser.parseVText = function(node, model) {\n    \/\/ 取得 Model 中定义的初始值 \n    var text = this.$model[model];\n    \/\/ 更新节点的文本\n    node.textContent = text;\n    \/\/ 对应的刷新函数：\n    \/\/ updater.updateNodeTextContent(node, text);\n    \n    \/\/ 在 watcher 中订阅 model 的变化\n    watcher.watch(model, function(last, old) {\n        node.textContent = last;\n        \/\/ updater.updateNodeTextContent(node, text);\n    });\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3eparser.parseVText = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3enode, model\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 取得 Model 中定义的初始值 \x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e text = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.$model[model];\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 更新节点的文本\x3c\/span\x3e\n    node.textContent = text;\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 对应的刷新函数：\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ updater.updateNodeTextContent(node, text);\x3c\/span\x3e\n    \n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 在 watcher 中订阅 model 的变化\x3c\/span\x3e\n    watcher.watch(model, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3elast, old\x3c\/span\x3e) \x3c\/span\x3e{\n        node.textContent = last;\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ updater.updateNodeTextContent(node, text);\x3c\/span\x3e\n    });\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader5\x22\x3e3. 数据订阅模块 Watcher\x3c\/h2\x3e\n\x3cp\x3e上个例子，Watcher 提供了一个 \x3ccode\x3ewatch\x3c\/code\x3e 方法来对数据变化进行订阅，一个参数是模型字段 model 另一个是回调函数，回调函数是要通过 Observer 来触发的，参数传入新值 last 和 旧值 old , Watcher 拿到新值后就可以找到 model 对应的回调（刷新函数）进行更新视图了。model 和 刷新函数是一对多的关系，即一个 model 可以有任意多个处理它的回调函数（刷新函数），比如：\x3ccode\x3ev-text=\x22title\x22\x3c\/code\x3e 和 \x3ccode\x3ev-html=\x22title\x22\x3c\/code\x3e 两个指令共用一个数据模型字段。\x3c\/p\x3e\n\x3cp\x3e添加数据订阅 \x3ccode\x3ewatcher.watch\x3c\/code\x3e 实现方式为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22watcher.watch = function(field, callback, context) {\n    var callbacks = this.$watchCallbacks;\n\n    if (!Object.hasOwnProperty.call(this.$model, field)) {\n        console.warn(\x27The field: \x27 \x2b field \x2b \x27 does not exist in model!\x27);\n        return;\n    }\n\n    \/\/ 建立缓存回调函数的数组\n    if (!callbacks[field]) {\n        callbacks[field] = [];\n    }\n    \/\/ 缓存回调函数\n    callbacks[field].push([callback, context]);\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3ewatcher.watch = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3efield, callback, context\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e callbacks = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.$watchCallbacks;\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!\x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.hasOwnProperty.call(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.$model, field)) {\n        \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.warn(\x3cspan class=\x22hljs-string\x22\x3e\x27The field: \x27\x3c\/span\x3e \x2b field \x2b \x3cspan class=\x22hljs-string\x22\x3e\x27 does not exist in model!\x27\x3c\/span\x3e);\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e;\n    }\n\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 建立缓存回调函数的数组\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (!callbacks[field]) {\n        callbacks[field] = [];\n    }\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 缓存回调函数\x3c\/span\x3e\n    callbacks[field].push([callback, context]);\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e当数据模型的 field 字段发生改变时，Watcher 就会触发缓存数组中订阅了 field 的所有回调。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader6\x22\x3e4. 数据监听模块 Observer\x3c\/h2\x3e\n\x3cp\x3eObserver 是整个 mvvm 实现的核心基础，看过有一篇文章说 O.o (Object.observe) 将会引爆数据绑定革命，给前端带来巨大影响力，不过很可惜，ES7 草案已经将 O.o 给废弃了！目前也没有浏览器支持！所幸的是还有 \x3ccode\x3eObject.defineProperty\x3c\/code\x3e 通过拦截对象属性的存取描述符(get 和 set) 可以模拟一个简单的 Observer :\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 拦截 object 的 prop 属性的 get 和 set 方法\nObject.defineProperty(object, prop, {\n    get: function() {\n        return this.getValue(object, prop);\n    },\n\n    set: function(newValue) {\n        var oldValue = this.getValue(object, prop);\n        if (newValue !== oldValue) {\n            this.setValue(object, newValue, prop);\n            \/\/ 触发变化回调\n            this.triggerChange(prop, newValue, oldValue);\n        }\n    }\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 拦截 object 的 prop 属性的 get 和 set 方法\x3c\/span\x3e\n\x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.defineProperty(object, prop, {\n    \x3cspan class=\x22hljs-attr\x22\x3eget\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.getValue(object, prop);\n    },\n\n    \x3cspan class=\x22hljs-attr\x22\x3eset\x3c\/span\x3e: \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3enewValue\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e oldValue = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.getValue(object, prop);\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (newValue !== oldValue) {\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setValue(object, newValue, prop);\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 触发变化回调\x3c\/span\x3e\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.triggerChange(prop, newValue, oldValue);\n        }\n    }\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e然后还有个问题就是数组操作 ( push, shift 等) 该如何监测？所有的 MVVM 框架都是通过重写该数组的原型来实现的：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22observer.rewriteArrayMethods = function(array) {\n    var self = this;\n    var arrayProto = Array.prototype;\n    var arrayMethods = Object.create(arrayProto);\n    var methods = \x27push|pop|shift|unshift|splice|sort|reverse\x27.split(\x27|\x27);\n    \n    methods.forEach(function(method) {\n        Object.defineProperty(arrayMethods, method, function() {\n            var i = arguments.length;\n            var original = arrayProto[method];\n            \n            var args = new Array(i);\n            while (i--) {\n                args[i] = arguments[i];\n            }\n            \n            var result = original.apply(this, args);\n\n            \/\/ 触发回调\n            self.triggerChange(this, method);\n\n            return result;\n        });\n    });\n    \n    array.__proto__ = arrayMethods;\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3eobserver.rewriteArrayMethods = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3earray\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e self = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e;\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e arrayProto = \x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e.prototype;\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e arrayMethods = \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.create(arrayProto);\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e methods = \x3cspan class=\x22hljs-string\x22\x3e\x27push|pop|shift|unshift|splice|sort|reverse\x27\x3c\/span\x3e.split(\x3cspan class=\x22hljs-string\x22\x3e\x27|\x27\x3c\/span\x3e);\n    \n    methods.forEach(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3emethod\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-built_in\x22\x3eObject\x3c\/span\x3e.defineProperty(arrayMethods, method, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e i = \x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e.length;\n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e original = arrayProto[method];\n            \n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e args = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eArray\x3c\/span\x3e(i);\n            \x3cspan class=\x22hljs-keyword\x22\x3ewhile\x3c\/span\x3e (i--) {\n                args[i] = \x3cspan class=\x22hljs-built_in\x22\x3earguments\x3c\/span\x3e[i];\n            }\n            \n            \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e result = original.apply(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, args);\n\n            \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 触发回调\x3c\/span\x3e\n            self.triggerChange(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e, method);\n\n            \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e result;\n        });\n    });\n    \n    array.__proto__ = arrayMethods;\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这个实现方式是从 vue 中参考来的，觉得用的很妙，不过数组的 length 属性是不能够被监听到的，所以在 MVVM 中应避免操作 \x3ccode\x3earray.length\x3c\/code\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e5. 视图刷新模块 Updater\x3c\/h2\x3e\n\x3cp\x3eUpdater 在五个模块中是最简单的，只需要负责每个指令对应的刷新函数即可。其他四个模块经过一系列的折腾，把最后的成果交给到 Updater 进行视图或者事件的更新，比如 \x3ccode\x3ev-text\x3c\/code\x3e 的刷新函数为：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22updater.updateNodeTextContent = function(node, text) {\n    node.textContent = text;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3eupdater.updateNodeTextContent = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3enode, text\x3c\/span\x3e) \x3c\/span\x3e{\n    node.textContent = text;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3ccode\x3ev-bind:style\x3c\/code\x3e 的刷新函数：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22updater.updateNodeStyle = function(node, propperty, value) {\n    node.style[propperty] = value;\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3eupdater.updateNodeStyle = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3enode, propperty, value\x3c\/span\x3e) \x3c\/span\x3e{\n    node.style[propperty] = value;\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch1 id=\x22articleHeader8\x22\x3e双向数据绑定的实现\x3c\/h1\x3e\n\x3cp\x3e表单元素的双向数据绑定是 MVVM 的一个最大特点之一：\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVuvzB\x22 src=\x22https:\/\/static.alili.tech\/img\/bVuvzB\x22 alt=\x22图片描述\x22 title=\x22图片描述\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e其实这个神奇的功能实现原理也很简单，要做的只有两件事：一是数据变化的时候更新表单值，二是反过来表单值变化的时候更新数据，这样数据的值就和表单的值绑在了一起。\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e数据变化更新表单值\x3c\/strong\x3e 利用前面说的 Watcher 模块很容易就可以做到：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22watcher.watch(model, function(last, old) {\n    input.value = last;\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3ewatcher.watch(model, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3elast, old\x3c\/span\x3e) \x3c\/span\x3e{\n    input.value = last;\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\x3cstrong\x3e表单变化更新数据\x3c\/strong\x3e 只需要实时监听表单的值得变化事件并更新数据模型对应字段即可：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var model = this.$model;\ninput.addEventListenr(\x27change\x27, function() {\n    model[field] = this.value;\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e model = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.$model;\ninput.addEventListenr(\x3cspan class=\x22hljs-string\x22\x3e\x27change\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    model[field] = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.value;\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e其他表单 radio, checkbox 和 select 都是一样的原理。\x3c\/p\x3e\n\x3cp\x3e以上，整个流程以及每个模块的基本实现思路都讲完了，语言表达能力不太好，如有说的不对写的不好的地方，希望大家能够批评指正！\x3c\/p\x3e\n\x3ch1 id=\x22articleHeader9\x22\x3e结语\x3c\/h1\x3e\n\x3cp\x3e折腾这个简单的 mvvm.js 是因为原来自己的框架项目中用的是 vue.js 但是只是用到了它的指令系统，一大堆功能只用到四分之一左右，就想着只是实现 data-binding 和 view-refresh 就够了，结果没找这样的 javascript 库，所以我自己就造了这么一个轮子。\x3c\/p\x3e\n\x3cp\x3e虽说功能和稳定性远不如 vue 等流行 MVVM 框架，代码实现可能也比较粗糙，但是通过造这个轮子还是增长了很多知识的 ~ 进步在于折腾嘛！\x3c\/p\x3e\n\x3cp\x3e目前我的 mvvm.js 只是实现了最本的功能，以后我会继续完善、健壮它，如有兴趣欢迎一起探讨和改进~\x3c\/p\x3e\n\x3cp\x3e源代码传送门: \x3ca href=\x22https:\/\/github.com\/tangbc\/sugar\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/tangbc\/sugar\x3c\/a\x3e\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>利用 JavaScript 数据绑定实现一个简单的 MVVM 库</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000004847657">https://segmentfault.com/a/1190000004847657</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/v0zwmlt9l0e/" target="_blank">https://alili.tech/archive/v0zwmlt9l0e/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>