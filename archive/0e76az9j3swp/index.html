<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="用co玩转异步"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>用co玩转异步 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/0e76az9j3swp/",
				"appid": "1613049289050283", 
				"title": "用co玩转异步 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-05T02:30:09"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/urx8mjo03lr/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/786d6bfemu/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f0e76az9j3swp%2f&text=%e7%94%a8co%e7%8e%a9%e8%bd%ac%e5%bc%82%e6%ad%a5"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f0e76az9j3swp%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f0e76az9j3swp%2f&text=%e7%94%a8co%e7%8e%a9%e8%bd%ac%e5%bc%82%e6%ad%a5"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f0e76az9j3swp%2f&title=%e7%94%a8co%e7%8e%a9%e8%bd%ac%e5%bc%82%e6%ad%a5"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f0e76az9j3swp%2f&is_video=false&description=%e7%94%a8co%e7%8e%a9%e8%bd%ac%e5%bc%82%e6%ad%a5"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e7%94%a8co%e7%8e%a9%e8%bd%ac%e5%bc%82%e6%ad%a5&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f0e76az9j3swp%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f0e76az9j3swp%2f&title=%e7%94%a8co%e7%8e%a9%e8%bd%ac%e5%bc%82%e6%ad%a5"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f0e76az9j3swp%2f&title=%e7%94%a8co%e7%8e%a9%e8%bd%ac%e5%bc%82%e6%ad%a5"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f0e76az9j3swp%2f&title=%e7%94%a8co%e7%8e%a9%e8%bd%ac%e5%bc%82%e6%ad%a5"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f0e76az9j3swp%2f&title=%e7%94%a8co%e7%8e%a9%e8%bd%ac%e5%bc%82%e6%ad%a5"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">用co玩转异步</h1><div class="meta"><div class="postdate"><time datetime="2019-02-05" itemprop="datePublished">2019-02-05</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e之前我在关于Promise的文章中提到了\x3ccode\x3eco\x3c\/code\x3e这个库。在这篇文章里，我将写一写自己对它的认识。\x3c\/p\x3e\n\x3cp\x3eTrust me，用了\x3ccode\x3eco\x3c\/code\x3e库，你不想用别的，来它半斤异步调用你一口能吃仨。\x3c\/p\x3e\n\x3cp\x3e但是我对Tj大神的\x3ca href=\x22https:\/\/github.com\/tj\/co\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eco库源码\x3c\/a\x3e谈不上深入理解。所以，如有乱讲，欢迎指正。\x3c\/p\x3e\n\x3cp\x3e我这里默认读者对\x3ccode\x3ePromise\x3c\/code\x3e和\x3ccode\x3eGenerator\x3c\/code\x3e有一定的认识。\x3c\/p\x3e\n\x3cp\x3e先安利自己写的两篇关于Promise的文章：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000006708151\x22\x3e浅析ES6原生Promise\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000006708186\x22 target=\x22_blank\x22\x3e再谈Promise\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e下面我就来谈谈\x3ccode\x3eco\x3c\/code\x3e这个牛逼的库。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3eES7 async\/await\x3c\/h2\x3e\n\x3cp\x3e干嘛，我们不是讲ES6么，怎么跳到ES7了？\x3c\/p\x3e\n\x3cp\x3e因为\x3ccode\x3eco\x3c\/code\x3e要做的事情，就是ES7的\x3ccode\x3easync\/await\x3c\/code\x3e要做的事情。  \x3cbr\x3e也就是说，这种解决异步的思路，已经在ECMA标准的考虑之中了。将来我们浏览器的JS引擎就可以原生实现这件事而不是通过JavaScript代码模拟。要知道，引擎的实现和代码的实现那是完全两码事。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader1\x22\x3e一点题外话\x3c\/h3\x3e\n\x3cp\x3e多一句嘴：有些同学混淆了ECMA标准、引擎支持和代码实现的联系。\x3c\/p\x3e\n\x3cp\x3e这里引用\x3ca href=\x22http:\/\/blog.zhaojie.me\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e老赵\x3c\/a\x3e在知乎里面回答问题时说的一句话：\x3c\/p\x3e\n\x3cblockquote\x3e\x3cp\x3eES7是个标准，定义的是what to do不是how to do，为什么好多人还是搞不清这两者的区别。\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3cp\x3eECMAScript定义了一些JavaScript语言层面要做的事情，这是一个标准。之所以要制定这个标准，是为了防止浏览器各自为政而出现JS引擎对同一行代码的解释出现不同的情况。\x3c\/p\x3e\n\x3cp\x3e也就是说，ECMA制定标准，我们就可以按照这个标准来写JavaScript代码。写好的JavaScript代码由浏览器的JS引擎来解释，最终变成计算机能读懂的代码来执行。\x3c\/p\x3e\n\x3chr\x3e\n\x3ch3 id=\x22articleHeader2\x22\x3easync\/await\x3c\/h3\x3e\n\x3cp\x3e上代码：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22var foo = function(){\n\n    return new Promise(resolve =\x3e {\n        \/\/ 异步操作之后\n        resolve(\x27OK\x27);\n    });\n}\n\nasync funtion bar(){\n    \n    var result = await foo();\n    \n    console.log(result); \n    \n}\n\nbar(); \/\/ ==\x3e 打印\x27OK\x27\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e foo = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresolve\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 异步操作之后\x3c\/span\x3e\n        resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27OK\x27\x3c\/span\x3e);\n    });\n}\n\n\x3cspan class=\x22hljs-keyword\x22\x3easync\x3c\/span\x3e funtion bar(){\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e result = \x3cspan class=\x22hljs-keyword\x22\x3eawait\x3c\/span\x3e foo();\n    \n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(result); \n    \n}\n\nbar(); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ==\x26gt; 打印\x27OK\x27\x3c\/span\x3e\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们注意到，这段代码用了两个新的关键字\x3ccode\x3easync\x3c\/code\x3e和\x3ccode\x3eawait\x3c\/code\x3e。而且有两件神奇的事情发生了：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3ebar\x3c\/code\x3e函数中包含了一个返回\x3ccode\x3ePromise\x3c\/code\x3e对象的语句，而且\x3ccode\x3ePromise\x3c\/code\x3e中存在异步代码。但是这条语句接下来的语句明显是等待\x3ccode\x3ePromise\x3c\/code\x3e对象中的代码异步执行完毕之后才执行的。（否则不会得到异步之后的值）\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ccode\x3ePromise\x3c\/code\x3e对象\x3ccode\x3eresolve\x3c\/code\x3e的值，并没有在\x3ccode\x3ethen\x3c\/code\x3e中进行处理，而是直接作为返回值返回到\x3ccode\x3ePromise\x3c\/code\x3e对象外面了.\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e这就是\x3ccode\x3easync\/await\x3c\/code\x3e的魔法。在函数前面加上\x3ccode\x3easync\x3c\/code\x3e关键字之后，内部的代码会识别\x3ccode\x3eawait\x3c\/code\x3e关键字。此时假设\x3ccode\x3eawait\x3c\/code\x3e后面的语句返回一个\x3ccode\x3ePromise\x3c\/code\x3e对象，那么执行的代码将会等待，直到\x3ccode\x3ePromise\x3c\/code\x3e对象变为\x3ccode\x3eresolve\x3c\/code\x3e状态。并且\x3ccode\x3ePromise\x3c\/code\x3e对象中\x3ccode\x3eresolve\x3c\/code\x3e的值将直接作为\x3ccode\x3eawait\x3c\/code\x3e语句的返回值返回。然后再执行\x3ccode\x3eawait\x3c\/code\x3e语句之后的语句。\x3c\/p\x3e\n\x3cp\x3e从此我们就可以无痛的撸异步代码，妈妈再也不用担心回调金字塔的出现和异步流程逻辑搞不定的情况了！\x3c\/p\x3e\n\x3cp\x3e另一个奇妙的事情就是，率先支持这一特性的浏览器居然是微软的Edge。大概是因为\x3ccode\x3eC#\x3c\/code\x3e语言早就出现\x3ccode\x3easync\/await\x3c\/code\x3e,并且\x3ccode\x3eTypeScript\x3c\/code\x3e也支持这一特性的缘故吧。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3eco\x3c\/h2\x3e\n\x3cp\x3e我们希望所有的浏览器都及早支持这一特性。但是值得欣喜的一点就是，虽然V8还没有支持，Tj大神早就利用\x3ccode\x3eGenerator\x3c\/code\x3e的方式实现了一个ES6版本的\x3ccode\x3easync\/await\x3c\/code\x3e！（膜拜脸）\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader4\x22\x3eco函数形式\x3c\/h3\x3e\n\x3cp\x3e同样是上面的逻辑，我们用\x3ccode\x3eco\x3c\/code\x3e实现一次：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 首先我们需要将co引入，假设我们使用commonJS的方式  \n\nconst co = require(\x27co\x27);\n\nvar foo = function(){\n\n    return new Promise(resolve =\x3e {\n        \/\/ 异步操作之后\n        resolve(\x27OK\x27);\n    });\n}\n\nco(function* (){\n    \n    var result = yield foo();\n    \n    console.log(result); \n    \n}); \/\/ ==\x3e 打印\x27OK\x27\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 首先我们需要将co引入，假设我们使用commonJS的方式  \x3c\/span\x3e\n\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e co = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27co\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e foo = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresolve\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 异步操作之后\x3c\/span\x3e\n        resolve(\x3cspan class=\x22hljs-string\x22\x3e\x27OK\x27\x3c\/span\x3e);\n    });\n}\n\nco(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e* (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e)\x3c\/span\x3e{\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e result = \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e foo();\n    \n    \x3cspan class=\x22hljs-built_in\x22\x3econsole\x3c\/span\x3e.log(result); \n    \n}); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ==\x26gt; 打印\x27OK\x27\x3c\/span\x3e\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e我们看到，\x3ccode\x3eco\x3c\/code\x3e函数接收一个\x3ccode\x3eGenerator\x3c\/code\x3e生成器函数作为参数。\x3cstrong\x3e执行\x3ccode\x3eco\x3c\/code\x3e函数的时候\x3c\/strong\x3e，生成器函数内部的逻辑像\x3ccode\x3easync\x3c\/code\x3e函数\x3cstrong\x3e调用\x3c\/strong\x3e时一样被执行。不同之处只是这里的\x3ccode\x3eawait\x3c\/code\x3e变成了\x3ccode\x3eyield\x3c\/code\x3e。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader5\x22\x3e简单版本的co代码\x3c\/h3\x3e\n\x3cp\x3e要实现以上的逻辑，结合\x3ccode\x3eGenerator\x3c\/code\x3e的特性，\x3ccode\x3eco\x3c\/code\x3e函数应该：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e在函数体内将Generator生成器函数执行并生成生成器实例(在此命名为\x3ccode\x3egen\x3c\/code\x3e)，然后通过\x3ccode\x3egen.next\x3c\/code\x3e方法的调用，不断执行生成器函数内部的代码。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e执行\x3ccode\x3enext\x3c\/code\x3e方法之后，返回的\x3ccode\x3ePromise\x3c\/code\x3e在生成器函数执行环境之外执行，并取出\x3ccode\x3eresolve\x3c\/code\x3e值，作为返回值作为\x3ccode\x3enext\x3c\/code\x3e方法的参数返回到\x3ccode\x3eGenerator\x3c\/code\x3e执行环境中。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e基于以上两点，我们可以大体实现一个简化版的\x3ccode\x3eco\x3c\/code\x3e，代码如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const co = function(genFunc){  \n    const gen = genFunc(); \/\/ 得到生成器实例  \n    \n    const deal = (val) =\x3e {\n        \n        const res = gen.next(val); \n        \n        \/\/ 这里处理了异步逻辑，\n        \/\/ 在回调中去递归，不断执行next\n        \/\/ 这样就将resolve的值传回了Generator\n        res.value.then(result =\x3e deal(result));\n        \n    }\n    \n    deal(); \/\/ 第一次触发递归\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e co = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3egenFunc\x3c\/span\x3e)\x3c\/span\x3e{  \n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e gen = genFunc(); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 得到生成器实例  \x3c\/span\x3e\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e deal = \x3cspan class=\x22hljs-function\x22\x3e(\x3cspan class=\x22hljs-params\x22\x3eval\x3c\/span\x3e) =\x26gt;\x3c\/span\x3e {\n        \n        \x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e res = gen.next(val); \n        \n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 这里处理了异步逻辑，\x3c\/span\x3e\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 在回调中去递归，不断执行next\x3c\/span\x3e\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 这样就将resolve的值传回了Generator\x3c\/span\x3e\n        res.value.then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3eresult\x3c\/span\x3e =\x26gt;\x3c\/span\x3e deal(result));\n        \n    }\n    \n    deal(); \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 第一次触发递归\x3c\/span\x3e\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e去掉括号等等，只有短短六行代码。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3emore\x3c\/h3\x3e\n\x3cp\x3e原理性的东西大约就是这样了。但是\x3ccode\x3eco\x3c\/code\x3e做的不止这些。\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e\x3cp\x3e之前\x3ccode\x3eco\x3c\/code\x3e的\x3ccode\x3eyield\x3c\/code\x3e后的语句并不支持\x3ccode\x3ePromise\x3c\/code\x3e对象，而是一个特殊的函数，叫做\x3ccode\x3ethunk\x3c\/code\x3e。目前\x3ccode\x3eco\x3c\/code\x3e二者都支持。  \x3cbr\x3e此处我并不打算重复性解释\x3ccode\x3ethunk\x3c\/code\x3e版本，因为原理性的东西实现起来是差不多的。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\n\x3cp\x3e\x3ccode\x3eco\x3c\/code\x3e函数是有返回值的，也是一个\x3ccode\x3ePromise\x3c\/code\x3e对象。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e当生成器函数内的逻辑执行完毕且没有错误之后，这个\x3ccode\x3ePromise\x3c\/code\x3e对象（\x3ccode\x3eco\x3c\/code\x3e返回值）变为\x3ccode\x3eresolve\x3c\/code\x3e状态，且将生成器的返回值作为\x3ccode\x3eresolve\x3c\/code\x3e出来的值。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e若生成器函数内返回一个\x3ccode\x3ePromise\x3c\/code\x3e对象，那么\x3ccode\x3eco\x3c\/code\x3e函数返回值就是这个\x3ccode\x3ePromise\x3c\/code\x3e对象。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e若生成器函数抛出了错误，那么这个错误作为\x3ccode\x3ereject\x3c\/code\x3e出来的值，将\x3ccode\x3ePromise\x3c\/code\x3e对象的状态变为\x3ccode\x3ereject\x3c\/code\x3e。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e这样我们就可以将错误放进其返回值的\x3ccode\x3e.catch\x3c\/code\x3e方法中统一处理。\x3c\/p\x3e\n\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e在生成器函数内部，我们也可以使用\x3ccode\x3etry...catch\x3c\/code\x3e语句获取错误对象。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e生成器的\x3ccode\x3eyield\x3c\/code\x3e后面可以跟一个元素值为\x3ccode\x3ePromise\x3c\/code\x3e对象的数组，这个数组内\x3ccode\x3ePromise\x3c\/code\x3e对象内的异步逻辑将并发执行，并返回一个数组。（类似于\x3ccode\x3ePromise.all\x3c\/code\x3e方法）\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e假设生成器执行之前需要从外部传入参数，\x3ccode\x3eco\x3c\/code\x3e库提供了一个方法：\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22  var fn = co.wrap(function* (val) {\n  \n     return yield Promise.resolve(val);\n\n  });\n\n  fn(true).then(function (val) {\n\n  });\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e  \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e fn = co.wrap(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e* (\x3cspan class=\x22hljs-params\x22\x3eval\x3c\/span\x3e) \x3c\/span\x3e{\n  \n     \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3ePromise\x3c\/span\x3e.resolve(val);\n\n  });\n\n  fn(\x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e).then(\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eval\x3c\/span\x3e) \x3c\/span\x3e{\n\n  });\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader7\x22\x3e结束\x3c\/h2\x3e\n\x3cp\x3e以上是一点微小的见解。谢谢指正。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>用co玩转异步</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000006719931">https://segmentfault.com/a/1190000006719931</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/0e76az9j3swp/" target="_blank">https://alili.tech/archive/0e76az9j3swp/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>