<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="在格式化的场景下，React input 的光标的处理办法"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>在格式化的场景下，React input 的光标的处理办法 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/dl25z1wufyq/",
				"appid": "1613049289050283", 
				"title": "在格式化的场景下，React input 的光标的处理办法 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-13T02:31:23"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/gknqo3vc5n/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/jrdzjtu4hom/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fdl25z1wufyq%2f&text=%e5%9c%a8%e6%a0%bc%e5%bc%8f%e5%8c%96%e7%9a%84%e5%9c%ba%e6%99%af%e4%b8%8b%ef%bc%8cReact%20input%20%e7%9a%84%e5%85%89%e6%a0%87%e7%9a%84%e5%a4%84%e7%90%86%e5%8a%9e%e6%b3%95"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fdl25z1wufyq%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fdl25z1wufyq%2f&text=%e5%9c%a8%e6%a0%bc%e5%bc%8f%e5%8c%96%e7%9a%84%e5%9c%ba%e6%99%af%e4%b8%8b%ef%bc%8cReact%20input%20%e7%9a%84%e5%85%89%e6%a0%87%e7%9a%84%e5%a4%84%e7%90%86%e5%8a%9e%e6%b3%95"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fdl25z1wufyq%2f&title=%e5%9c%a8%e6%a0%bc%e5%bc%8f%e5%8c%96%e7%9a%84%e5%9c%ba%e6%99%af%e4%b8%8b%ef%bc%8cReact%20input%20%e7%9a%84%e5%85%89%e6%a0%87%e7%9a%84%e5%a4%84%e7%90%86%e5%8a%9e%e6%b3%95"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fdl25z1wufyq%2f&is_video=false&description=%e5%9c%a8%e6%a0%bc%e5%bc%8f%e5%8c%96%e7%9a%84%e5%9c%ba%e6%99%af%e4%b8%8b%ef%bc%8cReact%20input%20%e7%9a%84%e5%85%89%e6%a0%87%e7%9a%84%e5%a4%84%e7%90%86%e5%8a%9e%e6%b3%95"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e5%9c%a8%e6%a0%bc%e5%bc%8f%e5%8c%96%e7%9a%84%e5%9c%ba%e6%99%af%e4%b8%8b%ef%bc%8cReact%20input%20%e7%9a%84%e5%85%89%e6%a0%87%e7%9a%84%e5%a4%84%e7%90%86%e5%8a%9e%e6%b3%95&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fdl25z1wufyq%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fdl25z1wufyq%2f&title=%e5%9c%a8%e6%a0%bc%e5%bc%8f%e5%8c%96%e7%9a%84%e5%9c%ba%e6%99%af%e4%b8%8b%ef%bc%8cReact%20input%20%e7%9a%84%e5%85%89%e6%a0%87%e7%9a%84%e5%a4%84%e7%90%86%e5%8a%9e%e6%b3%95"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fdl25z1wufyq%2f&title=%e5%9c%a8%e6%a0%bc%e5%bc%8f%e5%8c%96%e7%9a%84%e5%9c%ba%e6%99%af%e4%b8%8b%ef%bc%8cReact%20input%20%e7%9a%84%e5%85%89%e6%a0%87%e7%9a%84%e5%a4%84%e7%90%86%e5%8a%9e%e6%b3%95"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fdl25z1wufyq%2f&title=%e5%9c%a8%e6%a0%bc%e5%bc%8f%e5%8c%96%e7%9a%84%e5%9c%ba%e6%99%af%e4%b8%8b%ef%bc%8cReact%20input%20%e7%9a%84%e5%85%89%e6%a0%87%e7%9a%84%e5%a4%84%e7%90%86%e5%8a%9e%e6%b3%95"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fdl25z1wufyq%2f&title=%e5%9c%a8%e6%a0%bc%e5%bc%8f%e5%8c%96%e7%9a%84%e5%9c%ba%e6%99%af%e4%b8%8b%ef%bc%8cReact%20input%20%e7%9a%84%e5%85%89%e6%a0%87%e7%9a%84%e5%a4%84%e7%90%86%e5%8a%9e%e6%b3%95"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">在格式化的场景下，React input 的光标的处理办法</h1><div class="meta"><div class="postdate"><time datetime="2019-02-13" itemprop="datePublished">2019-02-13</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e今天要来说的是有关于有数值格式化的场景中，React input 光标的一些异常的表现和对应的处理办法。故事要从一个 \x3ca href=\x22https:\/\/github.com\/salt-ui\/saltui\/issues\/288\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eissue\x3c\/a\x3e 说起，有用户反映在使用 NumberField 组件输入时安卓下会出现光标位置异常，导致连续输入会达不到期望的结果。具体表现是什么样的呢？\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016758144\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016758144\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cblockquote\x3e图1 安卓下不期望的输入行为\x3c\/blockquote\x3e\n\x3cp\x3e可以看到，在安卓手机下每次格式化发生的时候，本来应该一直在最后的光标会错格一位，导致连续输入出现问题。而这个问题在 PC Chrome 和 iOS 上都没有出现，于是可以判定是一个兼容性问题。但这个兼容性问题是如何产生的呢？\x3c\/p\x3e\n\x3cp\x3e分析一下格式化的话的过程，如上面的情况，输入 18758 时，因为要做针对卡号的格式化，所以会将原有的值转变为 \x221875 8\x22，从字符串长度上来看，从 5 位变成了 6 位，那么如果此时光标位置没有在值变化时跳到最后一位，则会停留在空格处，看起来就好像错格了一位，连续输入时就会有问题。\x3c\/p\x3e\n\x3cp\x3e单从输入框的光标变化行为来看，这好像也不算是一种异常的变化，只是不响应值的变化跳到尾部而已。但引申出来的问题是为什么在 iOS 和 PC Chrome 下又会跳动到尾部呢。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016758145\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016758145\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cblockquote\x3e图2： 相同的代码在 PC Chrome 下表现与安卓不同。\x3c\/blockquote\x3e\n\x3cp\x3e于是去网上搜索，辗转在 React 的 github 中找到这样一个 issue, \x3ca href=\x22https:\/\/github.com\/facebook\/react\/issues\/955\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eCursor jumps to end of controlled input\x3c\/a\x3e。在这里 React 的主要维护者之一的 @sophiebits(spicyj) 给出了一个比较确切的\x3ca href=\x22https:\/\/github.com\/facebook\/react\/issues\/955#issuecomment-160703606\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e答案\x3c\/a\x3e。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016758146\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016758146\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cblockquote\x3e图3 sophiebits 关于 React controlled input value 变化时光标行为的解释\x3c\/blockquote\x3e\n\x3cp\x3e原来因为 value 的变化具有非常大的不确定性，因此 React 无法使用一种可靠且通用的逻辑去保存光标的位置在一个合适的位置，因此 React 在受控模式下的重新渲染都会时光标移动到最后的位置。这个至少解释了PC Chrome 和 iOS 下光标跳动到结尾的原因，但安卓下为什么没有表现出同样的行为到目前位置我还没有找到合理的解释。\x3c\/p\x3e\n\x3cp\x3e那有没有办法使安卓上的表现和 iOS 中一致呢？又是一阵翻阅和尝试，最后发现如果将重新渲染的过程和 input 的 onChange 置于前后两个 tick 中就可以使安卓中 input 的表现和其他平台上表现一致，即表现为光标在重新渲染时跳到最后，示意代码如下。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22import React from \x27React\x27;\nclass Demo extends React.Component {\n    constructor(props) {\n        super(props);\n        this.state = {\n            value: \x27xxx\x27,\n        };\n    }\n    \n    handleChange(e) {\n        const value = e.target.value;\n        \/\/ 通过 setTimeout 异步\n        \/\/ 使 re-render 和 onChange 处于两个 tick 中\n        setTimeout(() =\x3e {\n            this.setState({\n                value,\n            });\n        });\n    }\n    \n    render() {\n        return (\n            \x3cinput \n                value={this.state.value} \n                onChange={(e) =\x3e { this.handleChange(e); \x22}}\x22  \n            \/\x3e\n        );\n    }\n}\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs scala\x22\x3e\x3ccode class=\x22jsx\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e \x3cspan class=\x22hljs-type\x22\x3eReact\x3c\/span\x3e from \x3cspan class=\x22hljs-symbol\x22\x3e\x27Reac\x3c\/span\x3et\x27;\n\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eDemo\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eReact\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3eComponent\x3c\/span\x3e \x3c\/span\x3e{\n    constructor(props) {\n        \x3cspan class=\x22hljs-keyword\x22\x3esuper\x3c\/span\x3e(props);\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state = {\n            value: \x3cspan class=\x22hljs-symbol\x22\x3e\x27xx\x3c\/span\x3ex\x27,\n        };\n    }\n    \n    handleChange(e) {\n        const value = e.target.value;\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 通过 setTimeout 异步\x3c\/span\x3e\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 使 re-render 和 onChange 处于两个 tick 中\x3c\/span\x3e\n        setTimeout(() =\x26gt; {\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.setState({\n                value,\n            });\n        });\n    }\n    \n    render() {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n            \x26lt;input \n                value={\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state.value} \n                onChange={(e) =\x26gt; { \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.handleChange(e); \x22}}\x22  \n            \/\x26gt;\n        );\n    }\n}\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e这样终于使得表现的行为在安卓和 iOS 上表现一致，并且正常输入的情况下表现得比较符合期望了，然而等等，这样就可以了吗？从之前的 React issue 中得出的结论可以看出，无论是如何的修改都会跳至 input 的结尾，这样如果是从中间修改的话会变成什么样?\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016758147\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016758147\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cblockquote\x3e图4：中间编辑时又会出现问题\x3c\/blockquote\x3e\n\x3cp\x3e从上面的图里可以看出，因为 React 无论何种修改都会将光标置尾，如果从中间进行修改，那么表现地又会很不符合用户预期，没有办法做到连续输入。这回倒是两端行为保持一致，都是不期望的状态。。\x3c\/p\x3e\n\x3cp\x3e但是都不正常也有好处，不需要根据平台去写一些 ifelse，可以统一地去做处理。从上面的讨论中我们可以知道 React 没有保存光标的位置是因为没有一个通用并且可靠的算法去支撑这一行为。这是因为 input 的变化可能是增加空格做格式化，也可能是过滤过些字符，也可能是触发某些条件直接变成了其他字符等各种无法预测的变化行为。但是细化到数字格式化这一单一场景时，光标位置的保存逻辑就变得简单和清晰的多了。\x3c\/p\x3e\n\x3cp\x3e在用户输入的过程中，只存在两种情况，在结尾中追加和在中间修改。在结尾追加的 case 中，例如 18758^ 时，由于一直是在向后追加的状态，我们只要一直保持光标在最后即可（即默认状态 1875 8^ ），在中间编辑的 case 下，光标并不处于结尾，如 187^5 8，此时如果在 7 后面追加了一个 8，那么理想的图标应该维持在 8 之后（即 1878^ 58），此时就应该保存光标的位置在上次 format 之前的状态。\x3c\/p\x3e\n\x3cp\x3e逻辑清楚了，接下来就是如何实现的问题了。那么如何探测和修改光标位置呢？这就涉及了 input 中选区相关的属性，我们知道我们可以通过一些方式（如鼠标拖拽和长按屏幕等）在 input 中完成对一段话的选区，因此光标的位置其实是由选区的开始点（selectionStart）和结束点（selectionEnd）决定的。那么其实我们就可以通过读取，储存和设置这两个属性来达到我们想要实现的目的，实例代码如下。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22class Demo extends React.Component {\n    ...\n    \n    componentDidUpdate(prevProps) {\n        const { value } = prevProps;\n        const { inputSelection } = this;\n        if (inputSelection) {\n          \/\/ 在 didUpdate 时根据情况恢复光标的位置\n          \/\/ 如果光标的位置小于值的长度，那么可以判定属于中间编辑的情况\n          \/\/ 此时恢复光标的位置\n          if (inputSelection.start \x3c this.formatValue(value).length) {\n            const input = this.input;\n            input.selectionStart = inputSelection.start;\n            input.selectionEnd = inputSelection.end;\n            this.inputSelection = null;\n          }\n        }\n    }\n    \n    handleChange(e) {\n        \/\/ 在 onChange 时记录光标的位置\n        if (this.input) {\n          this.inputSelection = {\n            start: this.input.selectionStart,\n            end: this.input.selectionEnd,\n          };\n        }\n        ...\n    }\n    \n    render() {\n        return (\n            \x3cinput \n                ref={(c) =\x3e { this.input = c; \x22}}\x22\n                value={this.state.value} \n                onChange={(e) =\x3e { this.handleChange(e); \x22}}\x22  \n            \/\x3e\n        );\n    }\n}\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs kotlin\x22\x3e\x3ccode class=\x22jsx\x22\x3e\x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3eclass\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eDemo\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eextends\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3eReact\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3eComponent\x3c\/span\x3e \x3c\/span\x3e{\n    ...\n    \n    componentDidUpdate(prevProps) {\n        const { value } = prevProps;\n        const { inputSelection } = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e;\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (inputSelection) {\n          \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 在 didUpdate 时根据情况恢复光标的位置\x3c\/span\x3e\n          \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 如果光标的位置小于值的长度，那么可以判定属于中间编辑的情况\x3c\/span\x3e\n          \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 此时恢复光标的位置\x3c\/span\x3e\n          \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (inputSelection.start \x26lt; \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.formatValue(value).length) {\n            const input = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.input;\n            input.selectionStart = inputSelection.start;\n            input.selectionEnd = inputSelection.end;\n            \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.inputSelection = \x3cspan class=\x22hljs-literal\x22\x3enull\x3c\/span\x3e;\n          }\n        }\n    }\n    \n    handleChange(e) {\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 在 onChange 时记录光标的位置\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.input) {\n          \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.inputSelection = {\n            start: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.input.selectionStart,\n            end: \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.input.selectionEnd,\n          };\n        }\n        ...\n    }\n    \n    render() {\n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e (\n            \x26lt;input \n                ref={(c) =\x26gt; { \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.input = c; \x22}}\x22\n                value={\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.state.value} \n                onChange={(e) =\x26gt; { \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.handleChange(e); \x22}}\x22  \n            \/\x26gt;\n        );\n    }\n}\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e至此，我们终于在追加和中间编辑的情况下都实现了我们想要的效果。这是一个比较小的技术点，但是由于里面涉及了一些 React 内部的处理逻辑及平台差异性问题，排查和解决起来并不是那么容易，希望可以给有类似问题的同学在处理时有所启发。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/remote\/1460000016758148\x22 src=\x22https:\/\/static.alili.tech\/img\/remote\/1460000016758148\x22 alt=\x22\x22 title=\x22\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch4\x3e文中涉及的各端及浏览器信息\x3c\/h4\x3e\n\x3cul\x3e\x3cli\x3eAndroid\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Mozilla\/5.0 (Linux; U; Android 8.1.0; zh-CN; CLT-AL00 Build\/HUAWEICLT-AL00) AppleWebKit\/537.36 (KHTML, like Gecko) Version\/4.0 Chrome\/57.0.2987.108 UCBrowser\/11.9.4.974 UWS\/2.13.1.48 Mobile Safari\/537.36 \x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lsl\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3eMozilla\/\x3cspan class=\x22hljs-number\x22\x3e5.0\x3c\/span\x3e (Linux; U; Android \x3cspan class=\x22hljs-number\x22\x3e8.1\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e.0\x3c\/span\x3e; zh-CN; CLT-AL00 Build\/HUAWEICLT-AL00) AppleWebKit\/\x3cspan class=\x22hljs-number\x22\x3e537.36\x3c\/span\x3e (KHTML, like Gecko) Version\/\x3cspan class=\x22hljs-number\x22\x3e4.0\x3c\/span\x3e Chrome\/\x3cspan class=\x22hljs-number\x22\x3e57.0\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e.2987\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e.108\x3c\/span\x3e UCBrowser\/\x3cspan class=\x22hljs-number\x22\x3e11.9\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e.4\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e.974\x3c\/span\x3e UWS\/\x3cspan class=\x22hljs-number\x22\x3e2.13\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e.1\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e.48\x3c\/span\x3e Mobile Safari\/\x3cspan class=\x22hljs-number\x22\x3e537.36\x3c\/span\x3e \x3c\/code\x3e\x3c\/pre\x3e\n\x3cul\x3e\x3cli\x3eiOS\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Mozilla\/5.0 (iPhone; CPU iPhone OS 11_4 like Mac OS X) AppleWebKit\/605.1.15 (KHTML, like Gecko) Mobile\/15F79\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lsl\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3eMozilla\/\x3cspan class=\x22hljs-number\x22\x3e5.0\x3c\/span\x3e (iPhone; CPU iPhone OS \x3cspan class=\x22hljs-number\x22\x3e11\x3c\/span\x3e_4 like Mac OS X) AppleWebKit\/\x3cspan class=\x22hljs-number\x22\x3e605.1\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e.15\x3c\/span\x3e (KHTML, like Gecko) Mobile\/\x3cspan class=\x22hljs-number\x22\x3e15\x3c\/span\x3eF79\x3c\/code\x3e\x3c\/pre\x3e\n\x3cul\x3e\x3cli\x3ePC Chrome\x3c\/li\x3e\x3c\/ul\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22Mozilla\/5.0 (Linux; Android 5.0; SM-G900P Build\/LRX21T) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/69.0.3497.100 Mobile Safari\/537.36\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs lsl\x22\x3e\x3ccode style=\x22word-break: break-word; white-space: initial;\x22\x3eMozilla\/\x3cspan class=\x22hljs-number\x22\x3e5.0\x3c\/span\x3e (Linux; Android \x3cspan class=\x22hljs-number\x22\x3e5.0\x3c\/span\x3e; SM-G900P Build\/LRX21T) AppleWebKit\/\x3cspan class=\x22hljs-number\x22\x3e537.36\x3c\/span\x3e (KHTML, like Gecko) Chrome\/\x3cspan class=\x22hljs-number\x22\x3e69.0\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e.3497\x3c\/span\x3e\x3cspan class=\x22hljs-number\x22\x3e.100\x3c\/span\x3e Mobile Safari\/\x3cspan class=\x22hljs-number\x22\x3e537.36\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch4\x3e文中涉及的组件库\x3c\/h4\x3e\n\x3cul\x3e\x3cli\x3eSaltUI: \x3ca href=\x22https:\/\/github.com\/salt-ui\/saltui\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/salt-ui\/sa...\x3c\/a\x3e\n\x3c\/li\x3e\x3c\/ul\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>在格式化的场景下，React input 的光标的处理办法</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000016758141">https://segmentfault.com/a/1190000016758141</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/dl25z1wufyq/" target="_blank">https://alili.tech/archive/dl25z1wufyq/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>