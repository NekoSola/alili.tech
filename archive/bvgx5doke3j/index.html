<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="腾讯新闻 React 同构直出优化实践"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>腾讯新闻 React 同构直出优化实践 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/bvgx5doke3j/",
				"appid": "1613049289050283", 
				"title": "腾讯新闻 React 同构直出优化实践 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-08T02:30:40"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/qioq4rd8ikm/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/7b6a6r0f8sh/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fbvgx5doke3j%2f&text=%e8%85%be%e8%ae%af%e6%96%b0%e9%97%bb%20React%20%e5%90%8c%e6%9e%84%e7%9b%b4%e5%87%ba%e4%bc%98%e5%8c%96%e5%ae%9e%e8%b7%b5"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fbvgx5doke3j%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fbvgx5doke3j%2f&text=%e8%85%be%e8%ae%af%e6%96%b0%e9%97%bb%20React%20%e5%90%8c%e6%9e%84%e7%9b%b4%e5%87%ba%e4%bc%98%e5%8c%96%e5%ae%9e%e8%b7%b5"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fbvgx5doke3j%2f&title=%e8%85%be%e8%ae%af%e6%96%b0%e9%97%bb%20React%20%e5%90%8c%e6%9e%84%e7%9b%b4%e5%87%ba%e4%bc%98%e5%8c%96%e5%ae%9e%e8%b7%b5"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fbvgx5doke3j%2f&is_video=false&description=%e8%85%be%e8%ae%af%e6%96%b0%e9%97%bb%20React%20%e5%90%8c%e6%9e%84%e7%9b%b4%e5%87%ba%e4%bc%98%e5%8c%96%e5%ae%9e%e8%b7%b5"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e8%85%be%e8%ae%af%e6%96%b0%e9%97%bb%20React%20%e5%90%8c%e6%9e%84%e7%9b%b4%e5%87%ba%e4%bc%98%e5%8c%96%e5%ae%9e%e8%b7%b5&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fbvgx5doke3j%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fbvgx5doke3j%2f&title=%e8%85%be%e8%ae%af%e6%96%b0%e9%97%bb%20React%20%e5%90%8c%e6%9e%84%e7%9b%b4%e5%87%ba%e4%bc%98%e5%8c%96%e5%ae%9e%e8%b7%b5"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fbvgx5doke3j%2f&title=%e8%85%be%e8%ae%af%e6%96%b0%e9%97%bb%20React%20%e5%90%8c%e6%9e%84%e7%9b%b4%e5%87%ba%e4%bc%98%e5%8c%96%e5%ae%9e%e8%b7%b5"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fbvgx5doke3j%2f&title=%e8%85%be%e8%ae%af%e6%96%b0%e9%97%bb%20React%20%e5%90%8c%e6%9e%84%e7%9b%b4%e5%87%ba%e4%bc%98%e5%8c%96%e5%ae%9e%e8%b7%b5"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fbvgx5doke3j%2f&title=%e8%85%be%e8%ae%af%e6%96%b0%e9%97%bb%20React%20%e5%90%8c%e6%9e%84%e7%9b%b4%e5%87%ba%e4%bc%98%e5%8c%96%e5%ae%9e%e8%b7%b5"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">腾讯新闻 React 同构直出优化实践</h1><div class="meta"><div class="postdate"><time datetime="2019-02-08" itemprop="datePublished">2019-02-08</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cblockquote\x3e\x3cp\x3e原文地址：\x3ca href=\x22https:\/\/github.com\/lcxfs1991\/blog\/issues\/10)\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ehttps:\/\/github.com\/lcxfs1991\/blog\/issues\/10)\x3c\/a\x3e\x3cbr\x3e本文 starter kit：\x3ca href=\x22https:\/\/github.com\/SteamerTeam\/steamer-react\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3esteamer-react\x3c\/a\x3e\x3c\/p\x3e\x3c\/blockquote\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3e为什么做直出\x3c\/h2\x3e\n\x3cp\x3e就是为了“性能”！！！\x3cbr\x3e按照经验来说，直出，能够减少20% - 50%不等的首屏时间，因此尽管增加一定维护成本，前端们还是前赴后继地在搞直出。\x3c\/p\x3e\n\x3cp\x3e除此之外，有些特定的业务做直出能够弥补前后端分离带来的SEO问题。像这次选取的腾讯新闻，大多数页面首屏其实都是直出的（但肯定不是React直出）。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e性能指标\x3c\/h2\x3e\n\x3cp\x3e刚提到的首屏时间，只是单纯内容的渲染，另外还有首屏可交互时间，即除了内容渲染之余，还能够让用户能够对首屏的内容进行交互，如点击、滚动等等。现在市面上有关React的性能报告，尤其是那些截了Chrome渲染映像的，都归到首屏时间。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e为什么选择腾讯新闻\x3c\/h2\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e我并非腾讯新闻的业务相关方，可以比较大胆地作为例子使用\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e腾讯新闻页面更为丰富，可以做更多场景的实践\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e验证全套脱胎手Q家校群react的优化策略、实践方案和开发工具\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e由于只是实验，数据都是拉取腾讯新闻现网提供的，而样式简单地仿照了一下，做得略粗糙，请见谅。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader3\x22\x3e参考的资料和使用的工具\x3c\/h2\x3e\n\x3cp\x3e做这次实践阅读了不少文章，文章提到过的内容我这里就不再赘述了，后文主要是做补充。\x3cbr\x3e这次同构直出实践，我们使用的是脱胎于手Q家校群的react start kit，名曰\x3ca href=\x22https:\/\/github.com\/SteamerTeam\/steamer-react\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3esteamer-react\x3c\/a\x3e。目前可以试用。它有2个分支，一个是react分支，目前只是提供纯前端的boilerplate。另一个是react-isomorphic，同时包括前端和后台的boilerplate。有什么问题可以给我提issue。\x3c\/p\x3e\n\x3cp\x3e文章：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22http:\/\/www.aliued.com\/?p=3077\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eReact\x2bRedux 同构应用开发\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/segmentfault.com\/a\/1190000004671209#articleHeader2\x22\x3eReact 同构实践与思考\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/joeyguo\/blog\/issues\/9\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eReact同构直出优化总结\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22http:\/\/toutiao.com\/i6284121573897011714\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eReactJS 服务端同构实践QQ音乐web团队\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/strongloop.com\/strongblog\/node-js-react-isomorphic-javascript-why-it-matters\/\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eHow to Implement Node \x2b React Isomorphic JavaScript \x26amp; Why it Matters\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e\x3ca href=\x22https:\/\/github.com\/lcxfs1991\/blog\/issues\/6\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e性能优化三部曲之三——Node直出让你的网页秒开\x3c\/a\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch2 id=\x22articleHeader4\x22\x3e分析场景\x3c\/h2\x3e\n\x3cp\x3e这次我们选取的是腾讯新闻的列表页、详情页和评论页。平时我们浏览腾讯新闻的时候，都会发现从列表页进详情页，或者从详情页进入评论页，都需要跳转，就像steamer-react中，访问index.html页一样。这样对于用户体验欠佳，因此我做了另外一版，spa.html，使用react \x2b react-router做了一版无跳转的单页面应用。\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e列表页\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVyxmZ\x22 src=\x22https:\/\/static.alili.tech\/img\/bVyxmZ\x22 alt=\x22492be8be-3c0b-11e6-9974-3d96c9b27539.png\x22 title=\x22492be8be-3c0b-11e6-9974-3d96c9b27539.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e详情页\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVyxnf\x22 src=\x22https:\/\/static.alili.tech\/img\/bVyxnf\x22 alt=\x2250985844-3c0b-11e6-9002-c109213d8fec.png\x22 title=\x2250985844-3c0b-11e6-9002-c109213d8fec.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e评论页\x3cbr\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVyxnj\x22 src=\x22https:\/\/static.alili.tech\/img\/bVyxnj\x22 alt=\x225575867a-3c0b-11e6-9266-ce51e90ecb13.png\x22 title=\x225575867a-3c0b-11e6-9266-ce51e90ecb13.png\x22 style=\x22cursor: pointer;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3cp\x3e可是单页面应用在SEO的优化方面，处于略势，因此对于新闻类业务来说，需要做直出来弥补。下面我们逐步来拆解React同构直出的步骤。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader5\x22\x3e用Koa搭建后台\x3c\/h2\x3e\n\x3cp\x3eAlloyTeam团队目前以Koa为基础搭建了玄武直出平台，目前不少手Q基础的web业务也有接入，包括早前做过同构优化的手Q家校群列表页。是次实践，在steamer-react下面新建了一个node文件夹，存放后台服务。后台服务包括返回数据的api，还有直出的controller层。controller层仿照玄武的写法，对于腾讯内的同事，做适当修改便可以快速接入玄武直出平台，对于腾讯外的，也可以作有用的参照，嵌入自己的业务也不费什么功夫。\x3c\/p\x3e\n\x3cp\x3e那直出的controller层具体怎么写呢？\x3c\/p\x3e\n\x3cp\x3e直出controller层和数据返回的api都一律写在controller.js里面，然后去require存放在node\/asset\/下面具体直出逻辑文件，然后将yield出来的值直接吐出来：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22exports.spa = function* () {\n    let dir = path.dirname(path.resolve()),\n        appPath = path.join(dir, \x27\/pub\/node\/index.js\x27);\n\n    if (fs.existsSync(appPath)) {  \/\/ 若asset中无此文件，则输出其它值\n        var ReactRender = require(appPath);\n        yield ReactRender(this.request, this.response);   \/\/ 给ReactRender函数传入request和response\n        this.body = this.response.body;\n    }\n    else {\n        this.body = \x26quot;spa list\x26quot;;\n    }\n};\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3eexports.spa = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e* (\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e dir = path.dirname(path.resolve()),\n        appPath = path.join(dir, \x3cspan class=\x22hljs-string\x22\x3e\x27\/pub\/node\/index.js\x27\x3c\/span\x3e);\n\n    \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (fs.existsSync(appPath)) {  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 若asset中无此文件，则输出其它值\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e ReactRender = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(appPath);\n        \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e ReactRender(\x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.request, \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.response);   \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 给ReactRender函数传入request和response\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.body = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.response.body;\n    }\n    \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n        \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.body = \x3cspan class=\x22hljs-string\x22\x3e\x22spa list\x22\x3c\/span\x3e;\n    }\n};\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e而ReactRender函数，大概长这样，其实就是一个generator function，具体拉取数据和React同构渲染的逻辑都写在这里面。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22module.exports = function* (req, res) {\n    \/\/ some code\n｝\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs openscad\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3emodule\x3c\/span\x3e.\x3cspan class=\x22hljs-title\x22\x3eexports\x3c\/span\x3e =\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e* \x3cspan class=\x22hljs-params\x22\x3e(req, res)\x3c\/span\x3e {\x3c\/span\x3e\n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ some code\x3c\/span\x3e\n｝\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e你直接写好的逻辑，有不少可能node并不识别，例如import, window对象等，这些需要构建去处理，后文会有论述。\x3c\/p\x3e\n\x3cp\x3e其实整个直出过程非常简单。基本就是三部曲，拉数据、存数据和吐内容。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader6\x22\x3e拉数据\x3c\/h3\x3e\n\x3cp\x3e拉数据这里封装了一个requestSync的库，可以直接通过yield对request库做同步的写法：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ requestSync.js\nvar request = require(\x27request\x27);\n\nexports.requestSync = function(option) {\n    return function(callback) {\n        request(option, function (error, response, body) {\n                callback(error, response);\n        });\n    };\n} ;\n\n\/\/ 拉数据逻辑\nvar response = yield requestSync.requestSync({\n    uri: CGI_PATH[\x27GET_TOP_NEWS\x27] \x2b urlParam,\n    method: \x27GET\x27\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ requestSync.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e request = \x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27request\x27\x3c\/span\x3e);\n\nexports.requestSync = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eoption\x3c\/span\x3e) \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3ecallback\x3c\/span\x3e) \x3c\/span\x3e{\n        request(option, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e (\x3cspan class=\x22hljs-params\x22\x3eerror, response, body\x3c\/span\x3e) \x3c\/span\x3e{\n                callback(error, response);\n        });\n    };\n} ;\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 拉数据逻辑\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e response = \x3cspan class=\x22hljs-keyword\x22\x3eyield\x3c\/span\x3e requestSync.requestSync({\n    \x3cspan class=\x22hljs-attr\x22\x3euri\x3c\/span\x3e: CGI_PATH[\x3cspan class=\x22hljs-string\x22\x3e\x27GET_TOP_NEWS\x27\x3c\/span\x3e] \x2b urlParam,\n    \x3cspan class=\x22hljs-attr\x22\x3emethod\x3c\/span\x3e: \x3cspan class=\x22hljs-string\x22\x3e\x27GET\x27\x3c\/span\x3e\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e\/\/ 在编译的时候，你可能会发现\x3ccode\x3erequire(\x27request\x27)\x3c\/code\x3e报错，这是因为你缺少了一些babel插件。但也有另外一个办法让你去寻找一个不知名的babel插件。我改用plugin(\x27requestSync\x27)而不是require。因为require会直接去读取node_modules包的内容，plugin并不会编译，它会保留原样，等Koa读取的时候再实时运行。plugin实质是定义在global全局变量里的一个函数，然后将它nodeUtils在controller.js中require进来，就能达到保留原样的效果。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22\/\/ 直出逻辑\nvar requestSync = plugin(\x27requestSync\x27);\n\n\/\/ nodeUtils.js\nglobal.plugin = function(pkg) {\n    return require(\x27.\/\x27 \x2b pkg);\n}\n\n\/\/ controller.js\nvar nodeUtils = require(\x27..\/common\/nodeUtils\x27);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs php\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-comment\x22\x3e\/\/ 直出逻辑\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e requestSync = plugin(\x3cspan class=\x22hljs-string\x22\x3e\x27requestSync\x27\x3c\/span\x3e);\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ nodeUtils.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3eglobal\x3c\/span\x3e.plugin = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e\x3cspan class=\x22hljs-params\x22\x3e(pkg)\x3c\/span\x3e \x3c\/span\x3e{\n    \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e \x3cspan class=\x22hljs-keyword\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27.\/\x27\x3c\/span\x3e \x2b pkg);\n}\n\n\x3cspan class=\x22hljs-comment\x22\x3e\/\/ controller.js\x3c\/span\x3e\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e nodeUtils = \x3cspan class=\x22hljs-keyword\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27..\/common\/nodeUtils\x27\x3c\/span\x3e);\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader7\x22\x3e存数据\x3c\/h3\x3e\n\x3cp\x3e由于我们采用redux做统一数据的处理，因此我们需要将数据存一份到store里，以便后面吐内容。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22const store = configureStore();\n\nstore.dispatch({\n        type: \x27xxx action\x27,\n        data: response.body,\n        param:{\n            \n        }\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs haskell\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-title\x22\x3econst\x3c\/span\x3e store = configureStore();\n\n\x3cspan class=\x22hljs-title\x22\x3estore\x3c\/span\x3e.dispatch({\n        \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3etype\x3c\/span\x3e: \x27xxx action\x27,\x3c\/span\x3e\n        \x3cspan class=\x22hljs-class\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3edata\x3c\/span\x3e: response.body,\x3c\/span\x3e\n        param:{\n            \n        }\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch3 id=\x22articleHeader8\x22\x3e吐内容\x3c\/h3\x3e\n\x3cp\x3e如果我们没有使用react-router，我们直接将store存给最主要的React Component，然后就可以开始直出了，像这样：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22import { renderToString } from \x27react-dom\/server\x27;\nvar Root = React.createFactory(require(\x27Root\x27).default);\nren html = renderToString(Root(store.getState()));\n\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs livescript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e { renderToString } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27react-dom\/server\x27\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e Root = React.createFactory(\x3cspan class=\x22hljs-built_in\x22\x3erequire\x3c\/span\x3e(\x3cspan class=\x22hljs-string\x22\x3e\x27Root\x27\x3c\/span\x3e).\x3cspan class=\x22hljs-keyword\x22\x3edefault\x3c\/span\x3e);\nren html = renderToString(Root(store.getState()));\n\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e但如果我们使用了react-router，我们就需要引用react-router比较底层的match来做路径匹配和内容吐出。\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22import { match, RouterContext } from \x27react-router\x27;\nimport { routeConfig } from \x27routes\x27;\n\nmatch({ routes: routeConfig, location: req.url }, (error, redirectLocation, renderProps) =\x3e {\n     if (renderProps) {\n     reactHtml = renderToString(\n        \x3cProvider store={store}\x3e\n            \x3cRouterContext {...renderProps} \/\x3e\n        \x3c\/Provider\x3e\n    );\n     } \n    else {\n      res.body = \x26quot;404\x26quot;;\n    }\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs moonscript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e { match, RouterContext } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27react-router\x27\x3c\/span\x3e;\n\x3cspan class=\x22hljs-keyword\x22\x3eimport\x3c\/span\x3e { routeConfig } \x3cspan class=\x22hljs-keyword\x22\x3efrom\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27routes\x27\x3c\/span\x3e;\n\nmatch({ \x3cspan class=\x22hljs-name\x22\x3eroutes\x3c\/span\x3e: routeConfig, \x3cspan class=\x22hljs-name\x22\x3elocation\x3c\/span\x3e: req.url }, \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-params\x22\x3e(\x3cspan class=\x22hljs-built_in\x22\x3eerror\x3c\/span\x3e, redirectLocation, renderProps)\x3c\/span\x3e =\x26gt;\x3c\/span\x3e {\n     \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e (renderProps) {\n     reactHtml = renderToString(\n        \x26lt;Provider store={store}\x26gt;\n            \x26lt;RouterContext {...renderProps} \/\x26gt;\n        \x26lt;\/Provider\x26gt;\n    );\n     } \n    \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n      res.body = \x3cspan class=\x22hljs-string\x22\x3e\x22404\x22\x3c\/span\x3e;\n    }\n});\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e客户端也需要做类似的写法，且我们不采用hashHistory，而是browserHistory\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22let  history = syncHistoryWithStore(browserHistory, store);\nconst { pathname, search, hash } = window.location;\nconst location = `${pathname}${search}${hash}`;\n\nmatch({ routes: routeConfig, location: location }, () =\x3e {\n    render(\n        \x3cProvider store={store}\x3e \/\/  Redux相关\n            \x3cdiv\x3e\n                \x3cRouter routes={routeConfig} history={history} \/\x3e \/\/ Router 相关\n            \x3c\/div\x3e\n        \x3c\/Provider\x3e,\n        document.getElementById(\x27pages\x27)\n    )\n});\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs javascript\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-keyword\x22\x3elet\x3c\/span\x3e  history = syncHistoryWithStore(browserHistory, store);\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e { pathname, search, hash } = \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.location;\n\x3cspan class=\x22hljs-keyword\x22\x3econst\x3c\/span\x3e location = \x3cspan class=\x22hljs-string\x22\x3e`\x3cspan class=\x22hljs-subst\x22\x3e${pathname}\x3c\/span\x3e\x3cspan class=\x22hljs-subst\x22\x3e${search}\x3c\/span\x3e\x3cspan class=\x22hljs-subst\x22\x3e${hash}\x3c\/span\x3e`\x3c\/span\x3e;\n\nmatch({ \x3cspan class=\x22hljs-attr\x22\x3eroutes\x3c\/span\x3e: routeConfig, \x3cspan class=\x22hljs-attr\x22\x3elocation\x3c\/span\x3e: location }, () =\x26gt; {\n    render(\n        \x3cspan class=\x22xml\x22\x3e\x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eProvider\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3estore\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{store}\x3c\/span\x3e\x26gt;\x3c\/span\x3e \/\/  Redux相关\n            \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n                \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\x3cspan class=\x22hljs-name\x22\x3eRouter\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3eroutes\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{routeConfig}\x3c\/span\x3e \x3cspan class=\x22hljs-attr\x22\x3ehistory\x3c\/span\x3e=\x3cspan class=\x22hljs-string\x22\x3e{history}\x3c\/span\x3e \/\x26gt;\x3c\/span\x3e \/\/ Router 相关\n            \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3ediv\x3c\/span\x3e\x26gt;\x3c\/span\x3e\n        \x3cspan class=\x22hljs-tag\x22\x3e\x26lt;\/\x3cspan class=\x22hljs-name\x22\x3eProvider\x3c\/span\x3e\x26gt;\x3c\/span\x3e,\n        document.getElementById(\x27pages\x27)\n    )\n});\x3c\/span\x3e\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在吐内容(html)的同时，请记得将store也吐一份到\x3ccode\x3e\x26lt;script\x26gt;\x3c\/code\x3e标签里，因为客户端的js中也需要用到。\x3c\/p\x3e\n\x3cp\x3e在首次吐出内容之后，你会发现还不能马上进行交互，需要客户端再次执行一行Root.js里面的代码，才能够将可交互的事件绑定。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader9\x22\x3e前端代码的改动\x3c\/h2\x3e\n\x3cp\x3e前端的代码改动不大，不过前端这里主要完成最后关键的一步，事件挂载。\x3c\/p\x3e\n\x3ch3 id=\x22articleHeader10\x22\x3e事件挂载\x3c\/h3\x3e\n\x3cp\x3e后台渲染完后，给客户端吐出html字符串，这时还没有任何事件的绑定，需要客户端的代码进行事件挂载，这里需要注意2点：\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e\x3cp\x3e保持dom结构一致\x3cbr\x3e否则会报错或者触发重新渲染\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e将部份事件放到componentDitMount中触发\x3cbr\x3e服务端的生命周期只走到componentWillMount，而客户端则会有完整的生命周期，因此部份事件可以挪到componentDidMount中处理。例如这次实践做的列表页有一个我的收藏功能，这里的数据存储用到localstorage。这个服务端无法渲染，因此会选择在componentDidMount的时候再去触发读取localstorage数据的action。\x3c\/p\x3e\x3c\/li\x3e\n\x3cli\x3e\x3cp\x3e兼顾后台没有的对象\x3cbr\x3e除了以上提到的，前端部份的代码主要注意的是一些后台没有的对象，例如window。可以通过构建手段注入全局变量去替换或者在服务端渲染的时候不执行部份代码。\x3c\/p\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3ch2 id=\x22articleHeader11\x22\x3e构建的使用\x3c\/h2\x3e\n\x3cp\x3ereact-isomorphic比react的分支多了一个webpack.node.js，用于设置直出的相关构建内容。一些需要留意的配置如下：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22target: \x27node\x27,  \/\/ 构建输出node可以识别的内容\nnode: {\n    __filename: true,\n    __dirname: true\n},\n{ \n    test: \/\\.js?$\/,\n    loader: \x27babel\x27,\n    query: {\n        cacheDirectory: \x27\/webpack_cache\/\x27,\n        plugins: [\n            \x27transform-decorators-legacy\x27,\n            [\n                \x26quot;transform-runtime\x26quot;, {  \n                    \x26quot;polyfill\x26quot;: false,\n                    \x26quot;regenerator\x26quot;: true \/\/ 识别regenerator\n                }\n            ]\n        ],\n        presets: [\n            \x27es2015-loose\x27, \n            \x27react\x27,\n        ]\n    },\n    exclude: \/node_modules\/,\n},\n{\n    test: \/\\.css$\/,\n    loader: \x26quot;ignore-loader\x26quot;,   \/\/ ignore-loader对css\/scss输出空内容\n},\nplugins: [\n    new webpack.BannerPlugin(\x26quot;module.exports = \x26quot;, {entryOnly : true, raw: true}), \n    \/\/ react\/node\/asset\/下的文件生产到\/react\/pub\/node\/之后，需要在最前面注入module.exports，\n   \/\/ 这样Koa才能正常引用\n]\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22hljs groovy\x22\x3e\x3ccode\x3e\x3cspan class=\x22hljs-string\x22\x3etarget:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27node\x27\x3c\/span\x3e,  \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 构建输出node可以识别的内容\x3c\/span\x3e\n\x3cspan class=\x22hljs-string\x22\x3enode:\x3c\/span\x3e {\n\x3cspan class=\x22hljs-symbol\x22\x3e    __filename:\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e,\n\x3cspan class=\x22hljs-symbol\x22\x3e    __dirname:\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e\n},\n{ \n\x3cspan class=\x22hljs-symbol\x22\x3e    test:\x3c\/span\x3e \x3cspan class=\x22hljs-regexp\x22\x3e\/\\.js?$\/\x3c\/span\x3e,\n\x3cspan class=\x22hljs-symbol\x22\x3e    loader:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27babel\x27\x3c\/span\x3e,\n\x3cspan class=\x22hljs-symbol\x22\x3e    query:\x3c\/span\x3e {\n\x3cspan class=\x22hljs-symbol\x22\x3e        cacheDirectory:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x27\/webpack_cache\/\x27\x3c\/span\x3e,\n\x3cspan class=\x22hljs-symbol\x22\x3e        plugins:\x3c\/span\x3e [\n            \x3cspan class=\x22hljs-string\x22\x3e\x27transform-decorators-legacy\x27\x3c\/span\x3e,\n            [\n                \x3cspan class=\x22hljs-string\x22\x3e\x22transform-runtime\x22\x3c\/span\x3e, {  \n                    \x3cspan class=\x22hljs-string\x22\x3e\x22polyfill\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3efalse\x3c\/span\x3e,\n                    \x3cspan class=\x22hljs-string\x22\x3e\x22regenerator\x22\x3c\/span\x3e: \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 识别regenerator\x3c\/span\x3e\n                }\n            ]\n        ],\n\x3cspan class=\x22hljs-symbol\x22\x3e        presets:\x3c\/span\x3e [\n            \x3cspan class=\x22hljs-string\x22\x3e\x27es2015-loose\x27\x3c\/span\x3e, \n            \x3cspan class=\x22hljs-string\x22\x3e\x27react\x27\x3c\/span\x3e,\n        ]\n    },\n\x3cspan class=\x22hljs-symbol\x22\x3e    exclude:\x3c\/span\x3e \x3cspan class=\x22hljs-regexp\x22\x3e\/node_modules\/\x3c\/span\x3e,\n},\n{\n\x3cspan class=\x22hljs-symbol\x22\x3e    test:\x3c\/span\x3e \x3cspan class=\x22hljs-regexp\x22\x3e\/\\.css$\/\x3c\/span\x3e,\n\x3cspan class=\x22hljs-symbol\x22\x3e    loader:\x3c\/span\x3e \x3cspan class=\x22hljs-string\x22\x3e\x22ignore-loader\x22\x3c\/span\x3e,   \x3cspan class=\x22hljs-comment\x22\x3e\/\/ ignore-loader对css\/scss输出空内容\x3c\/span\x3e\n},\n\x3cspan class=\x22hljs-string\x22\x3eplugins:\x3c\/span\x3e [\n    \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e webpack.BannerPlugin(\x3cspan class=\x22hljs-string\x22\x3e\x22module.exports = \x22\x3c\/span\x3e, {\x3cspan class=\x22hljs-string\x22\x3eentryOnly :\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e, \x3cspan class=\x22hljs-string\x22\x3eraw:\x3c\/span\x3e \x3cspan class=\x22hljs-literal\x22\x3etrue\x3c\/span\x3e}), \n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/ react\/node\/asset\/下的文件生产到\/react\/pub\/node\/之后，需要在最前面注入module.exports，\x3c\/span\x3e\n   \x3cspan class=\x22hljs-comment\x22\x3e\/\/ 这样Koa才能正常引用\x3c\/span\x3e\n]\x3c\/code\x3e\x3c\/pre\x3e\n\x3ch2 id=\x22articleHeader12\x22\x3e性能优化\x3c\/h2\x3e\n\x3cp\x3e如下面两图，是直出前后的Chrome映像对比图，直出要比非直出快400ms，近40%的性能提升。除了直出之外，还采用了react-router，使页面可以无缝切换，大大提高了用户的体验。你可能还会担心这么多页面的逻辑放在一个js bundle会让js很大，如果js bundle膨胀到一定程度，你可以考虑使用webpack和react-router的特性进行拆包。\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVyxnq\x22 src=\x22https:\/\/static.alili.tech\/img\/bVyxnq\x22 alt=\x22cd5cca16-3c12-11e6-8aca-64dccaf72a36.png\x22 title=\x22cd5cca16-3c12-11e6-8aca-64dccaf72a36.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cspan class=\x22img-wrap\x22\x3e\x3cimg data-src=\x22\/img\/bVyxns\x22 src=\x22https:\/\/static.alili.tech\/img\/bVyxns\x22 alt=\x22cd697da6-3c12-11e6-8923-c741b45bcf86.png\x22 title=\x22cd697da6-3c12-11e6-8923-c741b45bcf86.png\x22 style=\x22cursor: pointer; display: inline;\x22\x3e\x3c\/span\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader13\x22\x3e总结\x3c\/h2\x3e\n\x3cp\x3e可能你会惊诧于习惯写长文的我居然只写这么少，但React同构下出真的就是这么简单，而借助脱胎于手Q家校群，验证于腾讯新闻的\x3ca href=\x22https:\/\/github.com\/SteamerTeam\/steamer-react\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3esteamer-react\x3c\/a\x3e start kit，你会更事半功倍。\x3c\/p\x3e\n\x3cp\x3e如有错误，恳请斧正。\x3c\/p\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>腾讯新闻 React 同构直出优化实践</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000005809109">https://segmentfault.com/a/1190000005809109</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/bvgx5doke3j/" target="_blank">https://alili.tech/archive/bvgx5doke3j/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>