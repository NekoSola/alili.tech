<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="移动端H5图片上传的那些坑"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css"><meta property="og:site_name" content="Alili"><title>移动端H5图片上传的那些坑 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error", function (e) {
			  var elem = e.target;
			  if (elem.tagName.toLowerCase() == 'img') {
				elem.style.display='none'
			  }
			}, true);</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/q1asu08u6b/",
				"appid": "1613049289050283", 
				"title": "移动端H5图片上传的那些坑 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2019-02-06T02:30:09"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/qzalzfno9v/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li><li><a class="icon" href="https://alili.tech/archive/wrkud8yfv6/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li><li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li></ul><span id="i-prev" class="info" style="display:none;">Previous post</span> <span id="i-next" class="info" style="display:none;">Next post</span> <span id="i-top" class="info" style="display:none;">Back to top</span> <span id="i-share" class="info" style="display:none;">Share post</span></span><br><div id="share" style="display: none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2fq1asu08u6b%2f&text=%e7%a7%bb%e5%8a%a8%e7%ab%afH5%e5%9b%be%e7%89%87%e4%b8%8a%e4%bc%a0%e7%9a%84%e9%82%a3%e4%ba%9b%e5%9d%91"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2fq1asu08u6b%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2fq1asu08u6b%2f&text=%e7%a7%bb%e5%8a%a8%e7%ab%afH5%e5%9b%be%e7%89%87%e4%b8%8a%e4%bc%a0%e7%9a%84%e9%82%a3%e4%ba%9b%e5%9d%91"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2fq1asu08u6b%2f&title=%e7%a7%bb%e5%8a%a8%e7%ab%afH5%e5%9b%be%e7%89%87%e4%b8%8a%e4%bc%a0%e7%9a%84%e9%82%a3%e4%ba%9b%e5%9d%91"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2fq1asu08u6b%2f&is_video=false&description=%e7%a7%bb%e5%8a%a8%e7%ab%afH5%e5%9b%be%e7%89%87%e4%b8%8a%e4%bc%a0%e7%9a%84%e9%82%a3%e4%ba%9b%e5%9d%91"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=%e7%a7%bb%e5%8a%a8%e7%ab%afH5%e5%9b%be%e7%89%87%e4%b8%8a%e4%bc%a0%e7%9a%84%e9%82%a3%e4%ba%9b%e5%9d%91&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2fq1asu08u6b%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2fq1asu08u6b%2f&title=%e7%a7%bb%e5%8a%a8%e7%ab%afH5%e5%9b%be%e7%89%87%e4%b8%8a%e4%bc%a0%e7%9a%84%e9%82%a3%e4%ba%9b%e5%9d%91"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fq1asu08u6b%2f&title=%e7%a7%bb%e5%8a%a8%e7%ab%afH5%e5%9b%be%e7%89%87%e4%b8%8a%e4%bc%a0%e7%9a%84%e9%82%a3%e4%ba%9b%e5%9d%91"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fq1asu08u6b%2f&title=%e7%a7%bb%e5%8a%a8%e7%ab%afH5%e5%9b%be%e7%89%87%e4%b8%8a%e4%bc%a0%e7%9a%84%e9%82%a3%e4%ba%9b%e5%9d%91"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2fq1asu08u6b%2f&title=%e7%a7%bb%e5%8a%a8%e7%ab%afH5%e5%9b%be%e7%89%87%e4%b8%8a%e4%bc%a0%e7%9a%84%e9%82%a3%e4%ba%9b%e5%9d%91"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">移动端H5图片上传的那些坑</h1><div class="meta"><div class="postdate"><time datetime="2019-02-06" itemprop="datePublished">2019-02-06</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><p style="opacity: 0;">Alili | 前端大爆炸! - WEB BANG! BANG!! BANG!!! 前端大爆炸,一个前端技术博客.想到哪,学到哪,写到哪. 本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有， Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js</p><script>$(function () {
            var html = "\n\n                    \n\x3cp\x3e上周做一个关于移动端图片压缩上传的功能。期间踩了几个坑，在此总结下。\x3c\/p\x3e\n\x3cp\x3e大体的思路是，部分API的兼容性请参照\x3ca\x3ecaniuse\x3c\/a\x3e：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e利用\x3ca href=\x22https:\/\/developer.mozilla.org\/zh-CN\/docs\/Web\/API\/FileReader\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3eFileReader\x3c\/a\x3e,读取\x3ccode\x3eblob对象\x3c\/code\x3e,或者是\x3ccode\x3efile对象\x3c\/code\x3e，将图片转化为\x3ccode\x3edata uri\x3c\/code\x3e的形式。\x3c\/li\x3e\n\x3cli\x3e使用\x3ccode\x3ecanvas\x3c\/code\x3e,在页面上新建一个画布,利用\x3ccode\x3ecanvas\x3c\/code\x3e提供的API,将图片画入这个画布当中。\x3c\/li\x3e\n\x3cli\x3e利用\x3ccode\x3ecanvas.toDataURL()\x3c\/code\x3e，进行图片的压缩，得到图片的\x3ccode\x3edata uri\x3c\/code\x3e的值\x3c\/li\x3e\n\x3cli\x3e上传文件。\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e步骤1当中，在进行图片压缩前，还是对图片大小做了判断的，如果图片大小大于200KB时，是直接进行图片上传，不进行图片的压缩，如果图片的大小是大于200KB，则是先进行图片的压缩再上传:\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    \x3cinput type=\x26quot;file\x26quot; id=\x26quot;choose\x26quot; accept=\x26quot;image\/*\x26quot;\x3e\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22 style=\x22word-break: break-word; white-space: initial;\x22\x3e    \x26lt;input type=\x3cspan class=\x22hljs-string\x22\x3e\x22file\x22\x3c\/span\x3e id=\x3cspan class=\x22hljs-string\x22\x3e\x22choose\x22\x3c\/span\x3e accept=\x3cspan class=\x22hljs-string\x22\x3e\x22image\/*\x22\x3c\/span\x3e\x26gt;\x3c\/code\x3e\x3c\/pre\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    var fileChooser = document.getElementById(\x26quot;choose\x26quot;),\n        maxSize = 200 * 1024;   \/\/200KB\n    fileChoose.change = function() {\n        var file = this.files[0],   \/\/读取文件\n            reader = new FileReader();\n            \n            reader.onload = function() {\n                var result = this.result,   \/\/result为data url的形式\n                    img = new Image(),\n                    img.src = result;\n                    \n                    \n                if(result.length \x3c maxSize) {  \n                    imgUpload(result);      \/\/图片直接上传\n                } else {\n                    var data = compress(img);    \/\/图片首先进行压缩\n                    imgUpload(data);                \/\/图片上传\n                }\n            }\n            \n            reader.readAsDataURL(file);\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e fileChooser = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.getElementById(\x3cspan class=\x22hljs-string\x22\x3e\x22choose\x22\x3c\/span\x3e),\n        maxSize = \x3cspan class=\x22hljs-number\x22\x3e200\x3c\/span\x3e * \x3cspan class=\x22hljs-number\x22\x3e1024\x3c\/span\x3e;   \x3cspan class=\x22hljs-comment\x22\x3e\/\/200KB\x3c\/span\x3e\n    fileChoose.change = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e file = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.files[\x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e],   \x3cspan class=\x22hljs-comment\x22\x3e\/\/读取文件\x3c\/span\x3e\n            reader = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e FileReader();\n            \n            reader.onload = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n                \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e result = \x3cspan class=\x22hljs-keyword\x22\x3ethis\x3c\/span\x3e.result,   \x3cspan class=\x22hljs-comment\x22\x3e\/\/result为data url的形式\x3c\/span\x3e\n                    img = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e Image(),\n                    img.src = result;\n                    \n                    \n                \x3cspan class=\x22hljs-keyword\x22\x3eif\x3c\/span\x3e(result.length \x26lt; maxSize) {  \n                    imgUpload(result);      \x3cspan class=\x22hljs-comment\x22\x3e\/\/图片直接上传\x3c\/span\x3e\n                } \x3cspan class=\x22hljs-keyword\x22\x3eelse\x3c\/span\x3e {\n                    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e data = compress(img);    \x3cspan class=\x22hljs-comment\x22\x3e\/\/图片首先进行压缩\x3c\/span\x3e\n                    imgUpload(data);                \x3cspan class=\x22hljs-comment\x22\x3e\/\/图片上传\x3c\/span\x3e\n                }\n            }\n            \n            reader.readAsDataURL(file);\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e步骤2，3：\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    var canvas = document.createElement(\x27canvas\x27),\n        ctx = canvas.getContext(\x272d\x27);\n        \n    function compress(img) {\n        canvas.width = img.width;\n        canvas.height = img.height;\n        \n        \/\/利用canvas进行绘图\n        \n        \/\/将原来图片的质量压缩到原先的0.2倍。\n        var data = canvas.toDataURL(\x27image\/jpeg\x27, 0.2); \/\/data url的形式\n        \n        return data;\n    }\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e canvas = \x3cspan class=\x22hljs-built_in\x22\x3edocument\x3c\/span\x3e.createElement(\x3cspan class=\x22hljs-string\x22\x3e\x27canvas\x27\x3c\/span\x3e),\n        ctx = canvas.getContext(\x3cspan class=\x22hljs-string\x22\x3e\x272d\x27\x3c\/span\x3e);\n        \n    \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e \x3cspan class=\x22hljs-title\x22\x3ecompress\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3eimg\x3c\/span\x3e) \x3c\/span\x3e{\n        canvas.width = img.width;\n        canvas.height = img.height;\n        \n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/利用canvas进行绘图\x3c\/span\x3e\n        \n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/将原来图片的质量压缩到原先的0.2倍。\x3c\/span\x3e\n        \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e data = canvas.toDataURL(\x3cspan class=\x22hljs-string\x22\x3e\x27image\/jpeg\x27\x3c\/span\x3e, \x3cspan class=\x22hljs-number\x22\x3e0.2\x3c\/span\x3e); \x3cspan class=\x22hljs-comment\x22\x3e\/\/data url的形式\x3c\/span\x3e\n        \n        \x3cspan class=\x22hljs-keyword\x22\x3ereturn\x3c\/span\x3e data;\n    }\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在利用canvas进行绘图的过程中,IOS图片上传过程中，存在着这样的问题：\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e当你竖着拿手机的时候，拍完照，上传图片时，会出现照片自动旋转的情况，而横着拍照并上传图片时不会出现这个问题。这个时候如果想纠正图片自动旋转的情况，将图片转化为二进制的数据\x3ccode\x3e(使用了binaryajax.js)\x3c\/code\x3e，方便获取图片的\x3ccode\x3eexif信息\x3c\/code\x3e，通过获取\x3ccode\x3eexif的信息\x3c\/code\x3e来确定图片旋转的角度\x3ccode\x3e(使用了exif.js)\x3c\/code\x3e，然后再进行图片相应的旋转处理。\x3ca href=\x22http:\/\/bbs.it-home.org\/thread-55474-1-1.html\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e解决方法请戳我\x3c\/a\x3e\n\x3c\/li\x3e\n\x3cli\x3e在\x3ccode\x3eIOS\x3c\/code\x3e中，当图片的大小大于 2MB时，会出现图片压扁的情况，这个时候需要重置图片的比例。\x3ca href=\x22http:\/\/stackoverflow.com\/questions\/11929099\/html5-canvas-drawimage-ratio-bug-ios\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e解决方法请戳我\x3c\/a\x3e\n\x3c\/li\x3e\n\x3cli\x3e利用FileReader，读取图片的过程需要花费一定时间,将图片数据注入到canvas画布中需要一定时间，图片压缩的过程中，图片越大，CPU计算消耗的时间也越长，可能会出现顿卡的情况。总之，就是这个过程当中需要花费一定时间。\x3c\/li\x3e\n\x3cli\x3eIOS8.1的版本中有个\x3ccode\x3eFileReader\x3c\/code\x3e的bug: \x3ccode\x3eFileReader\x3c\/code\x3e读取的图片转化为Base64时，字符串为空，\x3ca href=\x22http:\/\/stackoverflow.com\/questions\/25999083\/filereader-not-working-on-ios-8\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e具体的问题描述请戳我\x3c\/a\x3e\n\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e步骤4,文件上传有2种方式:\x3c\/p\x3e\n\x3col\x3e\n\x3cli\x3e将图片转化为base64\x3c\/li\x3e\n\x3cli\x3e将图片数据转为Blob对象，使用FormData上传文件\x3c\/li\x3e\n\x3c\/ol\x3e\n\x3cp\x3e方式1可以通过xhr ajax或者xhr2 FormData进行提交。\x3c\/p\x3e\n\x3cp\x3e方法2这里就有个大坑了。\x3ca href=\x22https:\/\/code.google.com\/p\/android\/issues\/detail?id=39882\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e具体描述请戳我\x3c\/a\x3e\x3c\/p\x3e\n\x3cp\x3e简单点说就是：\x3ccode\x3eBlob对象\x3c\/code\x3e是无法注入到\x3ccode\x3eFormData对象\x3c\/code\x3e当中的。\x3c\/p\x3e\n\x3cp\x3e当你拿到了图片的\x3ccode\x3edata uri数据\x3c\/code\x3e后，将其转化为\x3ccode\x3eBlob\x3c\/code\x3e数据类型\x3c\/p\x3e\n\x3cdiv class=\x22widget-codetool\x22 style=\x22display:none;\x22\x3e\n      \x3cdiv class=\x22widget-codetool--inner\x22\x3e\n      \x3cspan class=\x22selectCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22全选\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22copyCode code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 data-clipboard-text=\x22    var ndata = compress(img);\n    ndata = window.atob(ndata); \/\/将base64格式的数据进行解码\n    \n    \/\/新建一个buffer对象，用以存储图片数据\n    var buffer = new Uint8Array(ndata.length);\n    for(var i = 0; i \x3c text.length; i\x2b\x2b) {\n        buffer[i] = ndata.charCodeAt(i);\n    }\n    \n    \/\/将buffer对象转化为Blob数据类型\n    var blob = getBlob([buffer]);\n    \n    var fd = new FormData(),\n        xhr = new XMLHttpRequest();\n    fd.append(\x27file\x27, blob);\n    \n    xhr.open(\x27post\x27, url);\n    xhr.onreadystatechange = function() {\n        \/\/do something\n    }\n    xhr.send(fd);\x22 title=\x22\x22 data-original-title=\x22复制\x22\x3e\x3c\/span\x3e\n      \x3cspan type=\x22button\x22 class=\x22saveToNote code-tool\x22 data-toggle=\x22tooltip\x22 data-placement=\x22top\x22 title=\x22\x22 data-original-title=\x22放进笔记\x22\x3e\x3c\/span\x3e\n      \x3c\/div\x3e\n      \x3c\/div\x3e\x3cpre class=\x22javascript hljs\x22\x3e\x3ccode class=\x22javascript\x22\x3e    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e ndata = compress(img);\n    ndata = \x3cspan class=\x22hljs-built_in\x22\x3ewindow\x3c\/span\x3e.atob(ndata); \x3cspan class=\x22hljs-comment\x22\x3e\/\/将base64格式的数据进行解码\x3c\/span\x3e\n    \n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/新建一个buffer对象，用以存储图片数据\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e buffer = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e \x3cspan class=\x22hljs-built_in\x22\x3eUint8Array\x3c\/span\x3e(ndata.length);\n    \x3cspan class=\x22hljs-keyword\x22\x3efor\x3c\/span\x3e(\x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e i = \x3cspan class=\x22hljs-number\x22\x3e0\x3c\/span\x3e; i \x26lt; text.length; i\x2b\x2b) {\n        buffer[i] = ndata.charCodeAt(i);\n    }\n    \n    \x3cspan class=\x22hljs-comment\x22\x3e\/\/将buffer对象转化为Blob数据类型\x3c\/span\x3e\n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e blob = getBlob([buffer]);\n    \n    \x3cspan class=\x22hljs-keyword\x22\x3evar\x3c\/span\x3e fd = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e FormData(),\n        xhr = \x3cspan class=\x22hljs-keyword\x22\x3enew\x3c\/span\x3e XMLHttpRequest();\n    fd.append(\x3cspan class=\x22hljs-string\x22\x3e\x27file\x27\x3c\/span\x3e, blob);\n    \n    xhr.open(\x3cspan class=\x22hljs-string\x22\x3e\x27post\x27\x3c\/span\x3e, url);\n    xhr.onreadystatechange = \x3cspan class=\x22hljs-function\x22\x3e\x3cspan class=\x22hljs-keyword\x22\x3efunction\x3c\/span\x3e(\x3cspan class=\x22hljs-params\x22\x3e\x3c\/span\x3e) \x3c\/span\x3e{\n        \x3cspan class=\x22hljs-comment\x22\x3e\/\/do something\x3c\/span\x3e\n    }\n    xhr.send(fd);\x3c\/code\x3e\x3c\/pre\x3e\n\x3cp\x3e在新建\x3ccode\x3eBlob对象\x3c\/code\x3e中有需要进行兼容性的处理，特别是对于不支持\x3ccode\x3eFormData\x3c\/code\x3e上传\x3ccode\x3eblob\x3c\/code\x3e的andriod机的兼容性处理。\x3ca href=\x22https:\/\/github.com\/gokercebeci\/canvasResize\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e具体的方法请戳我\x3c\/a\x3e\x3cbr\x3e主要实现的细节是通过重写HTTP请求。\x3c\/p\x3e\n\x3chr\x3e\n\x3ch2 id=\x22articleHeader0\x22\x3e2月19日更新\x3c\/h2\x3e\n\x3cp\x3e在安卓机器中，部分\x3ccode\x3e4.x\x3c\/code\x3e的机型, 在\x3ccode\x3ewebview\x3c\/code\x3e里面对\x3ccode\x3efile\x3c\/code\x3e对象进行了阉割，比如你拿不到\x3ccode\x3efile.type\x3c\/code\x3e的值。\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader1\x22\x3e2月22日更新\x3c\/h2\x3e\n\x3cp\x3e\x3ccode\x3eAndroid4.4\x3c\/code\x3e下\x3ccode\x3e\x26lt;input type=\x22file\x22\x26gt;\x3c\/code\x3e由于系统\x3ccode\x3eWebView\x3c\/code\x3e的\x3ccode\x3eopenFileChooser\x3c\/code\x3e接口更改，导致无法选择文件，从而导致无法上传文件. \x3ca href=\x22https:\/\/code.google.com\/p\/android\/issues\/detail?id=62220\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3ebug描述请戳我\x3c\/a\x3e\x3c\/p\x3e\n\x3ch2 id=\x22articleHeader2\x22\x3e\x3ca href=\x22https:\/\/github.com\/CommanderXL\/imgResize\x22 rel=\x22nofollow noreferrer\x22 target=\x22_blank\x22\x3e封装好的github库，请戳我，如果觉得文章不错，请不要吝啬你的star~~\x3c\/a\x3e\x3c\/h2\x3e\n\n                \n"
            html = html.replace(/"{/g, "{")
            html = html.replace(/{"/g, "{")
            html = html.replace(/"}/g, "}")
            html = html.replace(/}"/g, "}")
            $('#raw').html(html);

            let postTitle =  $('.posttitle').text()
            let postContentTitle =  $('#raw > h1').text()
            if(postTitle === postContentTitle){
                $('#raw > h1').hide()
            }
            $('button.preview').hide()
        })</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>移动端H5图片上传的那些坑</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000006140042">https://segmentfault.com/a/1190000006140042</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/q1asu08u6b/" target="_blank">https://alili.tech/archive/q1asu08u6b/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({
        el: '.blog-post-comments', 
        app_id: 'ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz', 
        app_key: 'hLhtmd4tT0qJbyO2SgQ8odya', 
        placeholder: '说点什么?', 
        avatar:'robohash',
        notify:true,
        verify:true
    });</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/5ed53lrrg7e/">如何禁止浏览器自动填充<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/gij1sdp355j/">实践是检验程序员的唯一标准02：用户不想跟你说话并向你扔出一张图片 - 图片上传组件开发【开发篇】<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/y9eqaypgij/">123<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/4ho25kya1mg/">2018你成长了么？一份给你的前端技术清单<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/g2lx7wrrhy4/">Apache、Nginx 与 Node.js 之争 —— WordPress 与 Ghost 的性能大对决<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/dfejr0q89no/">CSS单位em是相对于父元素还是当前元素的字体大小？<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/cik25m3bh7m/">ES6 系列之 Babel 将 Generator 编译成了什么样子<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/vwkme203i7/">ES6 系列之异步处理实战<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/q2at4ffqrr/">Hola～ 一款基于Electron的聊天软件<aside class="dates">2019-02-15</aside></a></li><li><a href="/archive/t2mci6htsdn/">JavaScript 数组操作方法小结<aside class="dates">2019-02-15</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2019 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>(function(){
  if(location.host!=='alili.tech')return;
  var ga = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';       
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(ga, s);
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129382678-1');
})()</script><script>(function(){
    if(location.host!=='alili.tech')return;
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker
              .register('/sw.js')
              .then(registration => {
                  console.log('SW registered: ', registration);
              })
              .catch(registrationError => {
                  console.log('SW registration failed: ', registrationError);
              });
      });
  }</script></body></html>